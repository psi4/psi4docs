
<!DOCTYPE html>


<html lang="en" >

  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" /><meta name="viewport" content="width=device-width, initial-scale=1" />

    <title>Ways to Add Code: Psi4NumPy, Plugins, Full Integration</title>
  
  
  
  <script data-cfasync="false">
    document.documentElement.dataset.mode = localStorage.getItem("mode") || "";
    document.documentElement.dataset.theme = localStorage.getItem("theme") || "light";
  </script>
  
  <!-- Loaded before other Sphinx assets -->
  <link href="_static/styles/theme.css?digest=ac02cc09edc035673794" rel="stylesheet" />
<link href="_static/styles/bootstrap.css?digest=ac02cc09edc035673794" rel="stylesheet" />
<link href="_static/styles/pydata-sphinx-theme.css?digest=ac02cc09edc035673794" rel="stylesheet" />

  
  <link href="_static/vendor/fontawesome/6.1.2/css/all.min.css?digest=ac02cc09edc035673794" rel="stylesheet" />
  <link rel="preload" as="font" type="font/woff2" crossorigin href="_static/vendor/fontawesome/6.1.2/webfonts/fa-solid-900.woff2" />
<link rel="preload" as="font" type="font/woff2" crossorigin href="_static/vendor/fontawesome/6.1.2/webfonts/fa-brands-400.woff2" />
<link rel="preload" as="font" type="font/woff2" crossorigin href="_static/vendor/fontawesome/6.1.2/webfonts/fa-regular-400.woff2" />

    <link rel="stylesheet" type="text/css" href="_static/pygments.css?v=fa44fd50" />
    <link rel="stylesheet" type="text/css" href="_static/graphviz.css?v=eafc0fe6" />
    <link rel="stylesheet" type="text/css" href="_static/autodoc_pydantic.css?v=c7cf8c76" />
  
  <!-- Pre-loaded scripts that we'll load fully later -->
  <link rel="preload" as="script" href="_static/scripts/bootstrap.js?digest=ac02cc09edc035673794" />
<link rel="preload" as="script" href="_static/scripts/pydata-sphinx-theme.js?digest=ac02cc09edc035673794" />
  <script src="_static/vendor/fontawesome/6.1.2/js/all.min.js?digest=ac02cc09edc035673794"></script>

    <script src="_static/documentation_options.js?v=0a908d79"></script>
    <script src="_static/doctools.js?v=888ff710"></script>
    <script src="_static/sphinx_highlight.js?v=dc90522c"></script>
    <script crossorigin="anonymous" integrity="sha256-Ae2Vz/4ePdIu6ZyI/5ZGsYnb+m0JlOmKPjt6XZ9JJkA=" src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.4/require.min.js"></script>
    <script>window.MathJax = {"tex": {"inlineMath": [["$", "$"], ["\\(", "\\)"]], "processEscapes": true}, "options": {"ignoreHtmlClass": "tex2jax_ignore|mathjax_ignore|document", "processHtmlClass": "tex2jax_process|mathjax_process|math|output_area"}}</script>
    <script defer="defer" src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
    <script>DOCUMENTATION_OPTIONS.pagename = 'prog_ways_to_add';</script>
    <link rel="icon" href="_static/favicon-psi4.ico"/>
    <link rel="index" title="Index" href="genindex.html" />
    <link rel="search" title="Search" href="search.html" />
    <link rel="next" title="Creating New Plugins" href="plugins.html" />
    <link rel="prev" title="Adding New Code to PSI4" href="prog_newcode.html" />
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <meta name="docsearch:language" content="en"/>
    <meta name="docbuild:last-update" content="Tuesday, 26 September 2023 02:05AM"/>
  </head>
  
  
  <body data-bs-spy="scroll" data-bs-target=".bd-toc-nav" data-offset="180" data-bs-root-margin="0px 0px -60%" data-default-mode="">

  
  
  <a class="skip-link" href="#main-content">Skip to main content</a>
  
  <div id="pst-scroll-pixel-helper"></div>

  
  <button type="button" class="btn rounded-pill" id="pst-back-to-top">
    <i class="fa-solid fa-arrow-up"></i>
    Back to top
  </button>

  
  <input type="checkbox"
          class="sidebar-toggle"
          name="__primary"
          id="__primary"/>
  <label class="overlay overlay-primary" for="__primary"></label>
  
  <input type="checkbox"
          class="sidebar-toggle"
          name="__secondary"
          id="__secondary"/>
  <label class="overlay overlay-secondary" for="__secondary"></label>
  
  <div class="search-button__wrapper">
    <div class="search-button__overlay"></div>
    <div class="search-button__search-container">
<form class="bd-search d-flex align-items-center"
      action="search.html"
      method="get">
  <i class="fa-solid fa-magnifying-glass"></i>
  <input type="search"
         class="form-control"
         name="q"
         id="search-input"
         placeholder="Search the docs ..."
         aria-label="Search the docs ..."
         autocomplete="off"
         autocorrect="off"
         autocapitalize="off"
         spellcheck="false"/>
  <span class="search-button__kbd-shortcut"><kbd class="kbd-shortcut__modifier">Ctrl</kbd>+<kbd>K</kbd></span>
</form></div>
  </div>
  
    <nav class="bd-header navbar navbar-expand-lg bd-navbar">
<div class="bd-header__inner bd-page-width">
  <label class="sidebar-toggle primary-toggle" for="__primary">
    <span class="fa-solid fa-bars"></span>
  </label>
  
  
  <div class="col-lg-3 navbar-header-items__start">
    
      <div class="navbar-item">
  

<a class="navbar-brand logo" href="index.html">
  
  
  
  
    
    
      
    
    
    <img src="_static/psi4square.png" class="logo__image only-light" alt="Logo image"/>
    <script>document.write(`<img src="_static/psi4square.png" class="logo__image only-dark" alt="Logo image"/>`);</script>
  
  
</a></div>
    
  </div>
  
  <div class="col-lg-9 navbar-header-items">
    
    
    <div class="navbar-header-items__end">
      
        <div class="navbar-item navbar-persistent--container">
          
<script>
document.write(`
  <button class="btn btn-sm navbar-btn search-button search-button__button" title="Search" aria-label="Search" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <i class="fa-solid fa-magnifying-glass fa-lg"></i>
  </button>
`);
</script>
        </div>
      
      
    </div>
    
  </div>
  
  
    <div class="navbar-persistent--mobile">
<script>
document.write(`
  <button class="btn btn-sm navbar-btn search-button search-button__button" title="Search" aria-label="Search" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <i class="fa-solid fa-magnifying-glass fa-lg"></i>
  </button>
`);
</script>
    </div>
  

  
    <label class="sidebar-toggle secondary-toggle" for="__secondary" tabindex="0">
      <span class="fa-solid fa-outdent"></span>
    </label>
  
</div>

    </nav>
  
  <div class="bd-container">
    <div class="bd-container__inner bd-page-width">
      
      <div class="bd-sidebar-primary bd-sidebar">
        

  
  <div class="sidebar-header-items sidebar-primary__section">
    
    
    
    
  </div>
  
    <div class="sidebar-primary-items__start sidebar-primary__section">
        <div class="sidebar-primary-item">
  <div>
    <h3><a href="index.html">Table of Contents</a></h3>
    <ul>
<li><a class="reference internal" href="#">Ways to Add Code: Psi4NumPy, Plugins, Full Integration</a><ul>
<li><a class="reference internal" href="#easier-and-more-rapid-development">Easier and more rapid development</a></li>
<li><a class="reference internal" href="#rapid-initial-development-using-psi4numpy">Rapid initial development using Psi4NumPy</a></li>
<li><a class="reference internal" href="#avoiding-the-need-to-modify-psi4-using-plugins">Avoiding the need to modify Psi4, using plugins</a></li>
<li><a class="reference internal" href="#incorporating-code-into-psifour">Incorporating code into <span style="font-family: Optima, sans-serif; text-transform: none;">P<span style="font-size: 82%;">SI</span>4</span></a></li>
</ul>
</li>
</ul>

  </div></div>
        <div class="sidebar-primary-item">
  <div>
    <h4>Previous topic</h4>
    <p class="topless"><a href="prog_newcode.html"
                          title="previous chapter">Adding New Code to <span style="font-family: Optima, sans-serif; text-transform: none;">P<span style="font-size: 82%;">SI</span>4</span></a></p>
  </div>
  <div>
    <h4>Next topic</h4>
    <p class="topless"><a href="plugins.html"
                          title="next chapter">Creating New Plugins</a></p>
  </div></div>
        <div class="sidebar-primary-item">
  <div class="tocsection sourcelink">
    <a href="_sources/prog_ways_to_add.rst.txt">
      <i class="fa-solid fa-file-lines"></i> Show Source
    </a>
  </div>
</div>
        <div class="sidebar-primary-item">
<div id="searchbox"></div></div>
    </div>
  
  
  <div class="sidebar-primary-items__end sidebar-primary__section">
  </div>
  
  <div id="rtd-footer-container"></div>


      </div>
      
      <main id="main-content" class="bd-main">
        
        
          <div class="bd-content">
            <div class="bd-article-container">
              
              <div class="bd-header-article">
<div class="header-article-items header-article__inner">
  
    <div class="header-article-items__start">
      
        <div class="header-article-item">



<nav aria-label="Breadcrumb">
  <ul class="bd-breadcrumbs">
    
    <li class="breadcrumb-item breadcrumb-home">
      <a href="index.html" class="nav-link" aria-label="Home">
        <i class="fa-solid fa-home"></i>
      </a>
    </li>
    
    <li class="breadcrumb-item"><a href="prog_newcode.html" class="nav-link">Adding New Code to <span style="font-family: Optima, sans-serif; text-transform: none;">P<span style="font-size: 82%;">SI</span>4</span></a></li>
    
    <li class="breadcrumb-item active" aria-current="page">Ways to Add...</li>
  </ul>
</nav>
</div>
      
    </div>
  
  
</div>
</div>
              
              
              
                
<div id="searchbox"></div>
                <article class="bd-article" role="main">
                  
  <section id="ways-to-add-code-psi4numpy-plugins-full-integration">
<span id="sec-prog-ways-to-add"></span><h1>Ways to Add Code: Psi4NumPy, Plugins, Full Integration<a class="headerlink" href="#ways-to-add-code-psi4numpy-plugins-full-integration" title="Link to this heading">#</a></h1>
<section id="easier-and-more-rapid-development">
<h2>Easier and more rapid development<a class="headerlink" href="#easier-and-more-rapid-development" title="Link to this heading">#</a></h2>
<p>Fully-featured electronic structure programs are large and complex.  However,
the <span style="font-family: Optima, sans-serif; text-transform: none;">P<span style="font-size: 82%;">SI</span>4</span> ecosystem provides a path for easier and more rapid development
of new features.  The earliest versions of <span style="font-family: Optima, sans-serif; text-transform: none;">P<span style="font-size: 82%;">SI</span>4</span> were written by merging
individual executables that performed specific tasks into a unified C++
executable.  By linking this C++ executable against the Python interpreter, the
individual modules could be called in any sequence, enabling a very diverse
range of tasks to be accomplished within a given input.  Although Python-driven
model allowed for great flexibility from a user’s perspective, programming was
still relatively difficult because it required modifications to be made in C++
code.</p>
<p>Since those early days, the code has undergone some important structural
changes that have greatly simplified the development workflow.  These changes
were motivated by the realization that only a few bottlenecks exist in a typical
calculation; by focusing on optimized C++ implementations of these bottlenecks
and making these C++ functions available in Python, most of the code to implement
the overall calculation can be written in simpler Python code.  Python is far
better suited to management tasks such as directory navigation and retrieval,
making it a natural choice for overall calculation layout than C++.  With the
emergence of <a class="reference external" href="https://numpy.org/">NumPy</a> as a standard tool for executing almost any
mathematical technique efficiently in Python, the transitioning of code from
C++ to Python has facilitated a much simpler work flow for prototyping and
developing methods: this is detailed in the next section.</p>
</section>
<section id="rapid-initial-development-using-psi4numpy">
<span id="sec-prog-psi4numpy"></span><h2>Rapid initial development using Psi4NumPy<a class="headerlink" href="#rapid-initial-development-using-psi4numpy" title="Link to this heading">#</a></h2>
<p>The <a class="reference external" href="https://github.com/psi4/psi4numpy">Psi4NumPy</a> project <a class="reference internal" href="bibliography.html#smith-2018-3504" id="id1"><span>[Smith:2018:3504]</span></a> is the recommended
mechanism for developing and prototyping new methods in Psi4.  Because
<a class="reference external" href="https://numpy.org/">NumPy</a> provides such a rich set of features for efficient linear
algebra, Fourier transforms, and general tensor manipulations, a massive number
of methods can be easily implemented very easily using that library.  To
facilitate this workflow, <span style="font-family: Optima, sans-serif; text-transform: none;">P<span style="font-size: 82%;">SI</span>4</span> exports key quantities such as integrals,
densities and molecular orbitals in NumPy format.  From this point, the
programmer can simply call the appropriate <span style="font-family: Optima, sans-serif; text-transform: none;">P<span style="font-size: 82%;">SI</span>4</span> functions to compute the
desired input quantities, retrieve them in NumPy format, and then write the
remaining code using standard Python and/or NumPy syntax.  This approach does
not require any recompilation of code, resulting in a particularly facile
development workflow.  Detailed examples and tutorials are available in the
<a class="reference external" href="https://github.com/psi4/psi4numpy">Psi4NumPy</a> repository.</p>
</section>
<section id="avoiding-the-need-to-modify-psi4-using-plugins">
<span id="sec-prog-plugins"></span><h2>Avoiding the need to modify Psi4, using plugins<a class="headerlink" href="#avoiding-the-need-to-modify-psi4-using-plugins" title="Link to this heading">#</a></h2>
<p>In the early days when <span style="font-family: Optima, sans-serif; text-transform: none;">P<span style="font-size: 82%;">SI</span>4</span> was still primarily a C++ code, development
was very cumbersome due to a lengthy build process.  To expedite development, a
plugin system was developed.  This plugin machinery allows developers to access
the classes defined in the innards of <span style="font-family: Optima, sans-serif; text-transform: none;">P<span style="font-size: 82%;">SI</span>4</span>, with only the small plugin
code requiring recompilation during development.  The resulting lightweight
code can be maintained and distributed independently of <span style="font-family: Optima, sans-serif; text-transform: none;">P<span style="font-size: 82%;">SI</span>4</span>, making this
a good strategy for development, especially in cases where tighter integration
of the new code with existing <span style="font-family: Optima, sans-serif; text-transform: none;">P<span style="font-size: 82%;">SI</span>4</span> machinery is required than that
afforded by the Numpy based strategy outlined in the <a class="reference internal" href="#sec-prog-psi4numpy"><span class="std std-ref">Rapid initial development using Psi4NumPy</span></a>
section.  For details about how to write these plugins, see the
<a class="reference internal" href="plugins.html#sec-plugins"><span class="std std-ref">Creating New Plugins</span></a> section.</p>
</section>
<section id="incorporating-code-into-psifour">
<span id="sec-prog-fullintegration"></span><h2>Incorporating code into <span style="font-family: Optima, sans-serif; text-transform: none;">P<span style="font-size: 82%;">SI</span>4</span><a class="headerlink" href="#incorporating-code-into-psifour" title="Link to this heading">#</a></h2>
<p>For features to be incorporated fully into the <span style="font-family: Optima, sans-serif; text-transform: none;">P<span style="font-size: 82%;">SI</span>4</span> ecosystem, changes to
the core routines are inevitable.  However, the programmer should think very
carefully about the most appropriate language for the task in hand.  Let’s
consider a new feature that downloads some data from an external source and
then performs some kind of expensive matrix operation on those data.  Because
Python has a rich set of tools for obtaining data from external sources,
writing this tool in the Python layer is a natural choice.  If we know that the
matrix will always be small enough to fit in memory, we can simply rely on the
routines present in NumPy to do the heavy lifting and the code is easy to
implement entirely in the Python layer.  In the case where the matrix operation
is non-standard and requires some specialized code to handle disk-based
storage, the decision to write in Python is less clear cut.  It is certainly
possible to write these out-of-core routines using Numpy primitives, but there
are a number of tools in <span style="font-family: Optima, sans-serif; text-transform: none;">P<span style="font-size: 82%;">SI</span>4</span> already to perform tasks like these that are
required, <em>e.g.</em>, for cluster.  In this case, a good design would be to write a
simple piece of code in the C++ layer that performs the matrix operation on a
given input, using the I/O routines available in <span style="font-family: Optima, sans-serif; text-transform: none;">P<span style="font-size: 82%;">SI</span>4</span> and the parallelism
afforded by OpenMP, and to make that code available to the front end as
described in <a class="reference internal" href="prog_tour.html#sec-prog-tour-exposing"><span class="std std-ref">Exposing C++ code to Python</span></a>.  The Python layer could then be
responsible for obtaining the input data and calling this C++ code to do the
manipulations, allowing each language layer to handle the subset of the work
that caters to their individual strengths.</p>
<p>A number of concrete examples of this workflow exist in the code already.  For
finite difference computations of energy derivatives, the logic to determine
the type of stencil and which displacements are needed is not going to be rate
limiting for any reasonable quantum mechanical energy function.  Therefore,
doing that work in the Python layer is a good idea, as it allows the many
Python tools for farming out <em>embarrassingly parallel</em> workloads to be used,
while the C++ layer can be used to implement the energy function to be
differentiated.</p>
<p>In SCF, we have a number of sources of external embedding potentials that could
enter the calculation.  Allowing Python to handle only the details of driving
the SCF iterations, such as external potentials and convergence acceleration
methods, but deferring to C++ to do the heavy lifting for building and
diagonalizing the Fock matrix also takes advantage of the two languages’
strengths and improves maintainability of the code.</p>
</section>
</section>


                </article>
              
              
              
              
              
                <footer class="prev-next-footer">
                  <!-- Previous / next buttons -->
<div class="prev-next-area">
    <a class="left-prev"
       href="prog_newcode.html"
       title="previous page">
      <i class="fa-solid fa-angle-left"></i>
      <div class="prev-next-info">
        <p class="prev-next-subtitle">previous</p>
        <p class="prev-next-title">Adding New Code to <span style="font-family: Optima, sans-serif; text-transform: none;">P<span style="font-size: 82%;">SI</span>4</span></p>
      </div>
    </a>
    <a class="right-next"
       href="plugins.html"
       title="next page">
      <div class="prev-next-info">
        <p class="prev-next-subtitle">next</p>
        <p class="prev-next-title">Creating New Plugins</p>
      </div>
      <i class="fa-solid fa-angle-right"></i>
    </a>
</div>
                </footer>
              
            </div>
            
            
              
                <div class="bd-sidebar-secondary bd-toc"><div class="sidebar-secondary-items sidebar-secondary__inner">

  <div class="sidebar-secondary-item">
  <div class="page-toc tocsection onthispage">
    <i class="fa-solid fa-list"></i> On this page
  </div>
  <nav class="bd-toc-nav page-toc">
    <ul class="visible nav section-nav flex-column">
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#easier-and-more-rapid-development">Easier and more rapid development</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#rapid-initial-development-using-psi4numpy">Rapid initial development using Psi4NumPy</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#avoiding-the-need-to-modify-psi4-using-plugins">Avoiding the need to modify Psi4, using plugins</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#incorporating-code-into-psifour">Incorporating code into <span style="font-family: Optima, sans-serif; text-transform: none;">P<span style="font-size: 82%;">SI</span>4</span></a></li>
</ul>
  </nav></div>

  <div class="sidebar-secondary-item">
  <div class="tocsection sourcelink">
    <a href="_sources/prog_ways_to_add.rst.txt">
      <i class="fa-solid fa-file-lines"></i> Show Source
    </a>
  </div>
</div>

</div></div>
              
            
          </div>
          <footer class="bd-footer-content">
            
          </footer>
        
      </main>
    </div>
  </div>
  
  <!-- Scripts loaded after <body> so the DOM is not blocked -->
  <script src="_static/scripts/bootstrap.js?digest=ac02cc09edc035673794"></script>
<script src="_static/scripts/pydata-sphinx-theme.js?digest=ac02cc09edc035673794"></script>

  <footer class="bd-footer">
<div class="bd-footer__inner bd-page-width">
  
    <div class="footer-items__start">
      
        <div class="footer-item">
  <p class="copyright">
    
      © Copyright 2007-2023, The Psi4 Project.
      <br/>
    
  </p>
</div>
      
        <div class="footer-item">
  <p class="sphinx-version">
    Created using <a href="https://www.sphinx-doc.org/">Sphinx</a> 7.2.6.
    <br/>
  </p>
</div>
      
    </div>
  
  
  
    <div class="footer-items__end">
      
        <div class="footer-item"><p class="theme-version">
  Built with the <a href="https://pydata-sphinx-theme.readthedocs.io/en/stable/index.html">PyData Sphinx Theme</a> 0.14.1.
</p></div>
      
    </div>
  
</div>

  </footer>
  </body>
</html>