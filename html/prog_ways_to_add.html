<!-- 
#
# @BEGIN LICENSE
#
# Psi4: an open-source quantum chemistry software package
#
# Copyright (c) 2007-2017 The Psi4 Developers.
#
# The copyrights for code used from other parties are included in
# the corresponding files.
#
# This file is part of Psi4.
#
# Psi4 is free software; you can redistribute it and/or modify
# it under the terms of the GNU Lesser General Public License as published by
# the Free Software Foundation, version 3.
#
# Psi4 is distributed in the hope that it will be useful,
# but WITHOUT ANY WARRANTY; without even the implied warranty of
# MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
# GNU Lesser General Public License for more details.
#
# You should have received a copy of the GNU Lesser General Public License along
# with Psi4; if not, write to the Free Software Foundation, Inc.,
# 51 Franklin Street, Fifth Floor, Boston, MA 02110-1301 USA.
#
# @END LICENSE
# -->






<!DOCTYPE html>

<html>
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" /><meta name="generator" content="Docutils 0.17.1: http://docutils.sourceforge.net/" />

    <title>Ways to Add Code: Psi4NumPy, Plugins, Full Integration</title>
    <link rel="stylesheet" type="text/css" href="_static/pygments.css" />
    <link rel="stylesheet" type="text/css" href="_static/psi4.css" />
    <link rel="stylesheet" type="text/css" href="_static/graphviz.css" />
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/font-awesome/4.4.0/css/font-awesome.min.css" type="text/css" />
    <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Noticia+Text:400,i,b,bi|Open+Sans:400,i,b,bi|Roboto+Mono:400,i,b,bi&amp;display=swap" type="text/css" />
    
    <script data-url_root="./" id="documentation_options" src="_static/documentation_options.js"></script>
    <script src="_static/jquery.js"></script>
    <script src="_static/underscore.js"></script>
    <script src="_static/doctools.js"></script>
    <script crossorigin="anonymous" integrity="sha256-Ae2Vz/4ePdIu6ZyI/5ZGsYnb+m0JlOmKPjt6XZ9JJkA=" src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.4/require.min.js"></script>
    <script>window.MathJax = {"tex": {"inlineMath": [["$", "$"], ["\\(", "\\)"]], "processEscapes": true}, "options": {"ignoreHtmlClass": "tex2jax_ignore|mathjax_ignore|document", "processHtmlClass": "tex2jax_process|mathjax_process|math|output_area"}}</script>
    <script defer="defer" src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>

    
    
     
        <script src="_static/jquery.cookie.js"></script>
    

    
     
        <script src="_static/cloud.base.js"></script>
    

    
     
        <script src="_static/cloud.js"></script>
    

    <link rel="shortcut icon" href="_static/favicon-psi4.ico"/>
    <link rel="index" title="Index" href="genindex.html" />
    <link rel="search" title="Search" href="search.html" />
    <link rel="next" title="Creating New Plugins" href="plugins.html" />
    <link rel="prev" title="Adding New Code to PSI4" href="prog_newcode.html" /> 
        <meta name="viewport" content="width=device-width, initial-scale=1">
  </head><body>
    <div class="relbar-top">
        
    <div class="related" role="navigation" aria-label="related navigation">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="genindex.html" title="General Index"
             accesskey="I">Index</a></li>
        <li class="right" >
          <a href="py-modindex.html" title="Python Module Index"
             >modules</a> &nbsp; &nbsp;</li>
        <li class="right" >
          <a href="plugins.html" title="Creating New Plugins"
             accesskey="N"><i class="fa fa-long-arrow-right fa-lg"></i></a> &nbsp; &nbsp;</li>
        <li class="right" >
          <a href="prog_newcode.html" title="Adding New Code to PSI4"
             accesskey="P"><i class="fa fa-long-arrow-left fa-lg"></i></a> &nbsp; &nbsp;</li>
        <li class="right" >
          <a href="index.html" title="Table Of Contents"
             accesskey="C"><i class="fa fa-book fa-lg"></i></a> &nbsp; &nbsp;</li>
    <li><a href="http://psicode.org/"><i class="fa fa-home fa-lg"></i></a></li>
    <li><a href="http://github.com/psi4/psi4"><i class="fa fa-github fa-lg"></i></a></li>
    <li><a href="http://forum.psicode.org"><i class="fa fa-comments-o fa-lg"></i></a></li>
    <li><a href="http://github.com/psi4/psi4/edit/master/doc/sphinxman/source/prog_ways_to_add.rst"><i class="fa fa-pencil fa-lg"></i></a></li>
    <li style="color: #1a4162">&nbsp;&middot;&nbsp;</li>
    <li><a href="http://github.com/psi4/psi4/tree/4dc7bbf">1.6a1.dev112</a></li>
    <li style="color: #1a4162">&nbsp;&middot;&nbsp;</li>
    <li class="nav-item nav-item-0"><a href="index.html">
        <span style="font-family: Optima, sans-serif;">P<span style="font-size: 82%;">SI</span>4</span>
        </a><i class="fa fa-angle-double-right" style="color: #a2a7b3; text-shadow: none;"></i></li>

          <li class="nav-item nav-item-1"><a href="prog_newcode.html" accesskey="U">Adding New Code to <span style="font-family: Optima, sans-serif; text-transform: none;">P<span style="font-size: 82%;">SI</span>4</span></a><i class="fa fa-angle-double-right" style="color: #a2a7b3; text-shadow: none;"></i></li>
        <li class="nav-item nav-item-this"><a href="">Ways to Add Code: Psi4NumPy, Plugins, Full Integration</a></li> 
      </ul>
    </div>
    </div>
  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body" role="main">
            
  <section id="ways-to-add-code-psi4numpy-plugins-full-integration">
<span id="sec-prog-ways-to-add"></span><h1>Ways to Add Code: Psi4NumPy, Plugins, Full Integration<a class="headerlink" href="#ways-to-add-code-psi4numpy-plugins-full-integration" title="Permalink to this headline">¶</a></h1>
<section id="easier-and-more-rapid-development">
<h2>Easier and more rapid development<a class="headerlink" href="#easier-and-more-rapid-development" title="Permalink to this headline">¶</a></h2>
<p>Fully-featured electronic structure programs are large and complex.  However,
the <span style="font-family: Optima, sans-serif; text-transform: none;">P<span style="font-size: 82%;">SI</span>4</span> ecosystem provides a path for easier and more rapid development
of new features.  The earliest versions of <span style="font-family: Optima, sans-serif; text-transform: none;">P<span style="font-size: 82%;">SI</span>4</span> were written by merging
individual executables that performed specific tasks into a unified C++
executable.  By linking this C++ executable against the Python interpreter, the
individual modules could be called in any sequence, enabling a very diverse
range of tasks to be accomplished within a given input.  Although Python-driven
model allowed for great flexibility from a user’s perspective, programming was
still relatively difficult because it required modifications to be made in C++
code.</p>
<p>Since those early days, the code has undergone some important structural
changes that have greatly simplified the development workflow.  These changes
were motivated by the realization that only a few bottlenecks exist in a typical
calculation; by focusing on optimized C++ implementations of these bottlenecks
and making these C++ functions available in Python, most of the code to implement
the overall calculation can be written in simpler Python code.  Python is far
better suited to management tasks such as directory navigation and retrieval,
making it a natural choice for overall calculation layout than C++.  With the
emergence of <a class="reference external" href="https://numpy.org/">NumPy</a> as a standard tool for executing almost any
mathematical technique efficiently in Python, the transitioning of code from
C++ to Python has facilitated a much simpler work flow for prototyping and
developing methods: this is detailed in the next section.</p>
</section>
<section id="rapid-initial-development-using-psi4numpy">
<span id="sec-prog-psi4numpy"></span><h2>Rapid initial development using Psi4NumPy<a class="headerlink" href="#rapid-initial-development-using-psi4numpy" title="Permalink to this headline">¶</a></h2>
<p>The <a class="reference external" href="https://github.com/psi4/psi4numpy">Psi4NumPy</a> project <a class="reference internal" href="bibliography.html#smith-2018-3504" id="id1"><span>[Smith:2018:3504]</span></a> is the recommended
mechanism for developing and prototyping new methods in Psi4.  Because
<a class="reference external" href="https://numpy.org/">NumPy</a> provides such a rich set of features for efficient linear
algebra, Fourier transforms, and general tensor manipulations, a massive number
of methods can be easily implemented very easily using that library.  To
facilitate this workflow, <span style="font-family: Optima, sans-serif; text-transform: none;">P<span style="font-size: 82%;">SI</span>4</span> exports key quantities such as integrals,
densities and molecular orbitals in NumPy format.  From this point, the
programmer can simply call the appropriate <span style="font-family: Optima, sans-serif; text-transform: none;">P<span style="font-size: 82%;">SI</span>4</span> functions to compute the
desired input quantities, retrieve them in NumPy format, and then write the
remaining code using standard Python and/or NumPy syntax.  This approach does
not require any recompilation of code, resulting in a particularly facile
development workflow.  Detailed examples and tutorials are available in the
<a class="reference external" href="https://github.com/psi4/psi4numpy">Psi4NumPy</a> repository.</p>
</section>
<section id="avoiding-the-need-to-modify-psi4-using-plugins">
<span id="sec-prog-plugins"></span><h2>Avoiding the need to modify Psi4, using plugins<a class="headerlink" href="#avoiding-the-need-to-modify-psi4-using-plugins" title="Permalink to this headline">¶</a></h2>
<p>In the early days when <span style="font-family: Optima, sans-serif; text-transform: none;">P<span style="font-size: 82%;">SI</span>4</span> was still primarily a C++ code, development
was very cumbersome due to a lengthy build process.  To expedite development, a
plugin system was developed.  This plugin machinery allows developers to access
the classes defined in the innards of <span style="font-family: Optima, sans-serif; text-transform: none;">P<span style="font-size: 82%;">SI</span>4</span>, with only the small plugin
code requiring recompilation during development.  The resulting lightweight
code can be maintained and distributed independently of <span style="font-family: Optima, sans-serif; text-transform: none;">P<span style="font-size: 82%;">SI</span>4</span>, making this
a good strategy for development, especially in cases where tighter integration
of the new code with existing <span style="font-family: Optima, sans-serif; text-transform: none;">P<span style="font-size: 82%;">SI</span>4</span> machinery is required than that
afforded by the Numpy based strategy outlined in the <a class="reference internal" href="#sec-prog-psi4numpy"><span class="std std-ref">Rapid initial development using Psi4NumPy</span></a>
section.  For details about how to write these plugins, see the
<a class="reference internal" href="plugins.html#sec-plugins"><span class="std std-ref">Creating New Plugins</span></a> section.</p>
</section>
<section id="incorporating-code-into-psifour">
<span id="sec-prog-fullintegration"></span><h2>Incorporating code into <span style="font-family: Optima, sans-serif; text-transform: none;">P<span style="font-size: 82%;">SI</span>4</span><a class="headerlink" href="#incorporating-code-into-psifour" title="Permalink to this headline">¶</a></h2>
<p>For features to be incorporated fully into the <span style="font-family: Optima, sans-serif; text-transform: none;">P<span style="font-size: 82%;">SI</span>4</span> ecosystem, changes to
the core routines are inevitable.  However, the programmer should think very
carefully about the most appropriate language for the task in hand.  Let’s
consider a new feature that downloads some data from an external source and
then performs some kind of expensive matrix operation on those data.  Because
Python has a rich set of tools for obtaining data from external sources,
writing this tool in the Python layer is a natural choice.  If we know that the
matrix will always be small enough to fit in memory, we can simply rely on the
routines present in NumPy to do the heavy lifting and the code is easy to
implement entirely in the Python layer.  In the case where the matrix operation
is non-standard and requires some specialized code to handle disk-based
storage, the decision to write in Python is less clear cut.  It is certainly
possible to write these out-of-core routines using Numpy primitives, but there
are a number of tools in <span style="font-family: Optima, sans-serif; text-transform: none;">P<span style="font-size: 82%;">SI</span>4</span> already to perform tasks like these that are
required, <em>e.g.</em>, for cluster.  In this case, a good design would be to write a
simple piece of code in the C++ layer that performs the matrix operation on a
given input, using the I/O routines available in <span style="font-family: Optima, sans-serif; text-transform: none;">P<span style="font-size: 82%;">SI</span>4</span> and the parallelism
afforded by OpenMP, and to make that code available to the front end as
described in <a class="reference internal" href="prog_tour.html#sec-prog-tour-exposing"><span class="std std-ref">Exposing C++ code to Python</span></a>.  The Python layer could then be
responsible for obtaining the input data and calling this C++ code to do the
manipulations, allowing each language layer to handle the subset of the work
that caters to their individual strengths.</p>
<p>A number of concrete examples of this workflow exist in the code already.  For
finite difference computations of energy derivatives, the logic to determine
the type of stencil and which displacements are needed is not going to be rate
limiting for any reasonable quantum mechanical energy function.  Therefore,
doing that work in the Python layer is a good idea, as it allows the many
Python tools for farming out <em>embarrassingly parallel</em> workloads to be used,
while the C++ layer can be used to implement the energy function to be
differentiated.</p>
<p>In SCF, we have a number of sources of external embedding potentials that could
enter the calculation.  Allowing Python to handle only the details of driving
the SCF iterations, such as external potentials and convergence acceleration
methods, but deferring to C++ to do the heavy lifting for building and
diagonalizing the Fock matrix also takes advantage of the two languages’
strengths and improves maintainability of the code.</p>
</section>
</section>


            <div class="clearer"></div>
          </div>
        </div>
      </div>
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper">
        <p class="logo"><a href="index.html" title="index">
          <img class="logo" src="_static/psi4square.png" alt="Logo"/>
        </a></p><!-- 
#
# @BEGIN LICENSE
#
# Psi4: an open-source quantum chemistry software package
#
# Copyright (c) 2007-2017 The Psi4 Developers.
#
# The copyrights for code used from other parties are included in
# the corresponding files.
#
# This file is part of Psi4.
#
# Psi4 is free software; you can redistribute it and/or modify
# it under the terms of the GNU Lesser General Public License as published by
# the Free Software Foundation, version 3.
#
# Psi4 is distributed in the hope that it will be useful,
# but WITHOUT ANY WARRANTY; without even the implied warranty of
# MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
# GNU Lesser General Public License for more details.
#
# You should have received a copy of the GNU Lesser General Public License along
# with Psi4; if not, write to the Free Software Foundation, Inc.,
# 51 Franklin Street, Fifth Floor, Boston, MA 02110-1301 USA.
#
# @END LICENSE
# -->


<div id="searchbox" style="display: none" role="search">
  <!--<h3>Quick search</h3>-->
    <form class="search" action="search.html" method="get">
      <!--<div><input type="text" name="q" placeholder="search docs" /></div>-->
      <div><input type="text" name="q" placeholder="&#xF002;" style="font-family:FontAwesome, Ariel" /></div>
      <!--<div><input type="submit" value="Go" /></div>-->
      <input type="hidden" name="check_keywords" value="yes" />
      <input type="hidden" name="area" value="default" />
    </form>
</div>
<script type="text/javascript">$('#searchbox').show(0);</script><div class="sphinx-toc sphinxlocaltoc">
    <h3><a href="index.html">table of contents</a></h3>
    <ul>
<li><a class="reference internal" href="#">Ways to Add Code: Psi4NumPy, Plugins, Full Integration</a><ul>
<li><a class="reference internal" href="#easier-and-more-rapid-development">Easier and more rapid development</a></li>
<li><a class="reference internal" href="#rapid-initial-development-using-psi4numpy">Rapid initial development using Psi4NumPy</a></li>
<li><a class="reference internal" href="#avoiding-the-need-to-modify-psi4-using-plugins">Avoiding the need to modify Psi4, using plugins</a></li>
<li><a class="reference internal" href="#incorporating-code-into-psifour">Incorporating code into <span style="font-family: Optima, sans-serif; text-transform: none;">P<span style="font-size: 82%;">SI</span>4</span></a></li>
</ul>
</li>
</ul>

  </div>
        </div>
      </div>
    
    
        <div class="sidebar-toggle-group no-js">
            
            <button class="sidebar-toggle" id="sidebar-hide" title="Hide the sidebar menu">
                 «
                <span class="show-for-small">hide menu</span>
                
            </button>
            <button class="sidebar-toggle" id="sidebar-show" title="Show the sidebar menu">
                
                <span class="show-for-small">menu</span>
                <span class="hide-for-small">sidebar</span>
                 »
            </button>
        </div>
    
      <div class="clearer"></div>
    </div>
    <div class="relbar-bottom">
        
    <div class="related" role="navigation" aria-label="related navigation">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="genindex.html" title="General Index"
             >Index</a></li>
        <li class="right" >
          <a href="py-modindex.html" title="Python Module Index"
             >modules</a> &nbsp; &nbsp;</li>
        <li class="right" >
          <a href="plugins.html" title="Creating New Plugins"
             ><i class="fa fa-long-arrow-right fa-lg"></i></a> &nbsp; &nbsp;</li>
        <li class="right" >
          <a href="prog_newcode.html" title="Adding New Code to PSI4"
             ><i class="fa fa-long-arrow-left fa-lg"></i></a> &nbsp; &nbsp;</li>
        <li class="right" >
          <a href="index.html" title="Table Of Contents"
             ><i class="fa fa-book fa-lg"></i></a> &nbsp; &nbsp;</li>
    <li><a href="http://psicode.org/"><i class="fa fa-home fa-lg"></i></a></li>
    <li><a href="http://github.com/psi4/psi4"><i class="fa fa-github fa-lg"></i></a></li>
    <li><a href="http://forum.psicode.org"><i class="fa fa-comments-o fa-lg"></i></a></li>
    <li><a href="http://github.com/psi4/psi4/edit/master/doc/sphinxman/source/prog_ways_to_add.rst"><i class="fa fa-pencil fa-lg"></i></a></li>
    <li style="color: #1a4162">&nbsp;&middot;&nbsp;</li>
    <li><a href="http://github.com/psi4/psi4/tree/4dc7bbf">1.6a1.dev112</a></li>
    <li style="color: #1a4162">&nbsp;&middot;&nbsp;</li>
    <li class="nav-item nav-item-0"><a href="index.html">
        <span style="font-family: Optima, sans-serif;">P<span style="font-size: 82%;">SI</span>4</span>
        </a><i class="fa fa-angle-double-right" style="color: #a2a7b3; text-shadow: none;"></i></li>

          <li class="nav-item nav-item-1"><a href="prog_newcode.html" >Adding New Code to <span style="font-family: Optima, sans-serif; text-transform: none;">P<span style="font-size: 82%;">SI</span>4</span></a><i class="fa fa-angle-double-right" style="color: #a2a7b3; text-shadow: none;"></i></li>
        <li class="nav-item nav-item-this"><a href="">Ways to Add Code: Psi4NumPy, Plugins, Full Integration</a></li> 
      </ul>
    </div>
    </div>

    <div class="footer" role="contentinfo">
        &#169; Copyright 2022, The Psi4 Project.
      Last updated on Sunday, 27 March 2022 03:28AM.
      Created using <a href="https://www.sphinx-doc.org/">Sphinx</a> 4.4.0.
    </div>
    <!-- cloud_sptheme 1.4 -->
  </body>
</html>