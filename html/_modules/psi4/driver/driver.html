<!-- 
#
# @BEGIN LICENSE
#
# Psi4: an open-source quantum chemistry software package
#
# Copyright (c) 2007-2017 The Psi4 Developers.
#
# The copyrights for code used from other parties are included in
# the corresponding files.
#
# This file is part of Psi4.
#
# Psi4 is free software; you can redistribute it and/or modify
# it under the terms of the GNU Lesser General Public License as published by
# the Free Software Foundation, version 3.
#
# Psi4 is distributed in the hope that it will be useful,
# but WITHOUT ANY WARRANTY; without even the implied warranty of
# MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
# GNU Lesser General Public License for more details.
#
# You should have received a copy of the GNU Lesser General Public License along
# with Psi4; if not, write to the Free Software Foundation, Inc.,
# 51 Franklin Street, Fifth Floor, Boston, MA 02110-1301 USA.
#
# @END LICENSE
# -->





<!DOCTYPE html>

<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>psi4.driver.driver</title>
    <link rel="stylesheet" type="text/css" href="../../../_static/pygments.css?v=fa44fd50" />
    <link rel="stylesheet" type="text/css" href="../../../_static/psi4.css?v=5cda37dd" />
    <link rel="stylesheet" type="text/css" href="../../../_static/graphviz.css?v=eafc0fe6" />
    <link rel="stylesheet" type="text/css" href="../../../_static/autodoc_pydantic.css" />
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/font-awesome/4.4.0/css/font-awesome.min.css" type="text/css" />
    <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Noticia+Text:400,i,b,bi|Open+Sans:400,i,b,bi|Roboto+Mono:400,i,b,bi&amp;display=swap" type="text/css" />
    
    <script data-url_root="../../../" id="documentation_options" src="../../../_static/documentation_options.js?v=acca935e"></script>
    <script src="../../../_static/doctools.js?v=888ff710"></script>
    <script src="../../../_static/sphinx_highlight.js?v=4825356b"></script>
    <script crossorigin="anonymous" integrity="sha256-Ae2Vz/4ePdIu6ZyI/5ZGsYnb+m0JlOmKPjt6XZ9JJkA=" src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.4/require.min.js"></script>

    
    
     
        <script src="../../../_static/jquery.cookie.js"></script>
    

    
     
        <script src="../../../_static/cloud.base.js"></script>
    

    
     
        <script src="../../../_static/cloud.js"></script>
    

    <link rel="icon" href="../../../_static/favicon-psi4.ico"/>
    <link rel="index" title="Index" href="../../../genindex.html" />
    <link rel="search" title="Search" href="../../../search.html" /> 
        <meta name="viewport" content="width=device-width, initial-scale=1">
  </head><body>
    <div class="relbar-top">
        
    <div class="related" role="navigation" aria-label="related navigation">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../../../genindex.html" title="General Index"
             accesskey="I">Index</a></li>
        <li class="right" >
          <a href="../../../py-modindex.html" title="Python Module Index"
             >modules</a> &nbsp; &nbsp;</li>
        <li class="right" >
          <a href="../../../index.html" title="Table Of Contents"
             accesskey="C"><i class="fa fa-book fa-lg"></i></a> &nbsp; &nbsp;</li>
    <li><a href="http://psicode.org/"><i class="fa fa-home fa-lg"></i></a></li>
    <li><a href="http://github.com/psi4/psi4"><i class="fa fa-github fa-lg"></i></a></li>
    <li><a href="http://forum.psicode.org"><i class="fa fa-comments-o fa-lg"></i></a></li>
    <li><a href="http://github.com/psi4/psi4/edit/master/doc/sphinxman/source/_modules/psi4/driver/driver.rst"><i class="fa fa-pencil fa-lg"></i></a></li>
    <li style="color: #1a4162">&nbsp;&middot;&nbsp;</li>
    <li><a href="http://github.com/psi4/psi4/tree/b0e621f">1.9a1.dev35</a></li>
    <li style="color: #1a4162">&nbsp;&middot;&nbsp;</li>
    <li class="nav-item nav-item-0"><a href="../../../index.html">
        <span style="font-family: Optima, sans-serif;">P<span style="font-size: 82%;">SI</span>4</span>
        </a><i class="fa fa-angle-double-right" style="color: #a2a7b3; text-shadow: none;"></i></li>

          <li class="nav-item nav-item-1"><a href="../../index.html" accesskey="U">Module code</a><i class="fa fa-angle-double-right" style="color: #a2a7b3; text-shadow: none;"></i></li>
        <li class="nav-item nav-item-this"><a href="">psi4.driver.driver</a></li> 
      </ul>
    </div>
    </div>
  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body" role="main">
            
  <h1>Source code for psi4.driver.driver</h1><div class="highlight"><pre>
<span></span><span class="c1">#</span>
<span class="c1"># @BEGIN LICENSE</span>
<span class="c1">#</span>
<span class="c1"># Psi4: an open-source quantum chemistry software package</span>
<span class="c1">#</span>
<span class="c1"># Copyright (c) 2007-2023 The Psi4 Developers.</span>
<span class="c1">#</span>
<span class="c1"># The copyrights for code used from other parties are included in</span>
<span class="c1"># the corresponding files.</span>
<span class="c1">#</span>
<span class="c1"># This file is part of Psi4.</span>
<span class="c1">#</span>
<span class="c1"># Psi4 is free software; you can redistribute it and/or modify</span>
<span class="c1"># it under the terms of the GNU Lesser General Public License as published by</span>
<span class="c1"># the Free Software Foundation, version 3.</span>
<span class="c1">#</span>
<span class="c1"># Psi4 is distributed in the hope that it will be useful,</span>
<span class="c1"># but WITHOUT ANY WARRANTY; without even the implied warranty of</span>
<span class="c1"># MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the</span>
<span class="c1"># GNU Lesser General Public License for more details.</span>
<span class="c1">#</span>
<span class="c1"># You should have received a copy of the GNU Lesser General Public License along</span>
<span class="c1"># with Psi4; if not, write to the Free Software Foundation, Inc.,</span>
<span class="c1"># 51 Franklin Street, Fifth Floor, Boston, MA 02110-1301 USA.</span>
<span class="c1">#</span>
<span class="c1"># @END LICENSE</span>
<span class="c1">#</span>
<span class="sd">&quot;&quot;&quot;</span>
<span class="sd">Nexus of psi4.driver module with primary user-facing functions, including</span>
<span class="sd">single-point energies, geometry optimizations, properties, and vibrational</span>
<span class="sd">frequency calculations.</span>

<span class="sd">&quot;&quot;&quot;</span>
<span class="kn">import</span> <span class="nn">json</span>
<span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">re</span>
<span class="kn">import</span> <span class="nn">copy</span>
<span class="kn">import</span> <span class="nn">shutil</span>
<span class="kn">import</span> <span class="nn">sys</span>
<span class="kn">import</span> <span class="nn">logging</span>
<span class="kn">from</span> <span class="nn">typing</span> <span class="kn">import</span> <span class="n">Dict</span><span class="p">,</span> <span class="n">Optional</span><span class="p">,</span> <span class="n">Union</span>
<span class="kn">import</span> <span class="nn">logging</span>

<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>

<span class="kn">from</span> <span class="nn">psi4</span> <span class="kn">import</span> <span class="n">core</span>  <span class="c1"># for typing</span>
<span class="kn">from</span> <span class="nn">psi4.driver</span> <span class="kn">import</span> <span class="n">driver_util</span>
<span class="kn">from</span> <span class="nn">psi4.driver</span> <span class="kn">import</span> <span class="n">driver_cbs</span>
<span class="kn">from</span> <span class="nn">psi4.driver</span> <span class="kn">import</span> <span class="n">driver_nbody</span>
<span class="kn">from</span> <span class="nn">psi4.driver</span> <span class="kn">import</span> <span class="n">driver_findif</span>
<span class="kn">from</span> <span class="nn">psi4.driver</span> <span class="kn">import</span> <span class="n">task_planner</span>
<span class="kn">from</span> <span class="nn">psi4.driver</span> <span class="kn">import</span> <span class="n">p4util</span>
<span class="kn">from</span> <span class="nn">psi4.driver</span> <span class="kn">import</span> <span class="n">qcdb</span>
<span class="kn">from</span> <span class="nn">psi4.driver</span> <span class="kn">import</span> <span class="n">pp</span><span class="p">,</span> <span class="n">nppp</span><span class="p">,</span> <span class="n">nppp10</span>
<span class="kn">from</span> <span class="nn">psi4.driver.p4util.exceptions</span> <span class="kn">import</span> <span class="o">*</span>
<span class="kn">from</span> <span class="nn">psi4.driver.procrouting</span> <span class="kn">import</span> <span class="o">*</span>
<span class="kn">from</span> <span class="nn">psi4.driver.mdi_engine</span> <span class="kn">import</span> <span class="n">mdi_run</span>
<span class="kn">from</span> <span class="nn">psi4.driver.task_base</span> <span class="kn">import</span> <span class="n">AtomicComputer</span>

<span class="c1"># never import wrappers or aliases into this file</span>

<span class="n">logger</span> <span class="o">=</span> <span class="n">logging</span><span class="o">.</span><span class="n">getLogger</span><span class="p">(</span><span class="vm">__name__</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">_energy_is_invariant</span><span class="p">(</span><span class="n">gradient_rms</span><span class="p">,</span> <span class="n">stationary_criterion</span><span class="o">=</span><span class="mf">1.e-2</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Polls options and probes `gradient` to return whether current method</span>
<span class="sd">    and system expected to be invariant to translations and rotations of</span>
<span class="sd">    the coordinate system.</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">stationary_point</span> <span class="o">=</span> <span class="n">gradient_rms</span> <span class="o">&lt;</span> <span class="n">stationary_criterion</span>  <span class="c1"># 1.e-2 pulled out of a hat</span>

    <span class="n">mol</span> <span class="o">=</span> <span class="n">core</span><span class="o">.</span><span class="n">get_active_molecule</span><span class="p">()</span>
    <span class="n">efp_present</span> <span class="o">=</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">mol</span><span class="p">,</span> <span class="s1">&#39;EFP&#39;</span><span class="p">)</span>

    <span class="n">translations_projection_sound</span> <span class="o">=</span> <span class="p">(</span><span class="ow">not</span> <span class="n">core</span><span class="o">.</span><span class="n">get_option</span><span class="p">(</span><span class="s1">&#39;SCF&#39;</span><span class="p">,</span> <span class="s1">&#39;EXTERN&#39;</span><span class="p">)</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">core</span><span class="o">.</span><span class="n">get_option</span><span class="p">(</span><span class="s1">&#39;SCF&#39;</span><span class="p">,</span> <span class="s1">&#39;PERTURB_H&#39;</span><span class="p">)</span>
                                     <span class="ow">and</span> <span class="ow">not</span> <span class="n">efp_present</span><span class="p">)</span>
    <span class="n">rotations_projection_sound</span> <span class="o">=</span> <span class="p">(</span><span class="n">translations_projection_sound</span> <span class="ow">and</span> <span class="n">stationary_point</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">translations_projection_sound</span><span class="p">,</span> <span class="n">rotations_projection_sound</span>


<span class="k">def</span> <span class="nf">_filter_renamed_methods</span><span class="p">(</span><span class="n">compute</span><span class="p">,</span> <span class="n">method</span><span class="p">):</span>
<span class="w">    </span><span class="sa">r</span><span class="sd">&quot;&quot;&quot;Raises UpgradeHelper when a method has been renamed.&quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">method</span> <span class="o">==</span> <span class="s2">&quot;dcft&quot;</span><span class="p">:</span>
        <span class="k">raise</span> <span class="n">UpgradeHelper</span><span class="p">(</span><span class="n">compute</span> <span class="o">+</span> <span class="s2">&quot;(&#39;dcft&#39;)&quot;</span><span class="p">,</span> <span class="n">compute</span> <span class="o">+</span> <span class="s2">&quot;(&#39;dct&#39;)&quot;</span><span class="p">,</span> <span class="mf">1.4</span><span class="p">,</span>
                            <span class="s2">&quot; All instances of &#39;dcft&#39; should be replaced with &#39;dct&#39;.&quot;</span><span class="p">)</span>


<div class="viewcode-block" id="energy"><a class="viewcode-back" href="../../../energy.html#psi4.driver.energy">[docs]</a><span class="k">def</span> <span class="nf">energy</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
<span class="w">    </span><span class="sa">r</span><span class="sd">&quot;&quot;&quot;Function to compute the single-point electronic energy.</span>

<span class="sd">    :returns: *float* |w--w| Total electronic energy in Hartrees. SAPT &amp; EFP return interaction energy.</span>

<span class="sd">    :returns: (*float*, :py:class:`~psi4.core.Wavefunction`) |w--w| energy and wavefunction when **return_wfn** specified.</span>

<span class="sd">    :PSI variables:</span>

<span class="sd">    .. hlist::</span>
<span class="sd">       :columns: 1</span>

<span class="sd">       * :psivar:`CURRENT ENERGY`</span>
<span class="sd">       * :psivar:`CURRENT REFERENCE ENERGY`</span>
<span class="sd">       * :psivar:`CURRENT CORRELATION ENERGY`</span>

<span class="sd">    :type name: str</span>
<span class="sd">    :param name: ``&#39;scf&#39;`` || ``&#39;mp2&#39;`` || ``&#39;ci5&#39;`` || etc.</span>

<span class="sd">        First argument, usually unlabeled. Indicates the computational method</span>
<span class="sd">        to be applied to the system.</span>

<span class="sd">    :type molecule: :ref:`molecule &lt;op_py_molecule&gt;`</span>
<span class="sd">    :param molecule: ``h2o`` || etc.</span>

<span class="sd">        The target molecule, if not the last molecule defined.</span>

<span class="sd">    :type return_wfn: :ref:`boolean &lt;op_py_boolean&gt;`</span>
<span class="sd">    :param return_wfn: ``&#39;on&#39;`` || |dl| ``&#39;off&#39;`` |dr|</span>

<span class="sd">        Indicate to additionally return the :py:class:`~psi4.core.Wavefunction`</span>
<span class="sd">        calculation result as the second element (after *float* energy) of a tuple.</span>

<span class="sd">    :type write_orbitals: str, :ref:`boolean &lt;op_py_boolean&gt;`</span>
<span class="sd">    :param write_orbitals: ``filename`` || |dl| ``&#39;on&#39;`` |dr| || ``&#39;off&#39;`` </span>

<span class="sd">        (str) Save wfn containing current orbitals to the given file name after each SCF iteration</span>
<span class="sd">        and retain after |PSIfour| finishes.</span>

<span class="sd">        (:ref:`boolean &lt;op_py_boolean&gt;`) Turns writing the orbitals after the converged SCF on/off.</span>
<span class="sd">        Orbital file will be deleted unless |PSIfour| is called with `-m` flag.</span>

<span class="sd">    :type restart_file: str</span>
<span class="sd">    :param restart_file: ``[&#39;file.1, file.32]`` || ``./file`` || etc.</span>

<span class="sd">        Existing files to be renamed and copied for calculation restart, e.g. a serialized wfn or module-specific binary data.</span>

<span class="sd">    .. _`table:energy_gen`:</span>

<span class="sd">    +-------------------------+---------------------------------------------------------------------------------------------------------------------------------------+</span>
<span class="sd">    | name                    | calls method                                                                                                                          |</span>
<span class="sd">    +=========================+=======================================================================================================================================+</span>
<span class="sd">    | efp                     | (with LibEFP) effective fragment potential (EFP) :ref:`[manual] &lt;sec:libefp&gt;`                                                         |</span>
<span class="sd">    +-------------------------+---------------------------------------------------------------------------------------------------------------------------------------+</span>
<span class="sd">    | scf                     | Hartree--Fock (HF) or density functional theory (DFT) :ref:`[manual] &lt;sec:scf&gt;` :ref:`[details] &lt;dd_b3lyp&gt;`                           |</span>
<span class="sd">    +-------------------------+---------------------------------------------------------------------------------------------------------------------------------------+</span>
<span class="sd">    | hf                      | HF self consistent field (SCF) :ref:`[manual] &lt;sec:scf&gt;` :ref:`[details] &lt;dd_hf&gt;`                                                     |</span>
<span class="sd">    +-------------------------+---------------------------------------------------------------------------------------------------------------------------------------+</span>
<span class="sd">    | qchf                    | quadratically-convergent HF                                                                                                           |</span>
<span class="sd">    +-------------------------+---------------------------------------------------------------------------------------------------------------------------------------+</span>
<span class="sd">    | hf3c                    | HF with dispersion, BSSE, and basis set corrections :ref:`[manual] &lt;sec:gcp&gt;`                                                         |</span>
<span class="sd">    +-------------------------+---------------------------------------------------------------------------------------------------------------------------------------+</span>
<span class="sd">    | pbeh3c                  | PBEh with dispersion, BSSE, and basis set corrections :ref:`[manual] &lt;sec:gcp&gt;`                                                       |</span>
<span class="sd">    +-------------------------+---------------------------------------------------------------------------------------------------------------------------------------+</span>
<span class="sd">    | dct                     | density cumulant (functional) theory :ref:`[manual] &lt;sec:dct&gt;`                                                                        |</span>
<span class="sd">    +-------------------------+---------------------------------------------------------------------------------------------------------------------------------------+</span>
<span class="sd">    | mp2                     | 2nd-order |MollerPlesset| perturbation theory (MP2) :ref:`[manual] &lt;sec:dfmp2&gt;` :ref:`[details] &lt;dd_mp2&gt;`                             |</span>
<span class="sd">    +-------------------------+---------------------------------------------------------------------------------------------------------------------------------------+</span>
<span class="sd">    | scs-mp2                 | spin-component scaled MP2 :ref:`[manual] &lt;sec:occ_nonoo&gt;`                                                                             |</span>
<span class="sd">    +-------------------------+---------------------------------------------------------------------------------------------------------------------------------------+</span>
<span class="sd">    | scs(n)-mp2              | a special version of SCS-MP2 for nucleobase interactions :ref:`[manual] &lt;sec:occ_nonoo&gt;`                                              |</span>
<span class="sd">    +-------------------------+---------------------------------------------------------------------------------------------------------------------------------------+</span>
<span class="sd">    | scs-mp2-vdw             | a special version of SCS-MP2 (from ethene dimers) :ref:`[manual] &lt;sec:occ_nonoo&gt;`                                                     |</span>
<span class="sd">    +-------------------------+---------------------------------------------------------------------------------------------------------------------------------------+</span>
<span class="sd">    | sos-mp2                 | spin-opposite scaled MP2 :ref:`[manual] &lt;sec:occ_nonoo&gt;`                                                                              |</span>
<span class="sd">    +-------------------------+---------------------------------------------------------------------------------------------------------------------------------------+</span>
<span class="sd">    | dlpno-mp2               | local MP2 with pair natural orbital domains (DLPNO) :ref:`[manual] &lt;sec:dlpnomp2&gt;`                                                    |</span>
<span class="sd">    +-------------------------+---------------------------------------------------------------------------------------------------------------------------------------+</span>
<span class="sd">    | scs-dlpno-mp2           | spin-component-scaled DLPNO MP2 :ref:`[manual] &lt;sec:dlpnomp2&gt;`                                                                        |</span>
<span class="sd">    +-------------------------+---------------------------------------------------------------------------------------------------------------------------------------+</span>
<span class="sd">    | mp3                     | 3rd-order |MollerPlesset| perturbation theory (MP3) :ref:`[manual] &lt;sec:occ_nonoo&gt;` :ref:`[details] &lt;dd_mp3&gt;`                         |</span>
<span class="sd">    +-------------------------+---------------------------------------------------------------------------------------------------------------------------------------+</span>
<span class="sd">    | fno-mp3                 | MP3 with frozen natural orbitals :ref:`[manual] &lt;sec:fnocc&gt;`                                                                          |</span>
<span class="sd">    +-------------------------+---------------------------------------------------------------------------------------------------------------------------------------+</span>
<span class="sd">    | scs-mp3                 | spin-component scaled MP3 :ref:`[manual] &lt;sec:occ_nonoo&gt;`                                                                             |</span>
<span class="sd">    +-------------------------+---------------------------------------------------------------------------------------------------------------------------------------+</span>
<span class="sd">    | sos-pi-mp2              | A special version of SOS-MP2 for pi systems :ref:`[manual] &lt;sec:occ_nonoo&gt;`                                                           |</span>
<span class="sd">    +-------------------------+---------------------------------------------------------------------------------------------------------------------------------------+</span>
<span class="sd">    | mp2.5                   | average of MP2 and MP3 :ref:`[manual] &lt;sec:occ_nonoo&gt;` :ref:`[details] &lt;dd_mp2p5&gt;`                                                    |</span>
<span class="sd">    +-------------------------+---------------------------------------------------------------------------------------------------------------------------------------+</span>
<span class="sd">    | mp4(sdq)                | 4th-order MP perturbation theory (MP4) less triples :ref:`[manual] &lt;sec:fnompn&gt;` :ref:`[details] &lt;dd_mp4_prsdq_pr&gt;`                   |</span>
<span class="sd">    +-------------------------+---------------------------------------------------------------------------------------------------------------------------------------+</span>
<span class="sd">    | fno-mp4(sdq)            | MP4 (less triples) with frozen natural orbitals :ref:`[manual] &lt;sec:fnocc&gt;`                                                           |</span>
<span class="sd">    +-------------------------+---------------------------------------------------------------------------------------------------------------------------------------+</span>
<span class="sd">    | mp4                     | full MP4 :ref:`[manual] &lt;sec:fnompn&gt;` :ref:`[details] &lt;dd_mp4&gt;`                                                                       |</span>
<span class="sd">    +-------------------------+---------------------------------------------------------------------------------------------------------------------------------------+</span>
<span class="sd">    | fno-mp4                 | full MP4 with frozen natural orbitals :ref:`[manual] &lt;sec:fnocc&gt;`                                                                     |</span>
<span class="sd">    +-------------------------+---------------------------------------------------------------------------------------------------------------------------------------+</span>
<span class="sd">    | mp\ *n*                 | *n*\ th-order |MollerPlesset| (MP) perturbation theory :ref:`[manual] &lt;sec:arbpt&gt;` :ref:`[details] &lt;dd_mp4&gt;`                          |</span>
<span class="sd">    +-------------------------+---------------------------------------------------------------------------------------------------------------------------------------+</span>
<span class="sd">    | zapt\ *n*               | *n*\ th-order z-averaged perturbation theory (ZAPT) :ref:`[manual] &lt;sec:arbpt&gt;` :ref:`[details] &lt;dd_zapt2&gt;`                           |</span>
<span class="sd">    +-------------------------+---------------------------------------------------------------------------------------------------------------------------------------+</span>
<span class="sd">    | omp2                    | orbital-optimized second-order MP perturbation theory :ref:`[manual] &lt;sec:occ_oo&gt;` :ref:`[details] &lt;dd_omp2&gt;`                         |</span>
<span class="sd">    +-------------------------+---------------------------------------------------------------------------------------------------------------------------------------+</span>
<span class="sd">    | scs-omp2                | spin-component scaled OMP2 :ref:`[manual] &lt;sec:occ_oo&gt;`                                                                               |</span>
<span class="sd">    +-------------------------+---------------------------------------------------------------------------------------------------------------------------------------+</span>
<span class="sd">    | sos-omp2                | spin-opposite scaled OMP2 :ref:`[manual] &lt;sec:occ_oo&gt;`                                                                                |</span>
<span class="sd">    +-------------------------+---------------------------------------------------------------------------------------------------------------------------------------+</span>
<span class="sd">    | omp3                    | orbital-optimized third-order MP perturbation theory :ref:`[manual] &lt;sec:occ_oo&gt;` :ref:`[details] &lt;dd_omp3&gt;`                          |</span>
<span class="sd">    +-------------------------+---------------------------------------------------------------------------------------------------------------------------------------+</span>
<span class="sd">    | scs-omp3                | spin-component scaled OMP3 :ref:`[manual] &lt;sec:occ_oo&gt;`                                                                               |</span>
<span class="sd">    +-------------------------+---------------------------------------------------------------------------------------------------------------------------------------+</span>
<span class="sd">    | sos-omp3                | spin-opposite scaled OMP3 :ref:`[manual] &lt;sec:occ_oo&gt;`                                                                                |</span>
<span class="sd">    +-------------------------+---------------------------------------------------------------------------------------------------------------------------------------+</span>
<span class="sd">    | omp2.5                  | orbital-optimized MP2.5 :ref:`[manual] &lt;sec:occ_oo&gt;` :ref:`[details] &lt;dd_omp2p5&gt;`                                                     |</span>
<span class="sd">    +-------------------------+---------------------------------------------------------------------------------------------------------------------------------------+</span>
<span class="sd">    | lccsd, cepa(0)          | coupled electron pair approximation variant 0 :ref:`[manual] &lt;sec:fnocepa&gt;` :ref:`[details] &lt;dd_lccsd&gt;`                               |</span>
<span class="sd">    +-------------------------+---------------------------------------------------------------------------------------------------------------------------------------+</span>
<span class="sd">    | fno-lccsd, fno-cepa(0)  | CEPA(0) with frozen natural orbitals :ref:`[manual] &lt;sec:fnocc&gt;`                                                                      |</span>
<span class="sd">    +-------------------------+---------------------------------------------------------------------------------------------------------------------------------------+</span>
<span class="sd">    | cepa(1)                 | coupled electron pair approximation variant 1 :ref:`[manual] &lt;sec:fnocepa&gt;` :ref:`[details] &lt;dd_cepa_pr1_pr&gt;`                         |</span>
<span class="sd">    +-------------------------+---------------------------------------------------------------------------------------------------------------------------------------+</span>
<span class="sd">    | fno-cepa(1)             | CEPA(1) with frozen natural orbitals :ref:`[manual] &lt;sec:fnocc&gt;`                                                                      |</span>
<span class="sd">    +-------------------------+---------------------------------------------------------------------------------------------------------------------------------------+</span>
<span class="sd">    | cepa(3)                 | coupled electron pair approximation variant 3 :ref:`[manual] &lt;sec:fnocepa&gt;` :ref:`[details] &lt;dd_cepa_pr3_pr&gt;`                         |</span>
<span class="sd">    +-------------------------+---------------------------------------------------------------------------------------------------------------------------------------+</span>
<span class="sd">    | fno-cepa(3)             | CEPA(3) with frozen natural orbitals :ref:`[manual] &lt;sec:fnocc&gt;`                                                                      |</span>
<span class="sd">    +-------------------------+---------------------------------------------------------------------------------------------------------------------------------------+</span>
<span class="sd">    | acpf                    | averaged coupled-pair functional :ref:`[manual] &lt;sec:fnocepa&gt;` :ref:`[details] &lt;dd_acpf&gt;`                                             |</span>
<span class="sd">    +-------------------------+---------------------------------------------------------------------------------------------------------------------------------------+</span>
<span class="sd">    | fno-acpf                | ACPF with frozen natural orbitals :ref:`[manual] &lt;sec:fnocc&gt;`                                                                         |</span>
<span class="sd">    +-------------------------+---------------------------------------------------------------------------------------------------------------------------------------+</span>
<span class="sd">    | aqcc                    | averaged quadratic coupled cluster :ref:`[manual] &lt;sec:fnocepa&gt;` :ref:`[details] &lt;dd_aqcc&gt;`                                           |</span>
<span class="sd">    +-------------------------+---------------------------------------------------------------------------------------------------------------------------------------+</span>
<span class="sd">    | fno-aqcc                | AQCC with frozen natural orbitals :ref:`[manual] &lt;sec:fnocc&gt;`                                                                         |</span>
<span class="sd">    +-------------------------+---------------------------------------------------------------------------------------------------------------------------------------+</span>
<span class="sd">    | qcisd                   | quadratic CI singles doubles (QCISD) :ref:`[manual] &lt;sec:fnocc&gt;` :ref:`[details] &lt;dd_qcisd&gt;`                                          |</span>
<span class="sd">    +-------------------------+---------------------------------------------------------------------------------------------------------------------------------------+</span>
<span class="sd">    | fno-qcisd               | QCISD with frozen natural orbitals :ref:`[manual] &lt;sec:fnocc&gt;`                                                                        |</span>
<span class="sd">    +-------------------------+---------------------------------------------------------------------------------------------------------------------------------------+</span>
<span class="sd">    | remp2                   | 2nd-order retaining-the-excitation-degree MP hybrid perturbation theory :ref:`[manual] &lt;sec:occ_nonoo&gt;` :ref:`[details] &lt;dd_remp2&gt;`   |</span>
<span class="sd">    +-------------------------+---------------------------------------------------------------------------------------------------------------------------------------+</span>
<span class="sd">    | oremp2                  | orbital-optimized REMP2 :ref:`[manual] &lt;sec:occ_oo&gt;` :ref:`[details] &lt;dd_oremp2&gt;`                                                     |</span>
<span class="sd">    +-------------------------+---------------------------------------------------------------------------------------------------------------------------------------+</span>
<span class="sd">    | lccd                    | Linear CCD :ref:`[manual] &lt;sec:occ_nonoo&gt;` :ref:`[details] &lt;dd_lccd&gt;`                                                                 |</span>
<span class="sd">    +-------------------------+---------------------------------------------------------------------------------------------------------------------------------------+</span>
<span class="sd">    | fno-lccd                | LCCD with frozen natural orbitals :ref:`[manual] &lt;sec:fnocc&gt;`                                                                         |</span>
<span class="sd">    +-------------------------+---------------------------------------------------------------------------------------------------------------------------------------+</span>
<span class="sd">    | olccd                   | orbital optimized LCCD :ref:`[manual] &lt;sec:occ_oo&gt;` :ref:`[details] &lt;dd_olccd&gt;`                                                       |</span>
<span class="sd">    +-------------------------+---------------------------------------------------------------------------------------------------------------------------------------+</span>
<span class="sd">    | cc2                     | approximate coupled cluster singles and doubles (CC2) :ref:`[manual] &lt;sec:cc&gt;` :ref:`[details] &lt;dd_cc2&gt;`                              |</span>
<span class="sd">    +-------------------------+---------------------------------------------------------------------------------------------------------------------------------------+</span>
<span class="sd">    | ccd                     | coupled cluster doubles (CCD) :ref:`[manual] &lt;sec:occ_nonoo&gt;` :ref:`[details] &lt;dd_ccd&gt;`                                               |</span>
<span class="sd">    +-------------------------+---------------------------------------------------------------------------------------------------------------------------------------+</span>
<span class="sd">    | ccsd                    | coupled cluster singles and doubles (CCSD) :ref:`[manual] &lt;sec:cc&gt;` :ref:`[details] &lt;dd_ccsd&gt;`                                        |</span>
<span class="sd">    +-------------------------+---------------------------------------------------------------------------------------------------------------------------------------+</span>
<span class="sd">    | bccd                    | Brueckner coupled cluster doubles (BCCD) :ref:`[manual] &lt;sec:cc&gt;` :ref:`[details] &lt;dd_bccd&gt;`                                          |</span>
<span class="sd">    +-------------------------+---------------------------------------------------------------------------------------------------------------------------------------+</span>
<span class="sd">    | fno-ccsd                | CCSD with frozen natural orbitals :ref:`[manual] &lt;sec:fnocc&gt;`                                                                         |</span>
<span class="sd">    +-------------------------+---------------------------------------------------------------------------------------------------------------------------------------+</span>
<span class="sd">    | qcisd(t)                | QCISD with perturbative triples :ref:`[manual] &lt;sec:fnocc&gt;` :ref:`[details] &lt;dd_qcisd_prt_pr&gt;`                                        |</span>
<span class="sd">    +-------------------------+---------------------------------------------------------------------------------------------------------------------------------------+</span>
<span class="sd">    | fno-qcisd(t)            | QCISD(T) with frozen natural orbitals :ref:`[manual] &lt;sec:fnocc&gt;`                                                                     |</span>
<span class="sd">    +-------------------------+---------------------------------------------------------------------------------------------------------------------------------------+</span>
<span class="sd">    | ccsd(t)                 | CCSD with perturbative triples (CCSD(T)) :ref:`[manual] &lt;sec:cc&gt;` :ref:`[details] &lt;dd_ccsd_prt_pr&gt;`                                   |</span>
<span class="sd">    +-------------------------+---------------------------------------------------------------------------------------------------------------------------------------+</span>
<span class="sd">    | a-ccsd(t)               | CCSD with asymmetric perturbative triples (A-CCSD(T)) :ref:`[manual] &lt;sec:cc&gt;` :ref:`[details] &lt;dd_accsd_prt_pr&gt;`                     |</span>
<span class="sd">    +-------------------------+---------------------------------------------------------------------------------------------------------------------------------------+</span>
<span class="sd">    | bccd(t)                 | BCCD with perturbative triples :ref:`[manual] &lt;sec:cc&gt;` :ref:`[details] &lt;dd_bccd_prt_pr&gt;`                                             |</span>
<span class="sd">    +-------------------------+---------------------------------------------------------------------------------------------------------------------------------------+</span>
<span class="sd">    | fno-ccsd(t)             | CCSD(T) with frozen natural orbitals :ref:`[manual] &lt;sec:fnocc&gt;`                                                                      |</span>
<span class="sd">    +-------------------------+---------------------------------------------------------------------------------------------------------------------------------------+</span>
<span class="sd">    | cc3                     | approximate CC singles, doubles, and triples (CC3) :ref:`[manual] &lt;sec:cc&gt;` :ref:`[details] &lt;dd_cc3&gt;`                                 |</span>
<span class="sd">    +-------------------------+---------------------------------------------------------------------------------------------------------------------------------------+</span>
<span class="sd">    | ccenergy                | **expert** full control over ccenergy module                                                                                          |</span>
<span class="sd">    +-------------------------+---------------------------------------------------------------------------------------------------------------------------------------+</span>
<span class="sd">    | cisd                    | configuration interaction (CI) singles and doubles (CISD) :ref:`[manual] &lt;sec:ci&gt;` :ref:`[details] &lt;dd_cisd&gt;`                         |</span>
<span class="sd">    +-------------------------+---------------------------------------------------------------------------------------------------------------------------------------+</span>
<span class="sd">    | fno-cisd                | CISD with frozen natural orbitals :ref:`[manual] &lt;sec:fnocc&gt;`                                                                         |</span>
<span class="sd">    +-------------------------+---------------------------------------------------------------------------------------------------------------------------------------+</span>
<span class="sd">    | cisdt                   | CI singles, doubles, and triples (CISDT) :ref:`[manual] &lt;sec:ci&gt;`                                                                     |</span>
<span class="sd">    +-------------------------+---------------------------------------------------------------------------------------------------------------------------------------+</span>
<span class="sd">    | cisdtq                  | CI singles, doubles, triples, and quadruples (CISDTQ) :ref:`[manual] &lt;sec:ci&gt;`                                                        |</span>
<span class="sd">    +-------------------------+---------------------------------------------------------------------------------------------------------------------------------------+</span>
<span class="sd">    | ci\ *n*                 | *n*\ th-order CI :ref:`[manual] &lt;sec:ci&gt;` :ref:`[details] &lt;dd_cisd&gt;`                                                                  |</span>
<span class="sd">    +-------------------------+---------------------------------------------------------------------------------------------------------------------------------------+</span>
<span class="sd">    | fci                     | full configuration interaction (FCI) :ref:`[manual] &lt;sec:ci&gt;` :ref:`[details] &lt;dd_fci&gt;`                                               |</span>
<span class="sd">    +-------------------------+---------------------------------------------------------------------------------------------------------------------------------------+</span>
<span class="sd">    | detci                   | **expert** full control over detci module                                                                                             |</span>
<span class="sd">    +-------------------------+---------------------------------------------------------------------------------------------------------------------------------------+</span>
<span class="sd">    | gaussian-2, g2          | Gaussian-2 composite method :ref:`[manual] &lt;sec:fnogn&gt;`                                                                               |</span>
<span class="sd">    +-------------------------+---------------------------------------------------------------------------------------------------------------------------------------+</span>
<span class="sd">    | casscf                  | complete active space self consistent field (CASSCF) :ref:`[manual] &lt;sec:ci&gt;`                                                         |</span>
<span class="sd">    +-------------------------+---------------------------------------------------------------------------------------------------------------------------------------+</span>
<span class="sd">    | rasscf                  | restricted active space self consistent field (RASSCF) :ref:`[manual] &lt;sec:ci&gt;`                                                       |</span>
<span class="sd">    +-------------------------+---------------------------------------------------------------------------------------------------------------------------------------+</span>
<span class="sd">    | mcscf                   | multiconfigurational self consistent field (SCF) :ref:`[manual] &lt;sec:psimrcc&gt;`                                                        |</span>
<span class="sd">    +-------------------------+---------------------------------------------------------------------------------------------------------------------------------------+</span>
<span class="sd">    | psimrcc                 | Mukherjee multireference coupled cluster (Mk-MRCC) :ref:`[manual] &lt;sec:psimrcc&gt;`                                                      |</span>
<span class="sd">    +-------------------------+---------------------------------------------------------------------------------------------------------------------------------------+</span>
<span class="sd">    | psimrcc_scf             | Mk-MRCC with regular SCF module (convenience function) :ref:`[manual] &lt;sec:psimrcc&gt;`                                                  |</span>
<span class="sd">    +-------------------------+---------------------------------------------------------------------------------------------------------------------------------------+</span>
<span class="sd">    | dmrg-scf                | (with CheMPS2) density matrix renormalization group SCF :ref:`[manual] &lt;sec:chemps2&gt;`                                                 |</span>
<span class="sd">    +-------------------------+---------------------------------------------------------------------------------------------------------------------------------------+</span>
<span class="sd">    | dmrg-caspt2             | (with CheMPS2) density matrix renormalization group CASPT2 :ref:`[manual] &lt;sec:chemps2&gt;`                                              |</span>
<span class="sd">    +-------------------------+---------------------------------------------------------------------------------------------------------------------------------------+</span>
<span class="sd">    | dmrg-ci                 | (with CheMPS2) density matrix renormalization group CI :ref:`[manual] &lt;sec:chemps2&gt;`                                                  |</span>
<span class="sd">    +-------------------------+---------------------------------------------------------------------------------------------------------------------------------------+</span>
<span class="sd">    | sapt0                   | 0th-order symmetry adapted perturbation theory (SAPT) :ref:`[manual] &lt;sec:sapt&gt;`                                                      |</span>
<span class="sd">    +-------------------------+---------------------------------------------------------------------------------------------------------------------------------------+</span>
<span class="sd">    | ssapt0                  | 0th-order SAPT with special exchange scaling :ref:`[manual] &lt;sec:sapt&gt;`                                                               |</span>
<span class="sd">    +-------------------------+---------------------------------------------------------------------------------------------------------------------------------------+</span>
<span class="sd">    | fisapt0                 | 0th-order functional and/or intramolecular SAPT :ref:`[manual] &lt;sec:fisapt&gt;`                                                          |</span>
<span class="sd">    +-------------------------+---------------------------------------------------------------------------------------------------------------------------------------+</span>
<span class="sd">    | sf-sapt                 | 0th-order spin-flip SAPT :ref:`[manual] &lt;sec:sfsapt&gt;`                                                                                 |</span>
<span class="sd">    +-------------------------+---------------------------------------------------------------------------------------------------------------------------------------+</span>
<span class="sd">    | sapt(dft)               | 0th-order SAPT upon KS reference :ref:`[manual] &lt;sec:saptdft&gt;`                                                                        |</span>
<span class="sd">    +-------------------------+---------------------------------------------------------------------------------------------------------------------------------------+</span>
<span class="sd">    | sapt2                   | 2nd-order SAPT, traditional definition :ref:`[manual] &lt;sec:sapt&gt;`                                                                     |</span>
<span class="sd">    +-------------------------+---------------------------------------------------------------------------------------------------------------------------------------+</span>
<span class="sd">    | sapt2+                  | SAPT including all 2nd-order terms :ref:`[manual] &lt;sec:sapt&gt;`                                                                         |</span>
<span class="sd">    +-------------------------+---------------------------------------------------------------------------------------------------------------------------------------+</span>
<span class="sd">    | sapt2+(3)               | SAPT including perturbative triples :ref:`[manual] &lt;sec:sapt&gt;`                                                                        |</span>
<span class="sd">    +-------------------------+---------------------------------------------------------------------------------------------------------------------------------------+</span>
<span class="sd">    | sapt2+3                 | SAPT including all 3rd-order terms :ref:`[manual] &lt;sec:sapt&gt;`                                                                         |</span>
<span class="sd">    +-------------------------+---------------------------------------------------------------------------------------------------------------------------------------+</span>
<span class="sd">    | sapt2+(ccd)             | SAPT2+ with CC-based dispersion :ref:`[manual] &lt;sec:sapt&gt;`                                                                            |</span>
<span class="sd">    +-------------------------+---------------------------------------------------------------------------------------------------------------------------------------+</span>
<span class="sd">    | sapt2+(3)(ccd)          | SAPT2+(3) with CC-based dispersion :ref:`[manual] &lt;sec:sapt&gt;`                                                                         |</span>
<span class="sd">    +-------------------------+---------------------------------------------------------------------------------------------------------------------------------------+</span>
<span class="sd">    | sapt2+3(ccd)            | SAPT2+3 with CC-based dispersion :ref:`[manual] &lt;sec:sapt&gt;`                                                                           |</span>
<span class="sd">    +-------------------------+---------------------------------------------------------------------------------------------------------------------------------------+</span>
<span class="sd">    | sapt2+dmp2              | SAPT including all 2nd-order terms and MP2 correction :ref:`[manual] &lt;sec:sapt&gt;`                                                      |</span>
<span class="sd">    +-------------------------+---------------------------------------------------------------------------------------------------------------------------------------+</span>
<span class="sd">    | sapt2+(3)dmp2           | SAPT including perturbative triples and MP2 correction :ref:`[manual] &lt;sec:sapt&gt;`                                                     |</span>
<span class="sd">    +-------------------------+---------------------------------------------------------------------------------------------------------------------------------------+</span>
<span class="sd">    | sapt2+3dmp2             | SAPT including all 3rd-order terms and MP2 correction :ref:`[manual] &lt;sec:sapt&gt;`                                                      |</span>
<span class="sd">    +-------------------------+---------------------------------------------------------------------------------------------------------------------------------------+</span>
<span class="sd">    | sapt2+(ccd)dmp2         | SAPT2+ with CC-based dispersion and MP2 correction :ref:`[manual] &lt;sec:sapt&gt;`                                                         |</span>
<span class="sd">    +-------------------------+---------------------------------------------------------------------------------------------------------------------------------------+</span>
<span class="sd">    | sapt2+(3)(ccd)dmp2      | SAPT2+(3) with CC-based dispersion and MP2 correction :ref:`[manual] &lt;sec:sapt&gt;`                                                      |</span>
<span class="sd">    +-------------------------+---------------------------------------------------------------------------------------------------------------------------------------+</span>
<span class="sd">    | sapt2+3(ccd)dmp2        | SAPT2+3 with CC-based dispersion and MP2 correction :ref:`[manual] &lt;sec:sapt&gt;`                                                        |</span>
<span class="sd">    +-------------------------+---------------------------------------------------------------------------------------------------------------------------------------+</span>
<span class="sd">    | sapt0-ct                | 0th-order SAPT plus charge transfer (CT) calculation :ref:`[manual] &lt;sec:saptct&gt;`                                                     |</span>
<span class="sd">    +-------------------------+---------------------------------------------------------------------------------------------------------------------------------------+</span>
<span class="sd">    | sapt2-ct                | SAPT2 plus CT :ref:`[manual] &lt;sec:saptct&gt;`                                                                                            |</span>
<span class="sd">    +-------------------------+---------------------------------------------------------------------------------------------------------------------------------------+</span>
<span class="sd">    | sapt2+-ct               | SAPT2+ plus CT :ref:`[manual] &lt;sec:saptct&gt;`                                                                                           |</span>
<span class="sd">    +-------------------------+---------------------------------------------------------------------------------------------------------------------------------------+</span>
<span class="sd">    | sapt2+(3)-ct            | SAPT2+(3) plus CT :ref:`[manual] &lt;sec:saptct&gt;`                                                                                        |</span>
<span class="sd">    +-------------------------+---------------------------------------------------------------------------------------------------------------------------------------+</span>
<span class="sd">    | sapt2+3-ct              | SAPT2+3 plus CT :ref:`[manual] &lt;sec:saptct&gt;`                                                                                          |</span>
<span class="sd">    +-------------------------+---------------------------------------------------------------------------------------------------------------------------------------+</span>
<span class="sd">    | sapt2+(ccd)-ct          | SAPT2+(CCD) plus CT :ref:`[manual] &lt;sec:saptct&gt;`                                                                                      |</span>
<span class="sd">    +-------------------------+---------------------------------------------------------------------------------------------------------------------------------------+</span>
<span class="sd">    | sapt2+(3)(ccd)-ct       | SAPT2+(3)(CCD) plus CT :ref:`[manual] &lt;sec:saptct&gt;`                                                                                   |</span>
<span class="sd">    +-------------------------+---------------------------------------------------------------------------------------------------------------------------------------+</span>
<span class="sd">    | sapt2+3(ccd)-ct         | SAPT2+3(CCD) plus CT :ref:`[manual] &lt;sec:saptct&gt;`                                                                                     |</span>
<span class="sd">    +-------------------------+---------------------------------------------------------------------------------------------------------------------------------------+</span>
<span class="sd">    | adc                     | 2nd-order algebraic diagrammatic construction (ADC), deprecated :ref:`[manual] &lt;sec:adc&gt;`                                             |</span>
<span class="sd">    +-------------------------+---------------------------------------------------------------------------------------------------------------------------------------+</span>
<span class="sd">    | adc(1)                  | (with ADCC) 1st-order algebraic diagrammatic construction (ADC) :ref:`[manual] &lt;sec:adc&gt;`                                             |</span>
<span class="sd">    +-------------------------+---------------------------------------------------------------------------------------------------------------------------------------+</span>
<span class="sd">    | adc(2)                  | (with ADCC) 2nd-order ADC :ref:`[manual] &lt;sec:adc&gt;`                                                                                   |</span>
<span class="sd">    +-------------------------+---------------------------------------------------------------------------------------------------------------------------------------+</span>
<span class="sd">    | adc(2)-x                | (with ADCC) extended 2nd-order ADC :ref:`[manual] &lt;sec:adc&gt;`                                                                          |</span>
<span class="sd">    +-------------------------+---------------------------------------------------------------------------------------------------------------------------------------+</span>
<span class="sd">    | adc(3)                  | (with ADCC) 3rd-order ADC :ref:`[manual] &lt;sec:adc&gt;`                                                                                   |</span>
<span class="sd">    +-------------------------+---------------------------------------------------------------------------------------------------------------------------------------+</span>
<span class="sd">    | cvs-adc(1)              | (with ADCC) core-valence separation (CVS) 1st-order ADC :ref:`[manual] &lt;sec:adc&gt;`                                                     |</span>
<span class="sd">    +-------------------------+---------------------------------------------------------------------------------------------------------------------------------------+</span>
<span class="sd">    | cvs-adc(2)              | (with ADCC) CVS 2nd-order ADC :ref:`[manual] &lt;sec:adc&gt;`                                                                               |</span>
<span class="sd">    +-------------------------+---------------------------------------------------------------------------------------------------------------------------------------+</span>
<span class="sd">    | cvs-adc(2)-x            | (with ADCC) CVS extended 2nd-order ADC :ref:`[manual] &lt;sec:adc&gt;`                                                                      |</span>
<span class="sd">    +-------------------------+---------------------------------------------------------------------------------------------------------------------------------------+</span>
<span class="sd">    | cvs-adc(3)              | (with ADCC) CVS 3rd-order ADC :ref:`[manual] &lt;sec:adc&gt;`                                                                               |</span>
<span class="sd">    +-------------------------+---------------------------------------------------------------------------------------------------------------------------------------+</span>
<span class="sd">    | ep2                     | 2nd-order electron propagator theory                                                                                                  |</span>
<span class="sd">    +-------------------------+---------------------------------------------------------------------------------------------------------------------------------------+</span>
<span class="sd">    | eom-cc2                 | equation of motion (EOM) CC2 :ref:`[manual] &lt;sec:eomcc&gt;`                                                                              |</span>
<span class="sd">    +-------------------------+---------------------------------------------------------------------------------------------------------------------------------------+</span>
<span class="sd">    | eom-ccsd                | EOM-CCSD :ref:`[manual] &lt;sec:eomcc&gt;`                                                                                                  |</span>
<span class="sd">    +-------------------------+---------------------------------------------------------------------------------------------------------------------------------------+</span>
<span class="sd">    | eom-cc3                 | EOM-CC3 :ref:`[manual] &lt;sec:eomcc&gt;`                                                                                                   |</span>
<span class="sd">    +-------------------------+---------------------------------------------------------------------------------------------------------------------------------------+</span>

<span class="sd">    .. comment missing and why</span>
<span class="sd">    .. comment custom-*mp for occ --- not yet tested or mirrored in dfocc</span>

<span class="sd">    .. include:: /autodoc_dft_energy.rst</span>

<span class="sd">    .. include:: /mrcc_table_energy.rst</span>

<span class="sd">    .. include:: /cfour_table_energy.rst</span>

<span class="sd">    :examples:</span>

<span class="sd">    &gt;&gt;&gt; # [1] Coupled-cluster singles and doubles calculation with psi code</span>
<span class="sd">    &gt;&gt;&gt; energy(&#39;ccsd&#39;)</span>

<span class="sd">    &gt;&gt;&gt; # [2] Charge-transfer SAPT calculation with scf projection from small into</span>
<span class="sd">    &gt;&gt;&gt; #     requested basis, with specified projection fitting basis</span>
<span class="sd">    &gt;&gt;&gt; set basis_guess true</span>
<span class="sd">    &gt;&gt;&gt; set df_basis_guess jun-cc-pVDZ-JKFIT</span>
<span class="sd">    &gt;&gt;&gt; energy(&#39;sapt0-ct&#39;)</span>

<span class="sd">    &gt;&gt;&gt; # [3] Arbitrary-order MPn calculation</span>
<span class="sd">    &gt;&gt;&gt; energy(&#39;mp7&#39;)</span>

<span class="sd">    &gt;&gt;&gt; # [4] Converge scf as singlet, then run detci as triplet upon singlet reference</span>
<span class="sd">    &gt;&gt;&gt; # Note that the integral transformation is not done automatically when detci is run in a separate step.</span>
<span class="sd">    &gt;&gt;&gt; molecule H2 {\n0 1\nH\nH 1 0.74\n}</span>
<span class="sd">    &gt;&gt;&gt; set basis cc-pVDZ</span>
<span class="sd">    &gt;&gt;&gt; set reference rohf</span>
<span class="sd">    &gt;&gt;&gt; scf_e, scf_wfn = energy(&#39;scf&#39;, return_wfn=True)</span>
<span class="sd">    &gt;&gt;&gt; H2.set_multiplicity(3)</span>
<span class="sd">    &gt;&gt;&gt; core.MintsHelper(scf_wfn.basisset()).integrals()</span>
<span class="sd">    &gt;&gt;&gt; energy(&#39;detci&#39;, ref_wfn=scf_wfn)</span>

<span class="sd">    &gt;&gt;&gt; # [5] Run two CI calculations, keeping the integrals generated in the first one.</span>
<span class="sd">    &gt;&gt;&gt; molecule ne {\nNe\n}</span>
<span class="sd">    &gt;&gt;&gt; set basis cc-pVDZ</span>
<span class="sd">    &gt;&gt;&gt; cisd_e, cisd_wfn = energy(&#39;cisd&#39;, return_wfn=True)</span>
<span class="sd">    &gt;&gt;&gt; energy(&#39;fci&#39;, ref_wfn=cisd_wfn)</span>

<span class="sd">    &gt;&gt;&gt; # [6] Can automatically perform complete basis set extrapolations</span>
<span class="sd">    &gt;&gt;&gt; energy(&quot;CCSD/cc-pV[DT]Z&quot;)</span>

<span class="sd">    &gt;&gt;&gt; # [7] Can automatically perform delta corrections that include extrapolations</span>
<span class="sd">    &gt;&gt;&gt; # even with a user-defined extrapolation formula. See sample inputs named</span>
<span class="sd">    &gt;&gt;&gt; # cbs-xtpl* for more examples of this input style</span>
<span class="sd">    &gt;&gt;&gt; energy(&quot;MP2/aug-cc-pv([d,t]+d)z + d:ccsd(t)/cc-pvdz&quot;, corl_scheme=myxtplfn_2)</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">kwargs</span> <span class="o">=</span> <span class="n">p4util</span><span class="o">.</span><span class="n">kwargs_lower</span><span class="p">(</span><span class="n">kwargs</span><span class="p">)</span>

    <span class="c1"># Bounce to MDI (MolSSI driver interface) if mdi kwarg</span>
    <span class="n">use_mdi</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s1">&#39;mdi&#39;</span><span class="p">,</span> <span class="kc">False</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">use_mdi</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">mdi_run</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>

    <span class="n">core</span><span class="o">.</span><span class="n">print_out</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Scratch directory: </span><span class="si">%s</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">core</span><span class="o">.</span><span class="n">IOManager</span><span class="o">.</span><span class="n">shared_object</span><span class="p">()</span><span class="o">.</span><span class="n">get_default_path</span><span class="p">())</span>

    <span class="n">basisstash</span> <span class="o">=</span> <span class="n">p4util</span><span class="o">.</span><span class="n">OptionsState</span><span class="p">([</span><span class="s1">&#39;BASIS&#39;</span><span class="p">])</span>
    <span class="n">return_wfn</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s1">&#39;return_wfn&#39;</span><span class="p">,</span> <span class="kc">False</span><span class="p">)</span>

    <span class="c1"># Make sure the molecule the user provided is the active one</span>
    <span class="n">molecule</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s1">&#39;molecule&#39;</span><span class="p">,</span> <span class="n">core</span><span class="o">.</span><span class="n">get_active_molecule</span><span class="p">())</span>
    <span class="n">molecule</span><span class="o">.</span><span class="n">update_geometry</span><span class="p">()</span>

    <span class="c1">## Pre-planning interventions</span>

    <span class="c1"># * Trip on function or alias as name</span>
    <span class="n">lowername</span> <span class="o">=</span> <span class="n">driver_util</span><span class="o">.</span><span class="n">upgrade_interventions</span><span class="p">(</span><span class="n">name</span><span class="p">)</span>

    <span class="n">_filter_renamed_methods</span><span class="p">(</span><span class="s2">&quot;energy&quot;</span><span class="p">,</span> <span class="n">lowername</span><span class="p">)</span>

    <span class="c1"># * Avert pydantic anger at incomplete modelchem spec</span>
    <span class="n">userbas</span> <span class="o">=</span> <span class="n">core</span><span class="o">.</span><span class="n">get_global_option</span><span class="p">(</span><span class="s1">&#39;BASIS&#39;</span><span class="p">)</span> <span class="ow">or</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;basis&#39;</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">lowername</span> <span class="ow">in</span> <span class="n">integrated_basis_methods</span> <span class="ow">and</span> <span class="n">userbas</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">kwargs</span><span class="p">[</span><span class="s1">&#39;basis&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;(auto)&#39;</span>

    <span class="c1"># Are we planning?</span>
    <span class="n">plan</span> <span class="o">=</span> <span class="n">task_planner</span><span class="o">.</span><span class="n">task_planner</span><span class="p">(</span><span class="s2">&quot;energy&quot;</span><span class="p">,</span> <span class="n">lowername</span><span class="p">,</span> <span class="n">molecule</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;ENERGY PLAN&#39;</span><span class="p">)</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="n">pp</span><span class="o">.</span><span class="n">pformat</span><span class="p">(</span><span class="n">plan</span><span class="o">.</span><span class="n">dict</span><span class="p">()))</span>

    <span class="k">if</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;return_plan&quot;</span><span class="p">,</span> <span class="kc">False</span><span class="p">):</span>
        <span class="c1"># Plan-only requested</span>
        <span class="k">return</span> <span class="n">plan</span>

    <span class="k">elif</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">plan</span><span class="p">,</span> <span class="n">AtomicComputer</span><span class="p">):</span>
        <span class="c1"># Advanced &quot;Computer&quot; active</span>
        <span class="n">plan</span><span class="o">.</span><span class="n">compute</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">plan</span><span class="o">.</span><span class="n">get_psi_results</span><span class="p">(</span><span class="n">return_wfn</span><span class="o">=</span><span class="n">return_wfn</span><span class="p">)</span>

    <span class="k">else</span><span class="p">:</span>
        <span class="c1"># We have unpacked to an AtomicInput</span>
        <span class="n">lowername</span> <span class="o">=</span> <span class="n">plan</span><span class="o">.</span><span class="n">method</span>
        <span class="n">basis</span> <span class="o">=</span> <span class="n">plan</span><span class="o">.</span><span class="n">basis</span>
        <span class="n">core</span><span class="o">.</span><span class="n">set_global_option</span><span class="p">(</span><span class="s2">&quot;BASIS&quot;</span><span class="p">,</span> <span class="n">basis</span><span class="p">)</span>

    <span class="c1">## Second half of this fn -- entry means program running exactly analytic 0th derivative</span>

    <span class="c1"># Commit to procedures[&#39;energy&#39;] call hereafter</span>
    <span class="n">core</span><span class="o">.</span><span class="n">clean_variables</span><span class="p">()</span>

    <span class="c1">#for precallback in hooks[&#39;energy&#39;][&#39;pre&#39;]:</span>
    <span class="c1">#    precallback(lowername, **kwargs)</span>

    <span class="c1"># needed (+restore below) so long as AtomicComputer-s aren&#39;t run through json (where convcrit also lives)</span>
    <span class="n">optstash</span> <span class="o">=</span> <span class="n">driver_util</span><span class="o">.</span><span class="n">negotiate_convergence_criterion</span><span class="p">((</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span> <span class="n">lowername</span><span class="p">,</span> <span class="n">return_optstash</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">optstash2</span> <span class="o">=</span> <span class="n">p4util</span><span class="o">.</span><span class="n">OptionsState</span><span class="p">([</span><span class="s1">&#39;SCF&#39;</span><span class="p">,</span> <span class="s1">&#39;GUESS&#39;</span><span class="p">])</span>

    <span class="c1"># Before invoking the procedure, we rename any file that should be read.</span>
    <span class="c1"># This is a workaround to do restarts with the current PSI4 capabilities</span>
    <span class="c1"># before actual, clean restarts are put in there</span>
    <span class="c1"># Restartfile is always converted to a single-element list if</span>
    <span class="c1"># it contains a single string</span>
    <span class="c1"># DGAS Note: This is hacked together at this point and should be revamped.</span>
    <span class="k">if</span> <span class="s1">&#39;restart_file&#39;</span> <span class="ow">in</span> <span class="n">kwargs</span><span class="p">:</span>
        <span class="n">restartfile</span> <span class="o">=</span> <span class="n">kwargs</span><span class="p">[</span><span class="s1">&#39;restart_file&#39;</span><span class="p">]</span>  <span class="c1"># Option still available for procedure-specific action</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">restartfile</span><span class="p">,</span> <span class="p">(</span><span class="nb">list</span><span class="p">,</span> <span class="nb">tuple</span><span class="p">)):</span>
            <span class="n">restartfile</span> <span class="o">=</span> <span class="p">(</span><span class="n">restartfile</span><span class="p">,</span> <span class="p">)</span>
        <span class="c1"># Rename the files to be read to be consistent with psi4&#39;s file system</span>
        <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">restartfile</span><span class="p">:</span>
            <span class="n">is_numpy_file</span> <span class="o">=</span> <span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span><span class="n">item</span><span class="p">)</span> <span class="ow">and</span> <span class="n">item</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s2">&quot;.npy&quot;</span><span class="p">))</span> <span class="ow">or</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span><span class="n">item</span> <span class="o">+</span> <span class="s2">&quot;.npy&quot;</span><span class="p">)</span>
            <span class="n">name_split</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;\.&#39;</span><span class="p">,</span> <span class="n">item</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">is_numpy_file</span><span class="p">:</span>
                <span class="n">core</span><span class="o">.</span><span class="n">set_local_option</span><span class="p">(</span><span class="s1">&#39;SCF&#39;</span><span class="p">,</span> <span class="s1">&#39;GUESS&#39;</span> <span class="p">,</span><span class="s1">&#39;READ&#39;</span><span class="p">)</span>
                <span class="n">core</span><span class="o">.</span><span class="n">print_out</span><span class="p">(</span><span class="s2">&quot; Found user provided orbital data. Setting orbital guess to READ&quot;</span><span class="p">)</span>
                <span class="n">fname</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">abspath</span><span class="p">(</span><span class="n">core</span><span class="o">.</span><span class="n">get_writer_file_prefix</span><span class="p">(</span><span class="n">molecule</span><span class="o">.</span><span class="n">name</span><span class="p">())))[</span><span class="mi">1</span><span class="p">]</span>
                <span class="n">psi_scratch</span> <span class="o">=</span> <span class="n">core</span><span class="o">.</span><span class="n">IOManager</span><span class="o">.</span><span class="n">shared_object</span><span class="p">()</span><span class="o">.</span><span class="n">get_default_path</span><span class="p">()</span>
                <span class="n">file_num</span> <span class="o">=</span> <span class="n">item</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;.&#39;</span><span class="p">)[</span><span class="o">-</span><span class="mi">2</span><span class="p">]</span> <span class="k">if</span> <span class="s2">&quot;180&quot;</span> <span class="ow">in</span> <span class="n">item</span> <span class="k">else</span> <span class="s2">&quot;180&quot;</span>
                <span class="n">targetfile</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">psi_scratch</span><span class="p">,</span> <span class="n">fname</span> <span class="o">+</span> <span class="s2">&quot;.&quot;</span> <span class="o">+</span> <span class="n">file_num</span> <span class="o">+</span> <span class="s2">&quot;.npy&quot;</span><span class="p">)</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">item</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s2">&quot;.npy&quot;</span><span class="p">):</span>
                    <span class="n">item</span> <span class="o">=</span> <span class="n">item</span> <span class="o">+</span> <span class="s2">&quot;.npy&quot;</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">filenum</span> <span class="o">=</span> <span class="n">name_split</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">filenum</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">filenum</span><span class="p">)</span>
                <span class="k">except</span> <span class="ne">ValueError</span><span class="p">:</span>
                    <span class="n">filenum</span> <span class="o">=</span> <span class="mi">32</span>  <span class="c1"># Default file number is the checkpoint one</span>
                <span class="n">psioh</span> <span class="o">=</span> <span class="n">core</span><span class="o">.</span><span class="n">IOManager</span><span class="o">.</span><span class="n">shared_object</span><span class="p">()</span>
                <span class="n">psio</span> <span class="o">=</span> <span class="n">core</span><span class="o">.</span><span class="n">IO</span><span class="o">.</span><span class="n">shared_object</span><span class="p">()</span>
                <span class="n">filepath</span> <span class="o">=</span> <span class="n">psioh</span><span class="o">.</span><span class="n">get_file_path</span><span class="p">(</span><span class="n">filenum</span><span class="p">)</span>
                <span class="n">namespace</span> <span class="o">=</span> <span class="n">psio</span><span class="o">.</span><span class="n">get_default_namespace</span><span class="p">()</span>
                <span class="n">pid</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">getpid</span><span class="p">())</span>
                <span class="n">prefix</span> <span class="o">=</span> <span class="s1">&#39;psi&#39;</span>
                <span class="n">targetfile</span> <span class="o">=</span> <span class="n">filepath</span> <span class="o">+</span> <span class="n">prefix</span> <span class="o">+</span> <span class="s1">&#39;.&#39;</span> <span class="o">+</span> <span class="n">pid</span> <span class="o">+</span> <span class="s1">&#39;.&#39;</span> <span class="o">+</span> <span class="n">namespace</span> <span class="o">+</span> <span class="s1">&#39;.&#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">filenum</span><span class="p">)</span>
            <span class="n">core</span><span class="o">.</span><span class="n">print_out</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot; </span><span class="se">\n</span><span class="s2"> Copying restart file &lt;</span><span class="si">{</span><span class="n">item</span><span class="si">}</span><span class="s2">&gt; to &lt;</span><span class="si">{</span><span class="n">targetfile</span><span class="si">}</span><span class="s2">&gt; for internal processing</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="n">shutil</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="n">item</span><span class="p">,</span> <span class="n">targetfile</span><span class="p">)</span>

    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Compute energy(): method=</span><span class="si">{</span><span class="n">lowername</span><span class="si">}</span><span class="s2">, basis=</span><span class="si">{</span><span class="n">core</span><span class="o">.</span><span class="n">get_global_option</span><span class="p">(</span><span class="s1">&#39;BASIS&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span><span class="si">}</span><span class="s2">, molecule=</span><span class="si">{</span><span class="n">molecule</span><span class="o">.</span><span class="n">name</span><span class="p">()</span><span class="si">}</span><span class="s2">, nre=</span><span class="si">{</span><span class="s1">&#39;w/EFP&#39;</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="nb">hasattr</span><span class="p">(</span><span class="n">molecule</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;EFP&#39;</span><span class="p">)</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="n">molecule</span><span class="o">.</span><span class="n">nuclear_repulsion_energy</span><span class="p">()</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;w/EFP&quot;</span> <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">molecule</span><span class="p">,</span> <span class="s2">&quot;EFP&quot;</span><span class="p">)</span> <span class="k">else</span> <span class="n">pp</span><span class="o">.</span><span class="n">pformat</span><span class="p">(</span><span class="n">molecule</span><span class="o">.</span><span class="n">to_dict</span><span class="p">()))</span>
    <span class="n">wfn</span> <span class="o">=</span> <span class="n">procedures</span><span class="p">[</span><span class="s1">&#39;energy&#39;</span><span class="p">][</span><span class="n">lowername</span><span class="p">](</span><span class="n">lowername</span><span class="p">,</span> <span class="n">molecule</span><span class="o">=</span><span class="n">molecule</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Return energy(): </span><span class="si">{</span><span class="n">core</span><span class="o">.</span><span class="n">variable</span><span class="p">(</span><span class="s1">&#39;CURRENT ENERGY&#39;</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

    <span class="k">for</span> <span class="n">postcallback</span> <span class="ow">in</span> <span class="n">hooks</span><span class="p">[</span><span class="s1">&#39;energy&#39;</span><span class="p">][</span><span class="s1">&#39;post&#39;</span><span class="p">]:</span>
        <span class="n">postcallback</span><span class="p">(</span><span class="n">lowername</span><span class="p">,</span> <span class="n">wfn</span><span class="o">=</span><span class="n">wfn</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>

    <span class="n">basisstash</span><span class="o">.</span><span class="n">restore</span><span class="p">()</span>
    <span class="n">optstash</span><span class="o">.</span><span class="n">restore</span><span class="p">()</span>
    <span class="n">optstash2</span><span class="o">.</span><span class="n">restore</span><span class="p">()</span>

    <span class="k">if</span> <span class="n">return_wfn</span><span class="p">:</span>  <span class="c1"># TODO current energy safer than wfn.energy() for now, but should be revisited</span>

        <span class="c1"># TODO place this with the associated call, very awkward to call this in other areas at the moment</span>
        <span class="k">if</span> <span class="n">lowername</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;efp&#39;</span><span class="p">,</span> <span class="s1">&#39;mrcc&#39;</span><span class="p">,</span> <span class="s1">&#39;dmrg&#39;</span><span class="p">]:</span>
            <span class="n">core</span><span class="o">.</span><span class="n">print_out</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n\n</span><span class="s2">Warning! </span><span class="si">%s</span><span class="s2"> does not have an associated derived wavefunction.&quot;</span> <span class="o">%</span> <span class="n">name</span><span class="p">)</span>
            <span class="n">core</span><span class="o">.</span><span class="n">print_out</span><span class="p">(</span><span class="s2">&quot;The returned wavefunction is the incoming reference wavefunction.</span><span class="se">\n\n</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">elif</span> <span class="s1">&#39;sapt&#39;</span> <span class="ow">in</span> <span class="n">lowername</span><span class="p">:</span>
            <span class="n">core</span><span class="o">.</span><span class="n">print_out</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n\n</span><span class="s2">Warning! </span><span class="si">%s</span><span class="s2"> does not have an associated derived wavefunction.&quot;</span> <span class="o">%</span> <span class="n">name</span><span class="p">)</span>
            <span class="n">core</span><span class="o">.</span><span class="n">print_out</span><span class="p">(</span><span class="s2">&quot;The returned wavefunction is the dimer SCF wavefunction.</span><span class="se">\n\n</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="k">return</span> <span class="p">(</span><span class="n">core</span><span class="o">.</span><span class="n">variable</span><span class="p">(</span><span class="s1">&#39;CURRENT ENERGY&#39;</span><span class="p">),</span> <span class="n">wfn</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">core</span><span class="o">.</span><span class="n">variable</span><span class="p">(</span><span class="s1">&#39;CURRENT ENERGY&#39;</span><span class="p">)</span></div>


<div class="viewcode-block" id="gradient"><a class="viewcode-back" href="../../../opt.html#psi4.driver.gradient">[docs]</a><span class="k">def</span> <span class="nf">gradient</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
<span class="w">    </span><span class="sa">r</span><span class="sd">&quot;&quot;&quot;Function complementary to :py:func:`~psi4.driver.optimize()`. Carries out one gradient pass,</span>
<span class="sd">    deciding analytic or finite difference.</span>

<span class="sd">    :returns: :py:class:`~psi4.core.Matrix` |w--w| Total electronic gradient in Hartrees/Bohr.</span>

<span class="sd">    :returns: (:py:class:`~psi4.core.Matrix`, :py:class:`~psi4.core.Wavefunction`) |w--w| gradient and wavefunction when **return_wfn** specified.</span>

<span class="sd">    :examples:</span>

<span class="sd">    &gt;&gt;&gt; # [1] Single-point dft gradient getting the gradient</span>
<span class="sd">    &gt;&gt;&gt; #     in file, core.Matrix, and np.array forms</span>
<span class="sd">    &gt;&gt;&gt; set gradient_write on</span>
<span class="sd">    &gt;&gt;&gt; G, wfn = gradient(&#39;b3lyp-d&#39;, return_wfn=True)</span>
<span class="sd">    &gt;&gt;&gt; wfn.gradient().print_out()</span>
<span class="sd">    &gt;&gt;&gt; np.array(G)</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1">## First half of this fn -- entry means user wants a 1st derivative by any means</span>

    <span class="n">kwargs</span> <span class="o">=</span> <span class="n">p4util</span><span class="o">.</span><span class="n">kwargs_lower</span><span class="p">(</span><span class="n">kwargs</span><span class="p">)</span>

    <span class="n">core</span><span class="o">.</span><span class="n">print_out</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Scratch directory: </span><span class="si">%s</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">core</span><span class="o">.</span><span class="n">IOManager</span><span class="o">.</span><span class="n">shared_object</span><span class="p">()</span><span class="o">.</span><span class="n">get_default_path</span><span class="p">())</span>

    <span class="n">basisstash</span> <span class="o">=</span> <span class="n">p4util</span><span class="o">.</span><span class="n">OptionsState</span><span class="p">([</span><span class="s1">&#39;BASIS&#39;</span><span class="p">])</span>
    <span class="n">return_wfn</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s1">&#39;return_wfn&#39;</span><span class="p">,</span> <span class="kc">False</span><span class="p">)</span>

    <span class="c1"># Make sure the molecule the user provided is the active one</span>
    <span class="n">molecule</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s1">&#39;molecule&#39;</span><span class="p">,</span> <span class="n">core</span><span class="o">.</span><span class="n">get_active_molecule</span><span class="p">())</span>
    <span class="n">molecule</span><span class="o">.</span><span class="n">update_geometry</span><span class="p">()</span>

    <span class="c1"># Convert wrapper directives from options (where ppl know to find them) to kwargs (suitable for non-globals transmitting)</span>
    <span class="n">kwargs</span><span class="p">[</span><span class="s1">&#39;findif_verbose&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">core</span><span class="o">.</span><span class="n">get_option</span><span class="p">(</span><span class="s2">&quot;FINDIF&quot;</span><span class="p">,</span> <span class="s2">&quot;PRINT&quot;</span><span class="p">)</span>
    <span class="n">kwargs</span><span class="p">[</span><span class="s1">&#39;findif_stencil_size&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">core</span><span class="o">.</span><span class="n">get_option</span><span class="p">(</span><span class="s2">&quot;FINDIF&quot;</span><span class="p">,</span> <span class="s2">&quot;POINTS&quot;</span><span class="p">)</span>
    <span class="n">kwargs</span><span class="p">[</span><span class="s1">&#39;findif_step_size&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">core</span><span class="o">.</span><span class="n">get_option</span><span class="p">(</span><span class="s2">&quot;FINDIF&quot;</span><span class="p">,</span> <span class="s2">&quot;DISP_SIZE&quot;</span><span class="p">)</span>

    <span class="c1">## Pre-planning interventions</span>

    <span class="c1"># * Trip on function or alias as name</span>
    <span class="n">lowername</span> <span class="o">=</span> <span class="n">driver_util</span><span class="o">.</span><span class="n">upgrade_interventions</span><span class="p">(</span><span class="n">name</span><span class="p">)</span>
    <span class="n">_filter_renamed_methods</span><span class="p">(</span><span class="s2">&quot;gradient&quot;</span><span class="p">,</span> <span class="n">lowername</span><span class="p">)</span>

    <span class="c1"># * Prevent methods that do not have associated derivatives</span>
    <span class="k">if</span> <span class="n">lowername</span> <span class="ow">in</span> <span class="n">energy_only_methods</span><span class="p">:</span>
        <span class="k">raise</span> <span class="n">ValidationError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;`gradient(&#39;</span><span class="si">{</span><span class="n">name</span><span class="si">}</span><span class="s2">&#39;)` does not have an associated gradient.&quot;</span><span class="p">)</span>

    <span class="c1"># * Avert pydantic anger at incomplete modelchem spec</span>
    <span class="n">userbas</span> <span class="o">=</span> <span class="n">core</span><span class="o">.</span><span class="n">get_global_option</span><span class="p">(</span><span class="s1">&#39;BASIS&#39;</span><span class="p">)</span> <span class="ow">or</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;basis&#39;</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">lowername</span> <span class="ow">in</span> <span class="n">integrated_basis_methods</span> <span class="ow">and</span> <span class="n">userbas</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">kwargs</span><span class="p">[</span><span class="s1">&#39;basis&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;(auto)&#39;</span>

    <span class="c1"># Are we planning?</span>
    <span class="n">plan</span> <span class="o">=</span> <span class="n">task_planner</span><span class="o">.</span><span class="n">task_planner</span><span class="p">(</span><span class="s2">&quot;gradient&quot;</span><span class="p">,</span> <span class="n">lowername</span><span class="p">,</span> <span class="n">molecule</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;GRADIENT PLAN&#39;</span><span class="p">)</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="n">pp</span><span class="o">.</span><span class="n">pformat</span><span class="p">(</span><span class="n">plan</span><span class="o">.</span><span class="n">dict</span><span class="p">()))</span>

    <span class="k">if</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;return_plan&quot;</span><span class="p">,</span> <span class="kc">False</span><span class="p">):</span>
        <span class="c1"># Plan-only requested</span>
        <span class="k">return</span> <span class="n">plan</span>

    <span class="k">elif</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">plan</span><span class="p">,</span> <span class="n">AtomicComputer</span><span class="p">):</span>
        <span class="c1"># Advanced &quot;Computer&quot; active</span>
        <span class="n">plan</span><span class="o">.</span><span class="n">compute</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">plan</span><span class="o">.</span><span class="n">get_psi_results</span><span class="p">(</span><span class="n">return_wfn</span><span class="o">=</span><span class="n">return_wfn</span><span class="p">)</span>

    <span class="k">else</span><span class="p">:</span>
        <span class="c1"># We have unpacked to an AtomicInput</span>
        <span class="n">lowername</span> <span class="o">=</span> <span class="n">plan</span><span class="o">.</span><span class="n">method</span>
        <span class="n">basis</span> <span class="o">=</span> <span class="n">plan</span><span class="o">.</span><span class="n">basis</span>
        <span class="n">core</span><span class="o">.</span><span class="n">set_global_option</span><span class="p">(</span><span class="s2">&quot;BASIS&quot;</span><span class="p">,</span> <span class="n">basis</span><span class="p">)</span>

    <span class="c1">## Second half of this fn -- entry means program running exactly analytic 1st derivative</span>

    <span class="c1"># Set method-dependent scf convergence criteria (test on procedures[&#39;energy&#39;] since that&#39;s guaranteed)</span>
    <span class="n">optstash</span> <span class="o">=</span> <span class="n">driver_util</span><span class="o">.</span><span class="n">negotiate_convergence_criterion</span><span class="p">((</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span> <span class="n">lowername</span><span class="p">,</span> <span class="n">return_optstash</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

    <span class="c1"># Commit to procedures[] call hereafter</span>
    <span class="n">core</span><span class="o">.</span><span class="n">clean_variables</span><span class="p">()</span>

    <span class="c1"># no analytic derivatives for scf_type cd</span>
    <span class="k">if</span> <span class="n">core</span><span class="o">.</span><span class="n">get_global_option</span><span class="p">(</span><span class="s1">&#39;SCF_TYPE&#39;</span><span class="p">)</span> <span class="o">==</span> <span class="s1">&#39;CD&#39;</span><span class="p">:</span>
        <span class="k">raise</span> <span class="n">ValidationError</span><span class="p">(</span><span class="s2">&quot;&quot;&quot;No analytic derivatives for SCF_TYPE CD.&quot;&quot;&quot;</span><span class="p">)</span>

    <span class="n">core</span><span class="o">.</span><span class="n">print_out</span><span class="p">(</span><span class="s2">&quot;&quot;&quot;gradient() will perform analytic gradient computation.</span><span class="se">\n</span><span class="s2">&quot;&quot;&quot;</span><span class="p">)</span>

    <span class="c1"># Perform the gradient calculation</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Compute gradient(): method=</span><span class="si">{</span><span class="n">lowername</span><span class="si">}</span><span class="s2">, basis=</span><span class="si">{</span><span class="n">core</span><span class="o">.</span><span class="n">get_global_option</span><span class="p">(</span><span class="s1">&#39;BASIS&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span><span class="si">}</span><span class="s2">, molecule=</span><span class="si">{</span><span class="n">molecule</span><span class="o">.</span><span class="n">name</span><span class="p">()</span><span class="si">}</span><span class="s2">, nre=</span><span class="si">{</span><span class="s1">&#39;w/EFP&#39;</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="nb">hasattr</span><span class="p">(</span><span class="n">molecule</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;EFP&#39;</span><span class="p">)</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="n">molecule</span><span class="o">.</span><span class="n">nuclear_repulsion_energy</span><span class="p">()</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;w/EFP&quot;</span> <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">molecule</span><span class="p">,</span> <span class="s2">&quot;EFP&quot;</span><span class="p">)</span> <span class="k">else</span> <span class="n">pp</span><span class="o">.</span><span class="n">pformat</span><span class="p">(</span><span class="n">molecule</span><span class="o">.</span><span class="n">to_dict</span><span class="p">()))</span>
    <span class="n">wfn</span> <span class="o">=</span> <span class="n">procedures</span><span class="p">[</span><span class="s1">&#39;gradient&#39;</span><span class="p">][</span><span class="n">lowername</span><span class="p">](</span><span class="n">lowername</span><span class="p">,</span> <span class="n">molecule</span><span class="o">=</span><span class="n">molecule</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Return gradient(): </span><span class="si">{</span><span class="n">core</span><span class="o">.</span><span class="n">variable</span><span class="p">(</span><span class="s1">&#39;CURRENT ENERGY&#39;</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="n">nppp</span><span class="p">(</span><span class="n">wfn</span><span class="o">.</span><span class="n">gradient</span><span class="p">()</span><span class="o">.</span><span class="n">np</span><span class="p">))</span>

    <span class="n">basisstash</span><span class="o">.</span><span class="n">restore</span><span class="p">()</span>
    <span class="n">optstash</span><span class="o">.</span><span class="n">restore</span><span class="p">()</span>

    <span class="n">driver_findif</span><span class="o">.</span><span class="n">gradient_write</span><span class="p">(</span><span class="n">wfn</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">return_wfn</span><span class="p">:</span>
        <span class="k">return</span> <span class="p">(</span><span class="n">wfn</span><span class="o">.</span><span class="n">gradient</span><span class="p">(),</span> <span class="n">wfn</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">wfn</span><span class="o">.</span><span class="n">gradient</span><span class="p">()</span></div>


<div class="viewcode-block" id="properties"><a class="viewcode-back" href="../../../prop.html#psi4.driver.properties">[docs]</a><span class="k">def</span> <span class="nf">properties</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
<span class="w">    </span><span class="sa">r</span><span class="sd">&quot;&quot;&quot;Function to compute various properties.</span>

<span class="sd">    :aliases: prop()</span>

<span class="sd">    :returns: none.</span>

<span class="sd">    .. caution:: Some features are not yet implemented. Buy a developer a coffee.</span>

<span class="sd">       - This function at present has a limited functionality.</span>
<span class="sd">         Consult the keywords sections of other modules for further property capabilities.</span>

<span class="sd">    +--------------------+-----------------------------------------------+----------------+---------------------------------------------------------------+</span>
<span class="sd">    | Name               | Calls Method                                  | Reference      | Supported Properties                                          |</span>
<span class="sd">    +====================+===============================================+================+===============================================================+</span>
<span class="sd">    | scf                | Self-consistent field method(s)               | RHF/ROHF/UHF   | Listed :ref:`here &lt;sec:oeprop&gt;`                               |</span>
<span class="sd">    +--------------------+-----------------------------------------------+----------------+---------------------------------------------------------------+</span>
<span class="sd">    | hf                 | HF Self-consistent field method(s)            | RHF/ROHF/UHF   | Listed :ref:`here &lt;sec:oeprop&gt;`                               |</span>
<span class="sd">    +--------------------+-----------------------------------------------+----------------+---------------------------------------------------------------+</span>
<span class="sd">    | mp2                | MP2 with density fitting only (mp2_type df)   | RHF            | Listed :ref:`here &lt;sec:oeprop&gt;`                               |</span>
<span class="sd">    +--------------------+-----------------------------------------------+----------------+---------------------------------------------------------------+</span>
<span class="sd">    | cc2                | 2nd-order approximate CCSD                    | RHF            | dipole, quadrupole, polarizability, rotation, roa_tensor      |</span>
<span class="sd">    +--------------------+-----------------------------------------------+----------------+---------------------------------------------------------------+</span>
<span class="sd">    | ccsd               | Coupled cluster singles and doubles (CCSD)    | RHF            | dipole, quadrupole, polarizability, rotation, roa_tensor      |</span>
<span class="sd">    +--------------------+-----------------------------------------------+----------------+---------------------------------------------------------------+</span>
<span class="sd">    | dct                | density cumulant (functional) theory          | RHF/UHF        | Listed :ref:`here &lt;sec:oeprop&gt;`                               |</span>
<span class="sd">    |                    | :ref:`[manual] &lt;sec:dct&gt;`                     |                |                                                               |</span>
<span class="sd">    +--------------------+-----------------------------------------------+----------------+---------------------------------------------------------------+</span>
<span class="sd">    | omp2               | orbital-optimized second-order                | RHF/UHF        | Listed :ref:`here &lt;sec:oeprop&gt;`                               |</span>
<span class="sd">    |                    | MP perturbation theory                        |                | Density fitted only                                           |</span>
<span class="sd">    |                    | :ref:`[manual] &lt;sec:occ_oo&gt;`                  |                |                                                               |</span>
<span class="sd">    +--------------------+-----------------------------------------------+----------------+---------------------------------------------------------------+</span>
<span class="sd">    | omp3               | orbital-optimized third-order                 | RHF/UHF        | Listed :ref:`here &lt;sec:oeprop&gt;`                               |</span>
<span class="sd">    |                    | MP perturbation theory                        |                | Density fitted only                                           |</span>
<span class="sd">    |                    | :ref:`[manual] &lt;sec:occ_oo&gt;`                  |                |                                                               |</span>
<span class="sd">    +--------------------+-----------------------------------------------+----------------+---------------------------------------------------------------+</span>
<span class="sd">    | omp2.5             | orbital-optimized MP2.5                       | RHF/UHF        | Listed :ref:`here &lt;sec:oeprop&gt;`                               |</span>
<span class="sd">    |                    | :ref:`[manual] &lt;sec:occ_oo&gt;`                  |                | Density fitted only                                           |</span>
<span class="sd">    +--------------------+-----------------------------------------------+----------------+---------------------------------------------------------------+</span>
<span class="sd">    | olccd              | orbital optimized LCCD                        | RHF/UHF        | Listed :ref:`here &lt;sec:oeprop&gt;`                               |</span>
<span class="sd">    |                    | :ref:`[manual] &lt;sec:occ_oo&gt;`                  |                | Density fitted only                                           |</span>
<span class="sd">    +--------------------+-----------------------------------------------+----------------+---------------------------------------------------------------+</span>
<span class="sd">    | eom-cc2            | 2nd-order approximate EOM-CCSD                | RHF            | oscillator_strength, rotational_strength                      |</span>
<span class="sd">    +--------------------+-----------------------------------------------+----------------+---------------------------------------------------------------+</span>
<span class="sd">    | eom-ccsd           | Equation-of-motion CCSD (EOM-CCSD)            | RHF            | oscillator_strength, rotational_strength                      |</span>
<span class="sd">    +--------------------+-----------------------------------------------+----------------+---------------------------------------------------------------+</span>
<span class="sd">    | cisd, cisdt,       | Configuration interaction                     | RHF/ROHF       | Listed :ref:`here &lt;sec:oeprop&gt;`, transition_dipole,           |</span>
<span class="sd">    | cisdt, cisdtq,     |                                               |                | transition_quadrupole                                         |</span>
<span class="sd">    | ci5, ..., fci      |                                               |                |                                                               |</span>
<span class="sd">    +--------------------+-----------------------------------------------+----------------+---------------------------------------------------------------+</span>
<span class="sd">    | casscf, rasscf     | Multi-configurational SCF                     | RHF/ROHF       | Listed :ref:`here &lt;sec:oeprop&gt;`, transition_dipole,           |</span>
<span class="sd">    |                    |                                               |                | transition_quadrupole                                         |</span>
<span class="sd">    +--------------------+-----------------------------------------------+----------------+---------------------------------------------------------------+</span>
<span class="sd">    | adc(0), adc(1),    | Algebraic-diagrammatic construction methods   | RHF/UHF        | dipole, transition_dipole, oscillator_strength,               |</span>
<span class="sd">    | ..., adc(3),       | :ref:`[manual] &lt;sec:adc&gt;`                     |                | rotational_strength                                           |</span>
<span class="sd">    | cvs-adc(0), ...    |                                               |                |                                                               |</span>
<span class="sd">    | cvs-adc(3)         |                                               |                |                                                               |</span>
<span class="sd">    +--------------------+-----------------------------------------------+----------------+---------------------------------------------------------------+</span>

<span class="sd">    :type name: str</span>
<span class="sd">    :param name: ``&#39;ccsd&#39;`` || etc.</span>

<span class="sd">        First argument, usually unlabeled. Indicates the computational method</span>
<span class="sd">        to be applied to the system.</span>

<span class="sd">    :type properties: List[str]</span>
<span class="sd">    :param properties: |dl| ``[]`` |dr| || ``[&#39;rotation&#39;, &#39;polarizability&#39;, &#39;oscillator_strength&#39;, &#39;roa&#39;]`` || etc.</span>

<span class="sd">        Indicates which properties should be computed. Defaults to dipole and quadrupole.</span>

<span class="sd">    :type molecule: :ref:`molecule &lt;op_py_molecule&gt;`</span>
<span class="sd">    :param molecule: ``h2o`` || etc.</span>

<span class="sd">        The target molecule, if not the last molecule defined.</span>

<span class="sd">    :examples:</span>

<span class="sd">    &gt;&gt;&gt; # [1] Optical rotation calculation</span>
<span class="sd">    &gt;&gt;&gt; properties(&#39;cc2&#39;, properties=[&#39;rotation&#39;])</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">kwargs</span> <span class="o">=</span> <span class="n">p4util</span><span class="o">.</span><span class="n">kwargs_lower</span><span class="p">(</span><span class="n">kwargs</span><span class="p">)</span>

    <span class="n">basisstash</span> <span class="o">=</span> <span class="n">p4util</span><span class="o">.</span><span class="n">OptionsState</span><span class="p">([</span><span class="s1">&#39;BASIS&#39;</span><span class="p">])</span>
    <span class="n">return_wfn</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s1">&#39;return_wfn&#39;</span><span class="p">,</span> <span class="kc">False</span><span class="p">)</span>

    <span class="c1"># Make sure the molecule the user provided is the active one</span>
    <span class="n">molecule</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s1">&#39;molecule&#39;</span><span class="p">,</span> <span class="n">core</span><span class="o">.</span><span class="n">get_active_molecule</span><span class="p">())</span>
    <span class="n">molecule</span><span class="o">.</span><span class="n">update_geometry</span><span class="p">()</span>

    <span class="c1">## Pre-planning interventions</span>

    <span class="c1"># * Trip on function or alias as name</span>
    <span class="n">lowername</span> <span class="o">=</span> <span class="n">driver_util</span><span class="o">.</span><span class="n">upgrade_interventions</span><span class="p">(</span><span class="n">args</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>

    <span class="n">_filter_renamed_methods</span><span class="p">(</span><span class="s2">&quot;properties&quot;</span><span class="p">,</span> <span class="n">lowername</span><span class="p">)</span>

    <span class="n">props</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;properties&#39;</span><span class="p">,</span> <span class="p">[</span><span class="s1">&#39;dipole&#39;</span><span class="p">,</span> <span class="s1">&#39;quadrupole&#39;</span><span class="p">])</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">args</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
        <span class="n">props</span> <span class="o">+=</span> <span class="n">args</span><span class="p">[</span><span class="mi">1</span><span class="p">:]</span>
    <span class="n">kwargs</span><span class="p">[</span><span class="s1">&#39;properties&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">p4util</span><span class="o">.</span><span class="n">drop_duplicates</span><span class="p">(</span><span class="n">props</span><span class="p">)</span>

    <span class="c1"># * Avert pydantic anger at incomplete modelchem spec</span>
    <span class="n">userbas</span> <span class="o">=</span> <span class="n">core</span><span class="o">.</span><span class="n">get_global_option</span><span class="p">(</span><span class="s1">&#39;BASIS&#39;</span><span class="p">)</span> <span class="ow">or</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;basis&#39;</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">lowername</span> <span class="ow">in</span> <span class="n">integrated_basis_methods</span> <span class="ow">and</span> <span class="n">userbas</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">kwargs</span><span class="p">[</span><span class="s1">&#39;basis&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;(auto)&#39;</span>

    <span class="c1"># Are we planning?</span>
    <span class="n">plan</span> <span class="o">=</span> <span class="n">task_planner</span><span class="o">.</span><span class="n">task_planner</span><span class="p">(</span><span class="s2">&quot;properties&quot;</span><span class="p">,</span> <span class="n">lowername</span><span class="p">,</span> <span class="n">molecule</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;PROPERTIES PLAN&#39;</span><span class="p">)</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="n">pp</span><span class="o">.</span><span class="n">pformat</span><span class="p">(</span><span class="n">plan</span><span class="o">.</span><span class="n">dict</span><span class="p">()))</span>

    <span class="k">if</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;return_plan&quot;</span><span class="p">,</span> <span class="kc">False</span><span class="p">):</span>
        <span class="c1"># Plan-only requested</span>
        <span class="k">return</span> <span class="n">plan</span>

    <span class="k">elif</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">plan</span><span class="p">,</span> <span class="n">AtomicComputer</span><span class="p">):</span>
        <span class="c1"># Advanced &quot;Computer&quot; active</span>
        <span class="n">plan</span><span class="o">.</span><span class="n">compute</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">plan</span><span class="o">.</span><span class="n">get_psi_results</span><span class="p">(</span><span class="n">return_wfn</span><span class="o">=</span><span class="n">return_wfn</span><span class="p">)</span>

    <span class="k">else</span><span class="p">:</span>
        <span class="c1"># We have unpacked to an AtomicInput</span>
        <span class="n">lowername</span> <span class="o">=</span> <span class="n">plan</span><span class="o">.</span><span class="n">method</span>
        <span class="n">basis</span> <span class="o">=</span> <span class="n">plan</span><span class="o">.</span><span class="n">basis</span>
        <span class="n">core</span><span class="o">.</span><span class="n">set_global_option</span><span class="p">(</span><span class="s2">&quot;BASIS&quot;</span><span class="p">,</span> <span class="n">basis</span><span class="p">)</span>

    <span class="c1">## Second half of this fn -- entry means program running exactly analytic property</span>

    <span class="c1"># Commit to procedures[&#39;properties&#39;] call hereafter</span>
    <span class="n">core</span><span class="o">.</span><span class="n">clean_variables</span><span class="p">()</span>

    <span class="c1"># needed (+restore below) so long as AtomicComputer-s aren&#39;t run through json (where convcrit also lives)</span>
    <span class="n">optstash</span> <span class="o">=</span> <span class="n">driver_util</span><span class="o">.</span><span class="n">negotiate_convergence_criterion</span><span class="p">((</span><span class="s2">&quot;prop&quot;</span><span class="p">,</span> <span class="s2">&quot;prop&quot;</span><span class="p">),</span> <span class="n">lowername</span><span class="p">,</span> <span class="n">return_optstash</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Compute properties(): method=</span><span class="si">{</span><span class="n">lowername</span><span class="si">}</span><span class="s2">, basis=</span><span class="si">{</span><span class="n">core</span><span class="o">.</span><span class="n">get_global_option</span><span class="p">(</span><span class="s1">&#39;BASIS&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span><span class="si">}</span><span class="s2">, molecule=</span><span class="si">{</span><span class="n">molecule</span><span class="o">.</span><span class="n">name</span><span class="p">()</span><span class="si">}</span><span class="s2">, nre=</span><span class="si">{</span><span class="s1">&#39;w/EFP&#39;</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="nb">hasattr</span><span class="p">(</span><span class="n">molecule</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;EFP&#39;</span><span class="p">)</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="n">molecule</span><span class="o">.</span><span class="n">nuclear_repulsion_energy</span><span class="p">()</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;w/EFP&quot;</span> <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">molecule</span><span class="p">,</span> <span class="s2">&quot;EFP&quot;</span><span class="p">)</span> <span class="k">else</span> <span class="n">pp</span><span class="o">.</span><span class="n">pformat</span><span class="p">(</span><span class="n">molecule</span><span class="o">.</span><span class="n">to_dict</span><span class="p">()))</span>
    <span class="n">wfn</span> <span class="o">=</span> <span class="n">procedures</span><span class="p">[</span><span class="s2">&quot;properties&quot;</span><span class="p">][</span><span class="n">lowername</span><span class="p">](</span><span class="n">lowername</span><span class="p">,</span> <span class="n">molecule</span><span class="o">=</span><span class="n">molecule</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Return properties(): </span><span class="si">{</span><span class="n">core</span><span class="o">.</span><span class="n">variable</span><span class="p">(</span><span class="s1">&#39;CURRENT ENERGY&#39;</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

    <span class="n">basisstash</span><span class="o">.</span><span class="n">restore</span><span class="p">()</span>
    <span class="n">optstash</span><span class="o">.</span><span class="n">restore</span><span class="p">()</span>

    <span class="k">if</span> <span class="n">return_wfn</span><span class="p">:</span>
        <span class="k">return</span> <span class="p">(</span><span class="n">core</span><span class="o">.</span><span class="n">variable</span><span class="p">(</span><span class="s1">&#39;CURRENT ENERGY&#39;</span><span class="p">),</span> <span class="n">wfn</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">core</span><span class="o">.</span><span class="n">variable</span><span class="p">(</span><span class="s1">&#39;CURRENT ENERGY&#39;</span><span class="p">)</span></div>


<div class="viewcode-block" id="optimize_geometric"><a class="viewcode-back" href="../../../api/psi4.driver.optimize_geometric.html#psi4.driver.optimize_geometric">[docs]</a><span class="k">def</span> <span class="nf">optimize_geometric</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>

    <span class="kn">import</span> <span class="nn">qcelemental</span> <span class="k">as</span> <span class="nn">qcel</span>
    <span class="kn">from</span> <span class="nn">qcelemental.util</span> <span class="kn">import</span> <span class="n">which_import</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="n">which_import</span><span class="p">(</span><span class="s1">&#39;geometric&#39;</span><span class="p">,</span> <span class="n">return_bool</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
        <span class="k">raise</span> <span class="ne">ModuleNotFoundError</span><span class="p">(</span><span class="s1">&#39;Python module geometric not found. Solve by installing it: `conda install -c conda-forge geometric` or `pip install geometric`&#39;</span><span class="p">)</span>
    <span class="kn">import</span> <span class="nn">geometric</span>

    <span class="k">class</span> <span class="nc">Psi4NativeEngine</span><span class="p">(</span><span class="n">geometric</span><span class="o">.</span><span class="n">engine</span><span class="o">.</span><span class="n">Engine</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Internally run an energy and gradient calculation for geometric </span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">p4_name</span><span class="p">,</span> <span class="n">p4_mol</span><span class="p">,</span> <span class="n">p4_return_wfn</span><span class="p">,</span> <span class="o">**</span><span class="n">p4_kwargs</span><span class="p">):</span>
    
            <span class="bp">self</span><span class="o">.</span><span class="n">p4_name</span> <span class="o">=</span> <span class="n">p4_name</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">p4_mol</span> <span class="o">=</span> <span class="n">p4_mol</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">p4_return_wfn</span> <span class="o">=</span> <span class="n">p4_return_wfn</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">p4_kwargs</span> <span class="o">=</span> <span class="n">p4_kwargs</span>
    
            <span class="n">molecule</span> <span class="o">=</span> <span class="n">geometric</span><span class="o">.</span><span class="n">molecule</span><span class="o">.</span><span class="n">Molecule</span><span class="p">()</span>
            <span class="n">molecule</span><span class="o">.</span><span class="n">elem</span> <span class="o">=</span> <span class="p">[</span><span class="n">p4_mol</span><span class="o">.</span><span class="n">symbol</span><span class="p">(</span><span class="n">i</span><span class="p">)</span><span class="o">.</span><span class="n">capitalize</span><span class="p">()</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">p4_mol</span><span class="o">.</span><span class="n">natom</span><span class="p">())]</span>
            <span class="n">molecule</span><span class="o">.</span><span class="n">xyzs</span> <span class="o">=</span> <span class="p">[</span><span class="n">p4_mol</span><span class="o">.</span><span class="n">geometry</span><span class="p">()</span><span class="o">.</span><span class="n">np</span> <span class="o">*</span> <span class="n">qcel</span><span class="o">.</span><span class="n">constants</span><span class="o">.</span><span class="n">bohr2angstroms</span><span class="p">]</span> 
            <span class="n">molecule</span><span class="o">.</span><span class="n">build_bonds</span><span class="p">()</span>
                                 
            <span class="nb">super</span><span class="p">(</span><span class="n">Psi4NativeEngine</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">molecule</span><span class="p">)</span>
    
        <span class="k">def</span> <span class="nf">calc</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">coords</span><span class="p">,</span> <span class="n">dirname</span><span class="p">,</span> <span class="n">read_data</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">p4_mol</span><span class="o">.</span><span class="n">set_geometry</span><span class="p">(</span><span class="n">core</span><span class="o">.</span><span class="n">Matrix</span><span class="o">.</span><span class="n">from_array</span><span class="p">(</span><span class="n">coords</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="mi">3</span><span class="p">)))</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">p4_mol</span><span class="o">.</span><span class="n">update_geometry</span><span class="p">()</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">p4_return_wfn</span><span class="p">:</span>
                <span class="n">g</span><span class="p">,</span> <span class="n">wfn</span> <span class="o">=</span> <span class="n">gradient</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">p4_name</span><span class="p">,</span> <span class="n">return_wfn</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">molecule</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">p4_mol</span><span class="p">,</span> <span class="o">**</span><span class="bp">self</span><span class="o">.</span><span class="n">p4_kwargs</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">p4_wfn</span> <span class="o">=</span> <span class="n">wfn</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">g</span> <span class="o">=</span> <span class="n">gradient</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">p4_name</span><span class="p">,</span> <span class="n">return_wfn</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">molecule</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">p4_mol</span><span class="p">,</span> <span class="o">**</span><span class="bp">self</span><span class="o">.</span><span class="n">p4_kwargs</span><span class="p">)</span>
            <span class="n">e</span> <span class="o">=</span> <span class="n">core</span><span class="o">.</span><span class="n">variable</span><span class="p">(</span><span class="s1">&#39;CURRENT ENERGY&#39;</span><span class="p">)</span>
            <span class="k">return</span> <span class="p">{</span><span class="s1">&#39;energy&#39;</span><span class="p">:</span> <span class="n">e</span><span class="p">,</span> <span class="s1">&#39;gradient&#39;</span><span class="p">:</span> <span class="n">g</span><span class="o">.</span><span class="n">np</span><span class="o">.</span><span class="n">ravel</span><span class="p">()}</span>

    <span class="n">return_wfn</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s1">&#39;return_wfn&#39;</span><span class="p">,</span> <span class="kc">False</span><span class="p">)</span>
    <span class="n">return_history</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s1">&#39;return_history&#39;</span><span class="p">,</span> <span class="kc">False</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">return_history</span><span class="p">:</span>
        <span class="n">step_energies</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">step_gradients</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">step_coordinates</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="c1"># Make sure the molecule the user provided is the active one</span>
    <span class="n">molecule</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s1">&#39;molecule&#39;</span><span class="p">,</span> <span class="n">core</span><span class="o">.</span><span class="n">get_active_molecule</span><span class="p">())</span>

    <span class="c1"># Do not change orientation or COM</span>
    <span class="n">molecule</span><span class="o">.</span><span class="n">fix_orientation</span><span class="p">(</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">molecule</span><span class="o">.</span><span class="n">fix_com</span><span class="p">(</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">molecule</span><span class="o">.</span><span class="n">update_geometry</span><span class="p">()</span>

    <span class="c1"># Get geometric-specific options</span>
    <span class="n">optimizer_keywords</span> <span class="o">=</span> <span class="p">{</span><span class="n">k</span><span class="o">.</span><span class="n">lower</span><span class="p">():</span> <span class="n">v</span> <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;optimizer_keywords&quot;</span><span class="p">,</span> <span class="p">{})</span><span class="o">.</span><span class="n">items</span><span class="p">()}</span>

    <span class="n">core</span><span class="o">.</span><span class="n">print_out</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
    <span class="n">core</span><span class="o">.</span><span class="n">print_out</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">  ==&gt; GeomeTRIC Optimizer &lt;==                                                                   ~</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
                                 
    <span class="c1"># Default to Psi4 maxiter unless overridden</span>
    <span class="k">if</span> <span class="s1">&#39;maxiter&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">optimizer_keywords</span><span class="p">:</span>
        <span class="n">optimizer_keywords</span><span class="p">[</span><span class="s1">&#39;maxiter&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">core</span><span class="o">.</span><span class="n">get_global_option</span><span class="p">(</span><span class="s1">&#39;GEOM_MAXITER&#39;</span><span class="p">)</span>

    <span class="c1"># Default to Psi4 geometry convergence criteria unless overridden </span>
    <span class="k">if</span> <span class="s1">&#39;convergence_set&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">optimizer_keywords</span><span class="p">:</span>
        <span class="n">optimizer_keywords</span><span class="p">[</span><span class="s1">&#39;convergence_set&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">core</span><span class="o">.</span><span class="n">get_global_option</span><span class="p">(</span><span class="s1">&#39;G_CONVERGENCE&#39;</span><span class="p">)</span>

        <span class="c1"># GeomeTRIC doesn&#39;t know these convergence criterion</span>
        <span class="k">if</span> <span class="n">optimizer_keywords</span><span class="p">[</span><span class="s1">&#39;convergence_set&#39;</span><span class="p">]</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;CFOUR&#39;</span><span class="p">,</span> <span class="s1">&#39;QCHEM&#39;</span><span class="p">,</span> <span class="s1">&#39;MOLPRO&#39;</span><span class="p">]:</span>
            <span class="n">core</span><span class="o">.</span><span class="n">print_out</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">  Psi4 convergence criteria </span><span class="si">{</span><span class="n">optimizer_keywords</span><span class="p">[</span><span class="s1">&#39;convergence_set&#39;</span><span class="p">]</span><span class="si">:</span><span class="s2">6s</span><span class="si">}</span><span class="s2"> not recognized by GeomeTRIC, switching to GAU_TIGHT          ~&quot;</span><span class="p">)</span>
            <span class="n">optimizer_keywords</span><span class="p">[</span><span class="s1">&#39;convergence_set&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;GAU_TIGHT&#39;</span>

    <span class="n">engine</span> <span class="o">=</span> <span class="n">Psi4NativeEngine</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">molecule</span><span class="p">,</span> <span class="n">return_wfn</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
    <span class="n">M</span> <span class="o">=</span> <span class="n">engine</span><span class="o">.</span><span class="n">M</span>
    
    <span class="c1"># Handle constraints</span>
    <span class="n">constraints_dict</span> <span class="o">=</span> <span class="p">{</span><span class="n">k</span><span class="o">.</span><span class="n">lower</span><span class="p">():</span> <span class="n">v</span> <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">optimizer_keywords</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;constraints&quot;</span><span class="p">,</span> <span class="p">{})</span><span class="o">.</span><span class="n">items</span><span class="p">()}</span>
    <span class="n">constraints_string</span> <span class="o">=</span> <span class="n">geometric</span><span class="o">.</span><span class="n">run_json</span><span class="o">.</span><span class="n">make_constraints_string</span><span class="p">(</span><span class="n">constraints_dict</span><span class="p">)</span>
    <span class="n">Cons</span><span class="p">,</span> <span class="n">CVals</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span>
    <span class="k">if</span> <span class="n">constraints_string</span><span class="p">:</span>
        <span class="k">if</span> <span class="s1">&#39;scan&#39;</span> <span class="ow">in</span> <span class="n">constraints_dict</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Coordinate scans are not yet available through the Psi4-GeomeTRIC interface&quot;</span><span class="p">)</span>
        <span class="n">Cons</span><span class="p">,</span> <span class="n">CVals</span> <span class="o">=</span> <span class="n">geometric</span><span class="o">.</span><span class="n">prepare</span><span class="o">.</span><span class="n">parse_constraints</span><span class="p">(</span><span class="n">M</span><span class="p">,</span> <span class="n">constraints_string</span><span class="p">)</span>
    
    <span class="c1"># Set up the internal coordinate system</span>
    <span class="n">coordsys</span> <span class="o">=</span> <span class="n">optimizer_keywords</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;coordsys&#39;</span><span class="p">,</span> <span class="s1">&#39;tric&#39;</span><span class="p">)</span>
    <span class="n">CoordSysDict</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s1">&#39;cart&#39;</span><span class="p">:</span> <span class="p">(</span><span class="n">geometric</span><span class="o">.</span><span class="n">internal</span><span class="o">.</span><span class="n">CartesianCoordinates</span><span class="p">,</span> <span class="kc">False</span><span class="p">,</span> <span class="kc">False</span><span class="p">),</span>
        <span class="s1">&#39;prim&#39;</span><span class="p">:</span> <span class="p">(</span><span class="n">geometric</span><span class="o">.</span><span class="n">internal</span><span class="o">.</span><span class="n">PrimitiveInternalCoordinates</span><span class="p">,</span> <span class="kc">True</span><span class="p">,</span> <span class="kc">False</span><span class="p">),</span>
        <span class="s1">&#39;dlc&#39;</span><span class="p">:</span> <span class="p">(</span><span class="n">geometric</span><span class="o">.</span><span class="n">internal</span><span class="o">.</span><span class="n">DelocalizedInternalCoordinates</span><span class="p">,</span> <span class="kc">True</span><span class="p">,</span> <span class="kc">False</span><span class="p">),</span>
        <span class="s1">&#39;hdlc&#39;</span><span class="p">:</span> <span class="p">(</span><span class="n">geometric</span><span class="o">.</span><span class="n">internal</span><span class="o">.</span><span class="n">DelocalizedInternalCoordinates</span><span class="p">,</span> <span class="kc">False</span><span class="p">,</span> <span class="kc">True</span><span class="p">),</span>
        <span class="s1">&#39;tric&#39;</span><span class="p">:</span> <span class="p">(</span><span class="n">geometric</span><span class="o">.</span><span class="n">internal</span><span class="o">.</span><span class="n">DelocalizedInternalCoordinates</span><span class="p">,</span> <span class="kc">False</span><span class="p">,</span> <span class="kc">False</span><span class="p">)</span>
    <span class="p">}</span>
    
    <span class="c1"># Build internal coordinates</span>
    <span class="n">CoordClass</span><span class="p">,</span> <span class="n">connect</span><span class="p">,</span> <span class="n">addcart</span> <span class="o">=</span> <span class="n">CoordSysDict</span><span class="p">[</span><span class="n">coordsys</span><span class="o">.</span><span class="n">lower</span><span class="p">()]</span>
    <span class="n">IC</span> <span class="o">=</span> <span class="n">CoordClass</span><span class="p">(</span>
        <span class="n">M</span><span class="p">,</span>
        <span class="n">build</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
        <span class="n">connect</span><span class="o">=</span><span class="n">connect</span><span class="p">,</span>
        <span class="n">addcart</span><span class="o">=</span><span class="n">addcart</span><span class="p">,</span>
        <span class="n">constraints</span><span class="o">=</span><span class="n">Cons</span><span class="p">,</span>
        <span class="n">cvals</span><span class="o">=</span><span class="n">CVals</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="k">if</span> <span class="n">CVals</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span> <span class="kc">None</span><span class="p">)</span>
    
    <span class="c1"># Get initial coordinates in bohr</span>
    <span class="n">coords</span> <span class="o">=</span> <span class="n">M</span><span class="o">.</span><span class="n">xyzs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">flatten</span><span class="p">()</span> <span class="o">/</span> <span class="n">qcel</span><span class="o">.</span><span class="n">constants</span><span class="o">.</span><span class="n">bohr2angstroms</span>

    <span class="c1"># Setup an optimizer object</span>
    <span class="n">params</span> <span class="o">=</span> <span class="n">geometric</span><span class="o">.</span><span class="n">optimize</span><span class="o">.</span><span class="n">OptParams</span><span class="p">(</span><span class="o">**</span><span class="n">optimizer_keywords</span><span class="p">)</span>
    <span class="n">optimizer</span> <span class="o">=</span> <span class="n">geometric</span><span class="o">.</span><span class="n">optimize</span><span class="o">.</span><span class="n">Optimizer</span><span class="p">(</span><span class="n">coords</span><span class="p">,</span> <span class="n">M</span><span class="p">,</span> <span class="n">IC</span><span class="p">,</span> <span class="n">engine</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="n">params</span><span class="p">)</span>
    
    <span class="c1"># TODO: print constraints</span>
    <span class="c1"># IC.printConstraints(coords, thre=-1)</span>
    <span class="n">optimizer</span><span class="o">.</span><span class="n">calcEnergyForce</span><span class="p">()</span>
    <span class="n">optimizer</span><span class="o">.</span><span class="n">prepareFirstStep</span><span class="p">()</span>
    <span class="n">grms</span><span class="p">,</span> <span class="n">gmax</span> <span class="o">=</span> <span class="n">optimizer</span><span class="o">.</span><span class="n">calcGradNorm</span><span class="p">()</span>
    <span class="n">conv_gmax</span> <span class="o">=</span> <span class="s1">&#39;*&#39;</span> <span class="k">if</span> <span class="n">gmax</span> <span class="o">&lt;</span> <span class="n">params</span><span class="o">.</span><span class="n">Convergence_gmax</span> <span class="k">else</span> <span class="s1">&#39; &#39;</span>
    <span class="n">conv_grms</span> <span class="o">=</span> <span class="s1">&#39;*&#39;</span> <span class="k">if</span> <span class="n">grms</span> <span class="o">&lt;</span> <span class="n">params</span><span class="o">.</span><span class="n">Convergence_grms</span> <span class="k">else</span> <span class="s1">&#39; &#39;</span>
    <span class="n">core</span><span class="o">.</span><span class="n">print_out</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">  Measures of convergence in internal coordinates in au.                                        ~&quot;</span><span class="p">)</span>
    <span class="n">core</span><span class="o">.</span><span class="n">print_out</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">  Criteria marked as inactive (o), active &amp; met (*), and active &amp; unmet ( ).                    ~&quot;</span><span class="p">)</span>
    <span class="n">core</span><span class="o">.</span><span class="n">print_out</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">  --------------------------------------------------------------------------------------------- ~&quot;</span><span class="p">)</span>
    <span class="n">core</span><span class="o">.</span><span class="n">print_out</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">   Step     Total Energy     Delta E     MAX Force     RMS Force      MAX Disp      RMS Disp    ~&quot;</span><span class="p">)</span>
    <span class="n">core</span><span class="o">.</span><span class="n">print_out</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">  --------------------------------------------------------------------------------------------- ~&quot;</span><span class="p">)</span>
    <span class="n">core</span><span class="o">.</span><span class="n">print_out</span><span class="p">((</span><span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">    Convergence Criteria  </span><span class="si">{</span><span class="n">params</span><span class="o">.</span><span class="n">Convergence_energy</span><span class="si">:</span><span class="s2">10.2e</span><span class="si">}</span><span class="s2">    &quot;</span>
                    <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">params</span><span class="o">.</span><span class="n">Convergence_gmax</span><span class="si">:</span><span class="s2">10.2e</span><span class="si">}</span><span class="s2">    </span><span class="si">{</span><span class="n">params</span><span class="o">.</span><span class="n">Convergence_grms</span><span class="si">:</span><span class="s2">10.2e</span><span class="si">}</span><span class="s2">    &quot;</span>
                    <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">params</span><span class="o">.</span><span class="n">Convergence_dmax</span><span class="si">:</span><span class="s2">10.2e</span><span class="si">}</span><span class="s2">    </span><span class="si">{</span><span class="n">params</span><span class="o">.</span><span class="n">Convergence_drms</span><span class="si">:</span><span class="s2">10.2e</span><span class="si">}</span><span class="s2">    ~&quot;</span><span class="p">))</span>
    <span class="n">core</span><span class="o">.</span><span class="n">print_out</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">  --------------------------------------------------------------------------------------------- ~&quot;</span><span class="p">)</span>

    <span class="n">core</span><span class="o">.</span><span class="n">print_out</span><span class="p">((</span><span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">   </span><span class="si">{</span><span class="n">optimizer</span><span class="o">.</span><span class="n">Iteration</span><span class="si">:</span><span class="s2">4d</span><span class="si">}</span><span class="s2"> </span><span class="si">{</span><span class="n">optimizer</span><span class="o">.</span><span class="n">E</span><span class="si">:</span><span class="s2">16.8e</span><span class="si">}</span><span class="s2">    --------    &quot;</span>
                    <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">gmax</span><span class="si">:</span><span class="s2">10.2e</span><span class="si">}</span><span class="s2"> </span><span class="si">{</span><span class="n">conv_gmax</span><span class="si">}</span><span class="s2">  </span><span class="si">{</span><span class="n">grms</span><span class="si">:</span><span class="s2">10.2e</span><span class="si">}</span><span class="s2"> </span><span class="si">{</span><span class="n">conv_grms</span><span class="si">}</span><span class="s2">    --------      --------    ~&quot;</span><span class="p">))</span>
    <span class="k">while</span> <span class="kc">True</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">optimizer</span><span class="o">.</span><span class="n">state</span> <span class="o">==</span> <span class="n">geometric</span><span class="o">.</span><span class="n">optimize</span><span class="o">.</span><span class="n">OPT_STATE</span><span class="o">.</span><span class="n">CONVERGED</span><span class="p">:</span>
            <span class="n">core</span><span class="o">.</span><span class="n">print_out</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n\n</span><span class="s2">  Optimization converged!                                                                       ~</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="k">break</span>
        <span class="k">elif</span> <span class="n">optimizer</span><span class="o">.</span><span class="n">state</span> <span class="o">==</span> <span class="n">geometric</span><span class="o">.</span><span class="n">optimize</span><span class="o">.</span><span class="n">OPT_STATE</span><span class="o">.</span><span class="n">FAILED</span><span class="p">:</span>
            <span class="n">core</span><span class="o">.</span><span class="n">print_out</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n\n</span><span class="s2">  Optimization failed to converge!                                                              ~</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="k">break</span>
        <span class="n">optimizer</span><span class="o">.</span><span class="n">step</span><span class="p">()</span>
        <span class="n">optimizer</span><span class="o">.</span><span class="n">calcEnergyForce</span><span class="p">()</span>
        <span class="n">optimizer</span><span class="o">.</span><span class="n">evaluateStep</span><span class="p">()</span>
        <span class="n">grms</span><span class="p">,</span> <span class="n">gmax</span> <span class="o">=</span> <span class="n">optimizer</span><span class="o">.</span><span class="n">calcGradNorm</span><span class="p">()</span>
        <span class="n">drms</span><span class="p">,</span> <span class="n">dmax</span> <span class="o">=</span> <span class="n">geometric</span><span class="o">.</span><span class="n">optimize</span><span class="o">.</span><span class="n">calc_drms_dmax</span><span class="p">(</span><span class="n">optimizer</span><span class="o">.</span><span class="n">X</span><span class="p">,</span> <span class="n">optimizer</span><span class="o">.</span><span class="n">Xprev</span><span class="p">)</span>
        <span class="n">conv_energy</span> <span class="o">=</span> <span class="s1">&#39;*&#39;</span> <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">optimizer</span><span class="o">.</span><span class="n">E</span> <span class="o">-</span> <span class="n">optimizer</span><span class="o">.</span><span class="n">Eprev</span><span class="p">)</span> <span class="o">&lt;</span> <span class="n">params</span><span class="o">.</span><span class="n">Convergence_energy</span> <span class="k">else</span> <span class="s1">&#39; &#39;</span>
        <span class="n">conv_gmax</span> <span class="o">=</span> <span class="s1">&#39;*&#39;</span> <span class="k">if</span> <span class="n">gmax</span> <span class="o">&lt;</span> <span class="n">params</span><span class="o">.</span><span class="n">Convergence_gmax</span> <span class="k">else</span> <span class="s1">&#39; &#39;</span>
        <span class="n">conv_grms</span> <span class="o">=</span> <span class="s1">&#39;*&#39;</span> <span class="k">if</span> <span class="n">grms</span> <span class="o">&lt;</span> <span class="n">params</span><span class="o">.</span><span class="n">Convergence_grms</span> <span class="k">else</span> <span class="s1">&#39; &#39;</span>
        <span class="n">conv_dmax</span> <span class="o">=</span> <span class="s1">&#39;*&#39;</span> <span class="k">if</span> <span class="n">dmax</span> <span class="o">&lt;</span> <span class="n">params</span><span class="o">.</span><span class="n">Convergence_dmax</span> <span class="k">else</span> <span class="s1">&#39; &#39;</span>
        <span class="n">conv_drms</span> <span class="o">=</span> <span class="s1">&#39;*&#39;</span> <span class="k">if</span> <span class="n">drms</span> <span class="o">&lt;</span> <span class="n">params</span><span class="o">.</span><span class="n">Convergence_drms</span> <span class="k">else</span> <span class="s1">&#39; &#39;</span>
        <span class="n">core</span><span class="o">.</span><span class="n">print_out</span><span class="p">((</span><span class="sa">f</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">   </span><span class="si">{</span><span class="n">optimizer</span><span class="o">.</span><span class="n">Iteration</span><span class="si">:</span><span class="s1">4d</span><span class="si">}</span><span class="s1"> </span><span class="si">{</span><span class="n">optimizer</span><span class="o">.</span><span class="n">E</span><span class="si">:</span><span class="s1">16.8e</span><span class="si">}</span><span class="s1">  &#39;</span>
                        <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">optimizer</span><span class="o">.</span><span class="n">E</span><span class="o">-</span><span class="n">optimizer</span><span class="o">.</span><span class="n">Eprev</span><span class="si">:</span><span class="s1">10.2e</span><span class="si">}</span><span class="s1"> </span><span class="si">{</span><span class="n">conv_energy</span><span class="si">}</span><span class="s1">  </span><span class="si">{</span><span class="n">gmax</span><span class="si">:</span><span class="s1">10.2e</span><span class="si">}</span><span class="s1"> </span><span class="si">{</span><span class="n">conv_gmax</span><span class="si">}</span><span class="s1">  &#39;</span>
                        <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">grms</span><span class="si">:</span><span class="s1">10.2e</span><span class="si">}</span><span class="s1"> </span><span class="si">{</span><span class="n">conv_grms</span><span class="si">}</span><span class="s1">  </span><span class="si">{</span><span class="n">dmax</span><span class="si">:</span><span class="s1">10.2e</span><span class="si">}</span><span class="s1"> </span><span class="si">{</span><span class="n">conv_dmax</span><span class="si">}</span><span class="s1">  </span><span class="si">{</span><span class="n">drms</span><span class="si">:</span><span class="s1">10.2e</span><span class="si">}</span><span class="s1"> </span><span class="si">{</span><span class="n">conv_drms</span><span class="si">}</span><span class="s1">  ~&#39;</span><span class="p">))</span>

        <span class="k">if</span> <span class="n">return_history</span><span class="p">:</span>
            <span class="n">step_energies</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">optimizer</span><span class="o">.</span><span class="n">E</span><span class="p">)</span>
            <span class="n">step_coordinates</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">core</span><span class="o">.</span><span class="n">Matrix</span><span class="o">.</span><span class="n">from_array</span><span class="p">(</span><span class="n">optimizer</span><span class="o">.</span><span class="n">X</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="mi">3</span><span class="p">)))</span>
            <span class="n">step_gradients</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">core</span><span class="o">.</span><span class="n">Matrix</span><span class="o">.</span><span class="n">from_array</span><span class="p">(</span><span class="n">optimizer</span><span class="o">.</span><span class="n">gradx</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="mi">3</span><span class="p">)))</span>

    <span class="n">return_energy</span> <span class="o">=</span> <span class="n">optimizer</span><span class="o">.</span><span class="n">E</span>
    <span class="n">opt_geometry</span> <span class="o">=</span> <span class="n">core</span><span class="o">.</span><span class="n">Matrix</span><span class="o">.</span><span class="n">from_array</span><span class="p">(</span><span class="n">optimizer</span><span class="o">.</span><span class="n">X</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="mi">3</span><span class="p">))</span>
    <span class="n">molecule</span><span class="o">.</span><span class="n">set_geometry</span><span class="p">(</span><span class="n">opt_geometry</span><span class="p">)</span>
    <span class="n">molecule</span><span class="o">.</span><span class="n">update_geometry</span><span class="p">()</span>
    <span class="n">core</span><span class="o">.</span><span class="n">print_out</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">  Final Energy : </span><span class="si">{</span><span class="n">return_energy</span><span class="si">}</span><span class="s1"> </span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
    <span class="n">core</span><span class="o">.</span><span class="n">print_out</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">  Final Geometry : </span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
    <span class="n">molecule</span><span class="o">.</span><span class="n">print_in_input_format</span><span class="p">()</span>

    <span class="k">if</span> <span class="n">return_history</span><span class="p">:</span>
        <span class="n">history</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s1">&#39;energy&#39;</span><span class="p">:</span> <span class="n">step_energies</span><span class="p">,</span>
            <span class="s1">&#39;gradient&#39;</span><span class="p">:</span> <span class="n">step_gradients</span><span class="p">,</span>
            <span class="s1">&#39;coordinates&#39;</span><span class="p">:</span> <span class="n">step_coordinates</span><span class="p">,</span>
        <span class="p">}</span>

    <span class="k">if</span> <span class="n">return_wfn</span><span class="p">:</span>
        <span class="n">wfn</span> <span class="o">=</span> <span class="n">engine</span><span class="o">.</span><span class="n">p4_wfn</span>

    <span class="k">if</span> <span class="n">return_wfn</span> <span class="ow">and</span> <span class="n">return_history</span><span class="p">:</span>
        <span class="k">return</span> <span class="p">(</span><span class="n">return_energy</span><span class="p">,</span> <span class="n">wfn</span><span class="p">,</span> <span class="n">history</span><span class="p">)</span>
    <span class="k">elif</span> <span class="n">return_wfn</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">return_history</span><span class="p">:</span>
        <span class="k">return</span> <span class="p">(</span><span class="n">return_energy</span><span class="p">,</span> <span class="n">wfn</span><span class="p">)</span>
    <span class="k">elif</span> <span class="n">return_history</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">return_wfn</span><span class="p">:</span>
        <span class="k">return</span> <span class="p">(</span><span class="n">return_energy</span><span class="p">,</span> <span class="n">history</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">return_energy</span></div>


<div class="viewcode-block" id="optimize"><a class="viewcode-back" href="../../../opt.html#psi4.driver.optimize">[docs]</a><span class="k">def</span> <span class="nf">optimize</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
<span class="w">    </span><span class="sa">r</span><span class="sd">&quot;&quot;&quot;Function to perform a geometry optimization.</span>

<span class="sd">    :aliases: opt()</span>

<span class="sd">    :returns: *float* |w--w| Total electronic energy of optimized structure in Hartrees.</span>

<span class="sd">    :returns: (*float*, :py:class:`~psi4.core.Wavefunction`) |w--w| energy and wavefunction when **return_wfn** specified.</span>

<span class="sd">    :raises: :py:class:`psi4.driver.OptimizationConvergenceError` if :term:`GEOM_MAXITER &lt;GEOM_MAXITER (OPTKING)&gt;` exceeded without reaching geometry convergence.</span>

<span class="sd">    :PSI variables:</span>

<span class="sd">    .. hlist::</span>
<span class="sd">       :columns: 1</span>

<span class="sd">       * :psivar:`CURRENT ENERGY`</span>

<span class="sd">    :type name: str</span>
<span class="sd">    :param name: ``&#39;scf&#39;`` || ``&#39;mp2&#39;`` || ``&#39;ci5&#39;`` || etc.</span>

<span class="sd">        First argument, usually unlabeled. Indicates the computational method</span>
<span class="sd">        to be applied to the database. May be any valid argument to</span>
<span class="sd">        :py:func:`psi4.driver.energy`.</span>

<span class="sd">    :type molecule: :ref:`molecule &lt;op_py_molecule&gt;`</span>
<span class="sd">    :param molecule: ``h2o`` || etc.</span>

<span class="sd">        The target molecule, if not the last molecule defined.</span>

<span class="sd">    :type return_wfn: :ref:`boolean &lt;op_py_boolean&gt;`</span>
<span class="sd">    :param return_wfn: ``&#39;on&#39;`` || |dl| ``&#39;off&#39;`` |dr|</span>

<span class="sd">        Indicate to additionally return the :py:class:`~psi4.core.Wavefunction`</span>
<span class="sd">        calculation result as the second element (after *float* energy) of a tuple.</span>

<span class="sd">    :type return_history: :ref:`boolean &lt;op_py_boolean&gt;`</span>
<span class="sd">    :param return_history: ``&#39;on&#39;`` || |dl| ``&#39;off&#39;`` |dr|</span>

<span class="sd">        Indicate to additionally return dictionary of lists of geometries,</span>
<span class="sd">        energies, and gradients at each step in the optimization.</span>

<span class="sd">    :type engine: str</span>
<span class="sd">    :param engine: |dl| ``&#39;optking&#39;`` |dr| || ``&#39;geometric&#39;``</span>

<span class="sd">        Indicates the optimization engine to use, which can be either Psi4&#39;s</span>
<span class="sd">        native Optking optimizer or the GeomeTRIC program.</span>

<span class="sd">    :type optimizer_keywords: dict</span>
<span class="sd">    :param optimizer_keywords: Extra options passed to the GeomeTRIC or optking optimizers</span>

<span class="sd">        Indicates additional options to be passed to the GeomeTRIC optimizer if</span>
<span class="sd">        chosen as the optimization engine. Alternatively, can be used to set optking options</span>
<span class="sd">        that are not currently recognized by Psi4.</span>

<span class="sd">    :type func: :ref:`function &lt;op_py_function&gt;`</span>
<span class="sd">    :param func: |dl| ``gradient`` |dr| || ``energy`` || ``cbs``</span>

<span class="sd">        Indicates the type of calculation to be performed on the molecule.</span>
<span class="sd">        The default dertype accesses ``&#39;gradient&#39;`` or ``&#39;energy&#39;``, while</span>
<span class="sd">        ``&#39;cbs&#39;`` performs a multistage finite difference calculation.</span>
<span class="sd">        If a nested series of python functions is intended (see :ref:`sec:intercalls`),</span>
<span class="sd">        use keyword ``opt_func`` instead of ``func``.</span>

<span class="sd">    :type dertype: :ref:`dertype &lt;op_py_dertype&gt;`</span>
<span class="sd">    :param dertype: ``&#39;gradient&#39;`` || ``&#39;energy&#39;``</span>

<span class="sd">        Indicates whether analytic (if available) or finite difference</span>
<span class="sd">        optimization is to be performed.</span>

<span class="sd">    :type hessian_with: str</span>
<span class="sd">    :param hessian_with: ``&#39;scf&#39;`` || ``&#39;mp2&#39;`` || etc.</span>

<span class="sd">        Indicates the computational method with which to perform a hessian</span>
<span class="sd">        analysis to guide the geometry optimization.</span>

<span class="sd">    .. warning:: Optimizations where the molecule is specified in Z-matrix format</span>
<span class="sd">       with dummy atoms will result in the geometry being converted to a Cartesian representation.</span>

<span class="sd">    .. note:: Analytic gradients area available for all methods in the table</span>
<span class="sd">        below. Optimizations with other methods in the energy table proceed</span>
<span class="sd">        by finite differences.</span>

<span class="sd">    .. _`table:grad_gen`:</span>

<span class="sd">    +-------------------------+---------------------------------------------------------------------------------------------------------------+</span>
<span class="sd">    | name                    | calls method                                                                                                  |</span>
<span class="sd">    +=========================+===============================================================================================================+</span>
<span class="sd">    | efp                     | efp-only optimizations                                                                                        |</span>
<span class="sd">    +-------------------------+---------------------------------------------------------------------------------------------------------------+</span>
<span class="sd">    | scf                     | Hartree--Fock (HF) or density functional theory (DFT) :ref:`[manual] &lt;sec:scf&gt;` :ref:`[details] &lt;dd_b3lyp&gt;`   |</span>
<span class="sd">    +-------------------------+---------------------------------------------------------------------------------------------------------------+</span>
<span class="sd">    | hf                      | HF self consistent field (SCF) :ref:`[manual] &lt;sec:scf&gt;` :ref:`[details] &lt;dd_hf&gt;`                             |</span>
<span class="sd">    +-------------------------+---------------------------------------------------------------------------------------------------------------+</span>
<span class="sd">    | dct                     | density cumulant (functional) theory :ref:`[manual] &lt;sec:dct&gt;`                                                |</span>
<span class="sd">    +-------------------------+---------------------------------------------------------------------------------------------------------------+</span>
<span class="sd">    | mp2                     | 2nd-order |MollerPlesset| perturbation theory (MP2) :ref:`[manual] &lt;sec:dfmp2&gt;` :ref:`[details] &lt;dd_mp2&gt;`     |</span>
<span class="sd">    +-------------------------+---------------------------------------------------------------------------------------------------------------+</span>
<span class="sd">    | mp3                     | 3rd-order |MollerPlesset| perturbation theory (MP3) :ref:`[manual] &lt;sec:occ_nonoo&gt;` :ref:`[details] &lt;dd_mp3&gt;` |</span>
<span class="sd">    +-------------------------+---------------------------------------------------------------------------------------------------------------+</span>
<span class="sd">    | mp2.5                   | average of MP2 and MP3 :ref:`[manual] &lt;sec:occ_nonoo&gt;` :ref:`[details] &lt;dd_mp2p5&gt;`                            |</span>
<span class="sd">    +-------------------------+---------------------------------------------------------------------------------------------------------------+</span>
<span class="sd">    | omp2                    | orbital-optimized second-order MP perturbation theory :ref:`[manual] &lt;sec:occ_oo&gt;` :ref:`[details] &lt;dd_omp2&gt;` |</span>
<span class="sd">    +-------------------------+---------------------------------------------------------------------------------------------------------------+</span>
<span class="sd">    | omp3                    | orbital-optimized third-order MP perturbation theory :ref:`[manual] &lt;sec:occ_oo&gt;` :ref:`[details] &lt;dd_omp3&gt;`  |</span>
<span class="sd">    +-------------------------+---------------------------------------------------------------------------------------------------------------+</span>
<span class="sd">    | omp2.5                  | orbital-optimized MP2.5 :ref:`[manual] &lt;sec:occ_oo&gt;` :ref:`[details] &lt;dd_omp2p5&gt;`                             |</span>
<span class="sd">    +-------------------------+---------------------------------------------------------------------------------------------------------------+</span>
<span class="sd">    | oremp2                  | orbital-optimized REMP2 :ref:`[manual] &lt;sec:occ_oo&gt;` :ref:`[details] &lt;dd_oremp2&gt;`                             |</span>
<span class="sd">    +-------------------------+---------------------------------------------------------------------------------------------------------------+</span>
<span class="sd">    | lccd                    | Linear CCD :ref:`[manual] &lt;sec:occ_nonoo&gt;` :ref:`[details] &lt;dd_lccd&gt;`                                         |</span>
<span class="sd">    +-------------------------+---------------------------------------------------------------------------------------------------------------+</span>
<span class="sd">    | olccd                   | orbital optimized LCCD :ref:`[manual] &lt;sec:occ_oo&gt;` :ref:`[details] &lt;dd_olccd&gt;`                               |</span>
<span class="sd">    +-------------------------+---------------------------------------------------------------------------------------------------------------+</span>
<span class="sd">    | cc2                     | approximate coupled cluster singles and doubles (CC2) :ref:`[manual] &lt;sec:cc&gt;` :ref:`[details] &lt;dd_cc2&gt;`      |</span>
<span class="sd">    +-------------------------+---------------------------------------------------------------------------------------------------------------+</span>
<span class="sd">    | ccd                     | coupled cluster doubles (CCD) :ref:`[manual] &lt;sec:occ_nonoo&gt;` :ref:`[details] &lt;dd_ccd&gt;`                       |</span>
<span class="sd">    +-------------------------+---------------------------------------------------------------------------------------------------------------+</span>
<span class="sd">    | ccsd                    | coupled cluster singles and doubles (CCSD) :ref:`[manual] &lt;sec:cc&gt;` :ref:`[details] &lt;dd_ccsd&gt;`                |</span>
<span class="sd">    +-------------------------+---------------------------------------------------------------------------------------------------------------+</span>
<span class="sd">    | ccsd(t)                 | CCSD with perturbative triples (CCSD(T)) :ref:`[manual] &lt;sec:cc&gt;` :ref:`[details] &lt;dd_ccsd_prt_pr&gt;`           |</span>
<span class="sd">    +-------------------------+---------------------------------------------------------------------------------------------------------------+</span>
<span class="sd">    | eom-ccsd                | equation of motion (EOM) CCSD :ref:`[manual] &lt;sec:eomcc&gt;`                                                     |</span>
<span class="sd">    +-------------------------+---------------------------------------------------------------------------------------------------------------+</span>

<span class="sd">    .. _`table:grad_scf`:</span>

<span class="sd">    .. include:: /autodoc_dft_opt.rst</span>

<span class="sd">    .. include:: /cfour_table_grad.rst</span>


<span class="sd">    :examples:</span>

<span class="sd">    &gt;&gt;&gt; # [1] Analytic hf optimization</span>
<span class="sd">    &gt;&gt;&gt; optimize(&#39;hf&#39;)</span>

<span class="sd">    &gt;&gt;&gt; # [2] Finite difference mp5 optimization with gradient</span>
<span class="sd">    &gt;&gt;&gt; #     printed to output file</span>
<span class="sd">    &gt;&gt;&gt; e, wfn = opt(&#39;mp5&#39;, return_wfn=&#39;yes&#39;)</span>
<span class="sd">    &gt;&gt;&gt; wfn.gradient().print_out()</span>

<span class="sd">    &gt;&gt;&gt; # [3] Can automatically perform complete basis set extrapolations</span>
<span class="sd">    &gt;&gt;&gt; optimize(&#39;MP2/cc-pV([D,T]+d)Z&#39;)</span>

<span class="sd">    &gt;&gt;&gt; # [4] Can automatically perform delta corrections that include extrapolations</span>
<span class="sd">    &gt;&gt;&gt; # even with a user-defined extrapolation formula. See sample inputs named</span>
<span class="sd">    &gt;&gt;&gt; # cbs-xtpl* for more examples of this input style</span>
<span class="sd">    &gt;&gt;&gt; optimize(&quot;MP2/aug-cc-pv([d,t]+d)z + d:ccsd(t)/cc-pvdz&quot;, corl_scheme=myxtplfn_2)</span>

<span class="sd">    &gt;&gt;&gt; # [5] Get info like geometry, gradient, energy back after an</span>
<span class="sd">    &gt;&gt;&gt; #     optimization fails. Note that the energy and gradient</span>
<span class="sd">    &gt;&gt;&gt; #     correspond to the last optimization cycle, whereas the</span>
<span class="sd">    &gt;&gt;&gt; #     geometry (by default) is the anticipated *next* optimization step.</span>
<span class="sd">    &gt;&gt;&gt; try:</span>
<span class="sd">    &gt;&gt;&gt;     optimize(&#39;hf/cc-pvtz&#39;)</span>
<span class="sd">    &gt;&gt;&gt; except psi4.OptimizationConvergenceError as ex:</span>
<span class="sd">    &gt;&gt;&gt;     next_geom_coords_as_numpy_array = np.asarray(ex.wfn.molecule().geometry())</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">kwargs</span> <span class="o">=</span> <span class="n">p4util</span><span class="o">.</span><span class="n">kwargs_lower</span><span class="p">(</span><span class="n">kwargs</span><span class="p">)</span>

    <span class="n">engine</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s1">&#39;engine&#39;</span><span class="p">,</span> <span class="s1">&#39;optking&#39;</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">engine</span> <span class="o">==</span> <span class="s1">&#39;geometric&#39;</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">optimize_geometric</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
    <span class="k">elif</span> <span class="n">engine</span> <span class="o">!=</span> <span class="s1">&#39;optking&#39;</span><span class="p">:</span>
        <span class="k">raise</span> <span class="n">ValidationError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Optimizer </span><span class="si">{</span><span class="n">engine</span><span class="si">}</span><span class="s2"> is not supported.&quot;</span><span class="p">)</span>

    <span class="kn">import</span> <span class="nn">optking</span>

    <span class="n">name</span> <span class="o">=</span> <span class="n">driver_util</span><span class="o">.</span><span class="n">upgrade_interventions</span><span class="p">(</span><span class="n">name</span><span class="p">)</span>
    <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="s1">&#39;__call__&#39;</span><span class="p">):</span>
        <span class="n">lowername</span> <span class="o">=</span> <span class="n">name</span>
        <span class="n">custom_gradient</span> <span class="o">=</span> <span class="kc">True</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">lowername</span> <span class="o">=</span> <span class="n">name</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>
        <span class="n">custom_gradient</span> <span class="o">=</span> <span class="kc">False</span>

    <span class="n">return_wfn</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s1">&#39;return_wfn&#39;</span><span class="p">,</span> <span class="kc">False</span><span class="p">)</span>

    <span class="n">return_history</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s1">&#39;return_history&#39;</span><span class="p">,</span> <span class="kc">False</span><span class="p">)</span>

    <span class="c1"># This might be incorrect now?</span>
    <span class="k">if</span> <span class="n">custom_gradient</span> <span class="ow">and</span> <span class="n">core</span><span class="o">.</span><span class="n">has_option_changed</span><span class="p">(</span><span class="s1">&#39;OPTKING&#39;</span><span class="p">,</span> <span class="s1">&#39;FULL_HESS_EVERY&#39;</span><span class="p">):</span>
        <span class="k">raise</span> <span class="n">ValidationError</span><span class="p">(</span><span class="s2">&quot;Optimize: Does not support custom Hessian&#39;s yet.&quot;</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">hessian_with_method</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;hessian_with&#39;</span><span class="p">,</span> <span class="n">lowername</span><span class="p">)</span>

    <span class="n">_filter_renamed_methods</span><span class="p">(</span><span class="s2">&quot;optimize&quot;</span><span class="p">,</span> <span class="n">lowername</span><span class="p">)</span>

    <span class="n">optstash</span> <span class="o">=</span> <span class="n">p4util</span><span class="o">.</span><span class="n">OptionsState</span><span class="p">(</span>
        <span class="p">[</span><span class="s1">&#39;FINDIF&#39;</span><span class="p">,</span> <span class="s1">&#39;HESSIAN_WRITE&#39;</span><span class="p">],</span>
        <span class="p">[</span><span class="s1">&#39;OPTKING&#39;</span><span class="p">,</span> <span class="s1">&#39;CART_HESS_READ&#39;</span><span class="p">],</span>
        <span class="p">[</span><span class="s1">&#39;SCF&#39;</span><span class="p">,</span> <span class="s1">&#39;GUESS_PERSIST&#39;</span><span class="p">],</span>  <span class="c1"># handle on behalf of cbs()</span>
        <span class="p">[</span><span class="s1">&#39;SCF&#39;</span><span class="p">,</span> <span class="s1">&#39;GUESS&#39;</span><span class="p">])</span>

    <span class="n">n</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;opt_iter&#39;</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>

    <span class="c1"># Make sure the molecule the user provided is the active one</span>
    <span class="n">molecule</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s1">&#39;molecule&#39;</span><span class="p">,</span> <span class="n">core</span><span class="o">.</span><span class="n">get_active_molecule</span><span class="p">())</span>

    <span class="c1"># If we are freezing cartesian, do not orient or COM</span>
    <span class="k">if</span> <span class="nb">any</span><span class="p">([</span><span class="n">core</span><span class="o">.</span><span class="n">get_option</span><span class="p">(</span><span class="s1">&#39;OPTKING&#39;</span><span class="p">,</span> <span class="s1">&#39;FROZEN_CARTESIAN&#39;</span><span class="p">),</span> <span class="n">core</span><span class="o">.</span><span class="n">get_option</span><span class="p">(</span><span class="s1">&#39;OPTKING&#39;</span><span class="p">,</span> <span class="s1">&#39;EXT_FORCE_CARTESIAN&#39;</span><span class="p">)]):</span>
        <span class="k">if</span> <span class="n">molecule</span><span class="o">.</span><span class="n">has_zmatrix</span><span class="p">():</span>
            <span class="k">raise</span> <span class="n">ValidationError</span><span class="p">(</span><span class="s2">&quot;Job includes cartesian coordinate constraints. This cannot be fully &quot;</span>
                                  <span class="s2">&quot;obeyed due to zmatrix in input. Please convert your zmatrix to cartesian &quot;</span>
                                  <span class="s2">&quot;coordinates if cartesian constraints are needed &quot;</span><span class="p">)</span>
        <span class="n">molecule</span><span class="o">.</span><span class="n">fix_orientation</span><span class="p">(</span><span class="kc">True</span><span class="p">)</span>
        <span class="n">molecule</span><span class="o">.</span><span class="n">fix_com</span><span class="p">(</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">molecule</span><span class="o">.</span><span class="n">update_geometry</span><span class="p">()</span>

    <span class="k">if</span> <span class="n">core</span><span class="o">.</span><span class="n">get_option</span><span class="p">(</span><span class="s1">&#39;OPTKING&#39;</span><span class="p">,</span> <span class="s1">&#39;OPT_RESTART&#39;</span><span class="p">):</span>
        <span class="c1"># Recreate all of optking&#39;s internal classes to restart an optimization</span>
        <span class="c1"># This has not been well tested - Experimental</span>
        <span class="n">opt_object</span> <span class="o">=</span> <span class="n">optking</span><span class="o">.</span><span class="n">opt_helper</span><span class="o">.</span><span class="n">CustomHelper</span><span class="p">(</span><span class="n">molecule</span><span class="p">)</span>
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">core</span><span class="o">.</span><span class="n">get_writer_file_prefix</span><span class="p">(</span><span class="n">molecule</span><span class="o">.</span><span class="n">name</span><span class="p">())</span><span class="si">}</span><span class="s2">.1.dat&quot;</span><span class="p">,</span> <span class="s1">&#39;r&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
            <span class="n">stashed_opt</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">f</span><span class="p">)</span>
        <span class="n">opt_object</span><span class="o">.</span><span class="n">from_dict</span><span class="p">(</span><span class="n">stashed_opt</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="c1"># create an OptHelper to run an optimization through</span>
        <span class="c1"># Optking will ignore any keywords it doesn&#39;t recognize.</span>
        <span class="n">params</span> <span class="o">=</span> <span class="n">p4util</span><span class="o">.</span><span class="n">prepare_options_for_modules</span><span class="p">()</span>
        <span class="n">optimizer_params</span> <span class="o">=</span> <span class="p">{</span><span class="n">k</span><span class="p">:</span> <span class="n">v</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;value&#39;</span><span class="p">)</span> <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">params</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s2">&quot;OPTKING&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">items</span><span class="p">()</span> <span class="k">if</span> <span class="n">v</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;has_changed&#39;</span><span class="p">)}</span>
        <span class="n">optimizer_params</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;optimizer_keywords&quot;</span><span class="p">,</span> <span class="p">{}))</span>
        <span class="n">opt_object</span> <span class="o">=</span> <span class="n">optking</span><span class="o">.</span><span class="n">opt_helper</span><span class="o">.</span><span class="n">CustomHelper</span><span class="p">(</span><span class="n">molecule</span><span class="p">,</span> <span class="n">params</span><span class="o">=</span><span class="n">optimizer_params</span><span class="p">)</span>

    <span class="n">initial_sym</span> <span class="o">=</span> <span class="n">molecule</span><span class="o">.</span><span class="n">schoenflies_symbol</span><span class="p">()</span>
    <span class="k">while</span> <span class="n">n</span> <span class="o">&lt;=</span> <span class="n">core</span><span class="o">.</span><span class="n">get_option</span><span class="p">(</span><span class="s1">&#39;OPTKING&#39;</span><span class="p">,</span> <span class="s1">&#39;GEOM_MAXITER&#39;</span><span class="p">):</span>
        <span class="n">current_sym</span> <span class="o">=</span> <span class="n">molecule</span><span class="o">.</span><span class="n">schoenflies_symbol</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">initial_sym</span> <span class="o">!=</span> <span class="n">current_sym</span><span class="p">:</span>

            <span class="k">if</span> <span class="nb">any</span><span class="p">([</span><span class="n">core</span><span class="o">.</span><span class="n">get_option</span><span class="p">(</span><span class="s1">&#39;OPTKING&#39;</span><span class="p">,</span> <span class="s1">&#39;FROZEN_CARTESIAN&#39;</span><span class="p">),</span> <span class="n">core</span><span class="o">.</span><span class="n">get_option</span><span class="p">(</span><span class="s1">&#39;OPTKING&#39;</span><span class="p">,</span> <span class="s1">&#39;EXT_FORCE_CARTESIAN&#39;</span><span class="p">)]):</span>
                <span class="k">raise</span> <span class="n">ValidationError</span><span class="p">(</span><span class="s2">&quot;Symmetrize cannot be called while cartesian constraints are active &quot;</span>
                                      <span class="s2">&quot;symmetrize was about to be called. Please check symmetry dependent input &quot;</span>
                                      <span class="s2">&quot;, such as DOCC, is correct or turn off symmetry&quot;</span><span class="p">)</span>

            <span class="c1"># Try to resymmetrize molecule if slightly broken.</span>
            <span class="n">molecule</span><span class="o">.</span><span class="n">symmetrize</span><span class="p">(</span><span class="n">core</span><span class="o">.</span><span class="n">get_option</span><span class="p">(</span><span class="s2">&quot;OPTKING&quot;</span><span class="p">,</span> <span class="s2">&quot;CARTESIAN_SYM_TOLERANCE&quot;</span><span class="p">))</span>

            <span class="k">if</span> <span class="n">molecule</span><span class="o">.</span><span class="n">schoenflies_symbol</span><span class="p">()</span> <span class="o">!=</span> <span class="n">initial_sym</span><span class="p">:</span>
                <span class="k">raise</span> <span class="n">ValidationError</span><span class="p">(</span><span class="s2">&quot;Point group changed! (</span><span class="si">%s</span><span class="s2"> &lt;-- </span><span class="si">%s</span><span class="s2">) You should restart &quot;</span>
                                      <span class="s2">&quot;using the last geometry in the output, after &quot;</span>
                                      <span class="s2">&quot;carefully making sure all symmetry-dependent &quot;</span>
                                      <span class="s2">&quot;input, such as DOCC, is correct.&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">current_sym</span><span class="p">,</span> <span class="n">initial_sym</span><span class="p">))</span>

        <span class="n">kwargs</span><span class="p">[</span><span class="s1">&#39;opt_iter&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">n</span>
        <span class="n">core</span><span class="o">.</span><span class="n">set_variable</span><span class="p">(</span><span class="s1">&#39;GEOMETRY ITERATIONS&#39;</span><span class="p">,</span> <span class="n">n</span><span class="p">)</span>

        <span class="c1"># Use orbitals from previous iteration as a guess</span>
        <span class="c1">#   set within loop so that can be influenced by fns to optimize (e.g., cbs)</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">n</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="ow">not</span> <span class="n">core</span><span class="o">.</span><span class="n">get_option</span><span class="p">(</span><span class="s1">&#39;SCF&#39;</span><span class="p">,</span> <span class="s1">&#39;GUESS_PERSIST&#39;</span><span class="p">)):</span>
            <span class="n">core</span><span class="o">.</span><span class="n">set_local_option</span><span class="p">(</span><span class="s1">&#39;SCF&#39;</span><span class="p">,</span> <span class="s1">&#39;GUESS&#39;</span><span class="p">,</span> <span class="s1">&#39;READ&#39;</span><span class="p">)</span>

        <span class="c1"># We&#39;ll currently ignore the possibility that the gradient isn&#39;t needed</span>
        <span class="n">opt_calcs</span> <span class="o">=</span> <span class="n">opt_object</span><span class="o">.</span><span class="n">calculations_needed</span><span class="p">()</span> <span class="c1"># tuple of strings (&#39;energy&#39;, &#39;gradient&#39;, etc)</span>

        <span class="c1"># Compute the gradient - no longer need to worry about opt_data being wiped</span>
        <span class="n">G</span><span class="p">,</span> <span class="n">wfn</span> <span class="o">=</span> <span class="n">gradient</span><span class="p">(</span><span class="n">lowername</span><span class="p">,</span> <span class="n">return_wfn</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">molecule</span><span class="o">=</span><span class="n">molecule</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="n">thisenergy</span> <span class="o">=</span> <span class="n">core</span><span class="o">.</span><span class="n">variable</span><span class="p">(</span><span class="s1">&#39;CURRENT ENERGY&#39;</span><span class="p">)</span>
        <span class="n">opt_object</span><span class="o">.</span><span class="n">E</span> <span class="o">=</span> <span class="n">thisenergy</span>
        <span class="n">opt_object</span><span class="o">.</span><span class="n">gX</span> <span class="o">=</span> <span class="n">G</span><span class="o">.</span><span class="n">np</span>

        <span class="k">if</span> <span class="n">core</span><span class="o">.</span><span class="n">get_option</span><span class="p">(</span><span class="s1">&#39;OPTKING&#39;</span><span class="p">,</span> <span class="s1">&#39;CART_HESS_READ&#39;</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="n">n</span> <span class="o">==</span> <span class="mi">1</span><span class="p">):</span>
            <span class="n">opt_object</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">cart_hess_read</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="n">opt_object</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">hessian_file</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">core</span><span class="o">.</span><span class="n">get_writer_file_prefix</span><span class="p">(</span><span class="n">molecule</span><span class="o">.</span><span class="n">name</span><span class="p">())</span><span class="si">}</span><span class="s2">.hess&quot;</span>
                <span class="c1"># compute Hessian as requested; frequency wipes out gradient so stash it</span>
        <span class="k">elif</span> <span class="s1">&#39;hessian&#39;</span> <span class="ow">in</span> <span class="n">opt_calcs</span><span class="p">:</span>
            <span class="c1"># compute hessian as requested.</span>

            <span class="c1"># procedures proctable analytic hessians</span>
            <span class="n">_</span><span class="p">,</span> <span class="n">hess_wfn</span> <span class="o">=</span> <span class="n">frequencies</span><span class="p">(</span><span class="n">hessian_with_method</span><span class="p">,</span>
                                      <span class="n">molecule</span><span class="o">=</span><span class="n">molecule</span><span class="p">,</span>
                                      <span class="n">ref_gradient</span><span class="o">=</span><span class="n">G</span><span class="p">,</span>
                                      <span class="n">return_wfn</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                                      <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
            <span class="n">opt_object</span><span class="o">.</span><span class="n">HX</span> <span class="o">=</span> <span class="n">hess_wfn</span><span class="o">.</span><span class="n">hessian</span><span class="p">()</span><span class="o">.</span><span class="n">np</span>

        <span class="c1"># force optking to update its molecule to psi4&#39;s.</span>
        <span class="c1"># This allows for psi4 to rotate as desired. If optimizing in cartesians. rotation is not allowed</span>
        <span class="c1"># Process gradient / hessian. Take step. Print summary to output for user</span>
        <span class="n">opt_object</span><span class="o">.</span><span class="n">molsys</span><span class="o">.</span><span class="n">geom</span> <span class="o">=</span> <span class="n">molecule</span><span class="o">.</span><span class="n">geometry</span><span class="p">()</span><span class="o">.</span><span class="n">np</span>
        <span class="n">core</span><span class="o">.</span><span class="n">print_out</span><span class="p">(</span><span class="n">opt_object</span><span class="o">.</span><span class="n">pre_step_str</span><span class="p">())</span>  <span class="c1"># print optking&#39;s molecule</span>
        <span class="n">opt_object</span><span class="o">.</span><span class="n">compute</span><span class="p">()</span>  <span class="c1"># process E, gX, H</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">opt_object</span><span class="o">.</span><span class="n">take_step</span><span class="p">()</span>
        <span class="k">except</span> <span class="n">optking</span><span class="o">.</span><span class="n">exceptions</span><span class="o">.</span><span class="n">AlgError</span><span class="p">:</span>
            <span class="c1"># Optking encountered an algorithm error and reset.</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">opt_object</span><span class="o">.</span><span class="n">HX</span><span class="p">:</span>
                <span class="n">n</span> <span class="o">+=</span> <span class="mi">1</span>
                <span class="k">continue</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">raise</span> <span class="n">ConvergenceError</span><span class="p">(</span>
                        <span class="s2">&quot;Psi4 caught an AlgError. This should only happen after optking resets the history&quot;</span>
                        <span class="s2">&quot;and needs another Hessian&quot;</span><span class="p">,</span>
                        <span class="n">n</span><span class="p">,</span>
                        <span class="n">wfn</span>
                <span class="p">)</span>

        <span class="n">core</span><span class="o">.</span><span class="n">print_out</span><span class="p">(</span><span class="n">opt_object</span><span class="o">.</span><span class="n">post_step_str</span><span class="p">())</span>  <span class="c1"># print convergence and step info</span>

        <span class="c1"># Update psi4&#39;s molecule with new step. (Psi4 can rotate this molecule)</span>
        <span class="n">molecule</span><span class="o">.</span><span class="n">set_geometry</span><span class="p">(</span><span class="n">core</span><span class="o">.</span><span class="n">Matrix</span><span class="o">.</span><span class="n">from_array</span><span class="p">(</span><span class="n">opt_object</span><span class="o">.</span><span class="n">molsys</span><span class="o">.</span><span class="n">geom</span><span class="p">))</span>
        <span class="n">molecule</span><span class="o">.</span><span class="n">update_geometry</span><span class="p">()</span>

        <span class="n">opt_status</span> <span class="o">=</span> <span class="n">opt_object</span><span class="o">.</span><span class="n">status</span><span class="p">()</span>  <span class="c1"># Query optking for convergence, failure or continuing opt.</span>
        <span class="k">if</span> <span class="n">opt_status</span> <span class="o">==</span> <span class="s1">&#39;CONVERGED&#39;</span><span class="p">:</span>

            <span class="c1"># Last geom is normally last in history. For IRC last geom is last in IRC trajectory</span>
            <span class="c1"># Not sure how to handle ensuring that wfn corresponds to last point.</span>
            <span class="n">final_energy</span><span class="p">,</span> <span class="n">final_geom</span> <span class="o">=</span> <span class="n">opt_object</span><span class="o">.</span><span class="n">summarize_result</span><span class="p">()</span>

            <span class="c1"># Changing environment to optimized geometry as expected by user</span>
            <span class="n">molecule</span><span class="o">.</span><span class="n">set_geometry</span><span class="p">(</span><span class="n">core</span><span class="o">.</span><span class="n">Matrix</span><span class="o">.</span><span class="n">from_array</span><span class="p">(</span><span class="n">final_geom</span><span class="p">))</span>
            <span class="n">molecule</span><span class="o">.</span><span class="n">update_geometry</span><span class="p">()</span>

            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Optimizer: Optimization complete!&#39;</span><span class="p">)</span>
            <span class="n">core</span><span class="o">.</span><span class="n">print_out</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">    Final optimized geometry and variables:</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
            <span class="n">molecule</span><span class="o">.</span><span class="n">print_in_input_format</span><span class="p">()</span>

            <span class="k">for</span> <span class="n">postcallback</span> <span class="ow">in</span> <span class="n">hooks</span><span class="p">[</span><span class="s1">&#39;optimize&#39;</span><span class="p">][</span><span class="s1">&#39;post&#39;</span><span class="p">]:</span>
                <span class="n">postcallback</span><span class="p">(</span><span class="n">lowername</span><span class="p">,</span> <span class="n">wfn</span><span class="o">=</span><span class="n">wfn</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
            <span class="n">core</span><span class="o">.</span><span class="n">clean</span><span class="p">()</span>

            <span class="n">optstash</span><span class="o">.</span><span class="n">restore</span><span class="p">()</span>

            <span class="k">if</span> <span class="n">return_history</span><span class="p">:</span>
                <span class="n">history</span> <span class="o">=</span> <span class="p">{</span>
                    <span class="s1">&#39;energy&#39;</span><span class="p">:</span> <span class="p">[</span><span class="n">step</span><span class="o">.</span><span class="n">E</span> <span class="k">for</span> <span class="n">step</span> <span class="ow">in</span> <span class="n">opt_object</span><span class="o">.</span><span class="n">history</span><span class="o">.</span><span class="n">steps</span><span class="p">],</span>
                    <span class="s1">&#39;gradient&#39;</span><span class="p">:</span> <span class="p">[</span><span class="n">step</span><span class="o">.</span><span class="n">cart_grad</span> <span class="k">for</span> <span class="n">step</span> <span class="ow">in</span> <span class="n">opt_object</span><span class="o">.</span><span class="n">history</span><span class="o">.</span><span class="n">steps</span><span class="p">],</span>
                    <span class="s1">&#39;coordinates&#39;</span><span class="p">:</span> <span class="p">[</span><span class="n">step</span><span class="o">.</span><span class="n">geom</span> <span class="k">for</span> <span class="n">step</span> <span class="ow">in</span> <span class="n">opt_object</span><span class="o">.</span><span class="n">history</span><span class="o">.</span><span class="n">steps</span><span class="p">],</span>
                <span class="p">}</span>

            <span class="c1"># Create OptimizationResult like Schema. Not validated since optimize() does not pass AtomicResults.</span>
            <span class="n">opt_data</span> <span class="o">=</span> <span class="n">opt_object</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
            <span class="k">if</span> <span class="n">core</span><span class="o">.</span><span class="n">get_option</span><span class="p">(</span><span class="s1">&#39;OPTKING&#39;</span><span class="p">,</span> <span class="s1">&#39;WRITE_OPT_HISTORY&#39;</span><span class="p">):</span>
                <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">core</span><span class="o">.</span><span class="n">get_writer_file_prefix</span><span class="p">(</span><span class="n">molecule</span><span class="o">.</span><span class="n">name</span><span class="p">())</span><span class="si">}</span><span class="s2">.opt.json&quot;</span><span class="p">,</span> <span class="s1">&#39;w+&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
                    <span class="n">json</span><span class="o">.</span><span class="n">dump</span><span class="p">(</span><span class="n">opt_data</span><span class="p">,</span> <span class="n">f</span><span class="p">,</span> <span class="n">indent</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>

            <span class="k">if</span> <span class="n">return_wfn</span> <span class="ow">and</span> <span class="n">return_history</span><span class="p">:</span>
                <span class="k">return</span> <span class="p">(</span><span class="n">thisenergy</span><span class="p">,</span> <span class="n">wfn</span><span class="p">,</span> <span class="n">history</span><span class="p">)</span>
            <span class="k">elif</span> <span class="n">return_wfn</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">return_history</span><span class="p">:</span>
                <span class="k">return</span> <span class="p">(</span><span class="n">thisenergy</span><span class="p">,</span> <span class="n">wfn</span><span class="p">)</span>
            <span class="k">elif</span> <span class="n">return_history</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">return_wfn</span><span class="p">:</span>
                <span class="k">return</span> <span class="p">(</span><span class="n">thisenergy</span><span class="p">,</span> <span class="n">history</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">thisenergy</span>

        <span class="k">elif</span> <span class="n">opt_status</span> <span class="o">==</span> <span class="s1">&#39;FAILED&#39;</span><span class="p">:</span>

            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Optimizer: Optimization failed!&#39;</span><span class="p">)</span>
            <span class="n">molecule</span><span class="o">.</span><span class="n">set_geometry</span><span class="p">(</span><span class="n">core</span><span class="o">.</span><span class="n">Matrix</span><span class="o">.</span><span class="n">from_array</span><span class="p">(</span><span class="n">opt_object</span><span class="o">.</span><span class="n">molsys</span><span class="o">.</span><span class="n">geom</span><span class="p">))</span>
            <span class="n">molecule</span><span class="o">.</span><span class="n">update_geometry</span><span class="p">()</span>
            <span class="n">core</span><span class="o">.</span><span class="n">clean</span><span class="p">()</span>
            <span class="n">optstash</span><span class="o">.</span><span class="n">restore</span><span class="p">()</span>

            <span class="n">opt_data</span> <span class="o">=</span> <span class="n">opt_object</span><span class="o">.</span><span class="n">to_dict</span><span class="p">()</span>
            <span class="k">if</span> <span class="n">core</span><span class="o">.</span><span class="n">get_option</span><span class="p">(</span><span class="s1">&#39;OPTKING&#39;</span><span class="p">,</span> <span class="s1">&#39;WRITE_OPT_HISTORY&#39;</span><span class="p">):</span>
                <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">core</span><span class="o">.</span><span class="n">get_writer_file_prefix</span><span class="p">(</span><span class="n">molecule</span><span class="o">.</span><span class="n">name</span><span class="p">())</span><span class="si">}</span><span class="s2">.opt.json&quot;</span><span class="p">,</span> <span class="s1">&#39;w+&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
                    <span class="n">json</span><span class="o">.</span><span class="n">dump</span><span class="p">(</span><span class="n">opt_data</span><span class="p">,</span> <span class="n">f</span><span class="p">,</span> <span class="n">indent</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>

            <span class="k">raise</span> <span class="n">OptimizationConvergenceError</span><span class="p">(</span><span class="s2">&quot;&quot;&quot;geometry optimization&quot;&quot;&quot;</span><span class="p">,</span> <span class="n">n</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span> <span class="n">wfn</span><span class="p">)</span>

        <span class="n">core</span><span class="o">.</span><span class="n">print_out</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">    Structure for next step:</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
        <span class="n">molecule</span><span class="o">.</span><span class="n">print_in_input_format</span><span class="p">()</span>

        <span class="n">n</span> <span class="o">+=</span> <span class="mi">1</span>

    <span class="n">optstash</span><span class="o">.</span><span class="n">restore</span><span class="p">()</span>
    <span class="k">raise</span> <span class="n">OptimizationConvergenceError</span><span class="p">(</span><span class="s2">&quot;&quot;&quot;geometry optimization&quot;&quot;&quot;</span><span class="p">,</span> <span class="n">n</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span> <span class="n">wfn</span><span class="p">)</span></div>


<div class="viewcode-block" id="hessian"><a class="viewcode-back" href="../../../freq.html#psi4.driver.hessian">[docs]</a><span class="k">def</span> <span class="nf">hessian</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
<span class="w">    </span><span class="sa">r</span><span class="sd">&quot;&quot;&quot;Function complementary to :py:func:`~psi4.driver.frequency`. Computes force</span>
<span class="sd">    constants, deciding analytic, finite difference of gradients, or</span>
<span class="sd">    finite difference of energies.</span>

<span class="sd">    :returns: :py:class:`~psi4.core.Matrix` |w--w| Total non-mass-weighted electronic Hessian in Hartrees/Bohr/Bohr.</span>

<span class="sd">    :returns: (:py:class:`~psi4.core.Matrix`, :py:class:`~psi4.core.Wavefunction`) |w--w| Hessian and wavefunction when **return_wfn** specified.</span>

<span class="sd">    :examples:</span>

<span class="sd">    &gt;&gt;&gt; # [1] Frequency calculation without thermochemical analysis</span>
<span class="sd">    &gt;&gt;&gt; hessian(&#39;mp3&#39;)</span>

<span class="sd">    &gt;&gt;&gt; # [2] Frequency calc w/o thermo analysis getting the Hessian</span>
<span class="sd">    &gt;&gt;&gt; #     in file, core.Matrix, and np.array forms</span>
<span class="sd">    &gt;&gt;&gt; set hessian_write on</span>
<span class="sd">    &gt;&gt;&gt; H, wfn = hessian(&#39;ccsd&#39;, return_wfn=True)</span>
<span class="sd">    &gt;&gt;&gt; wfn.hessian().print_out()</span>
<span class="sd">    &gt;&gt;&gt; np.array(H)</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1">## First half of this fn -- entry means user wants a 2nd derivative by any means</span>

    <span class="n">kwargs</span> <span class="o">=</span> <span class="n">p4util</span><span class="o">.</span><span class="n">kwargs_lower</span><span class="p">(</span><span class="n">kwargs</span><span class="p">)</span>
    <span class="n">basisstash</span> <span class="o">=</span> <span class="n">p4util</span><span class="o">.</span><span class="n">OptionsState</span><span class="p">([</span><span class="s1">&#39;BASIS&#39;</span><span class="p">])</span>
    <span class="n">return_wfn</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s1">&#39;return_wfn&#39;</span><span class="p">,</span> <span class="kc">False</span><span class="p">)</span>

    <span class="c1"># Make sure the molecule the user provided is the active one</span>
    <span class="n">molecule</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s1">&#39;molecule&#39;</span><span class="p">,</span> <span class="n">core</span><span class="o">.</span><span class="n">get_active_molecule</span><span class="p">())</span>
    <span class="n">molecule</span><span class="o">.</span><span class="n">update_geometry</span><span class="p">()</span>

    <span class="c1"># Convert wrapper directives from options (where ppl know to find them) to kwargs (suitable for non-globals transmitting)</span>
    <span class="n">kwargs</span><span class="p">[</span><span class="s1">&#39;findif_verbose&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">core</span><span class="o">.</span><span class="n">get_option</span><span class="p">(</span><span class="s2">&quot;FINDIF&quot;</span><span class="p">,</span> <span class="s2">&quot;PRINT&quot;</span><span class="p">)</span>
    <span class="n">kwargs</span><span class="p">[</span><span class="s1">&#39;findif_stencil_size&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">core</span><span class="o">.</span><span class="n">get_option</span><span class="p">(</span><span class="s2">&quot;FINDIF&quot;</span><span class="p">,</span> <span class="s2">&quot;POINTS&quot;</span><span class="p">)</span>
    <span class="n">kwargs</span><span class="p">[</span><span class="s1">&#39;findif_step_size&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">core</span><span class="o">.</span><span class="n">get_option</span><span class="p">(</span><span class="s2">&quot;FINDIF&quot;</span><span class="p">,</span> <span class="s2">&quot;DISP_SIZE&quot;</span><span class="p">)</span>

    <span class="c1"># Select certain irreps</span>
    <span class="n">irrep</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s1">&#39;irrep&#39;</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">irrep</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">:</span>
        <span class="k">pass</span>  <span class="c1"># do all irreps</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">irrep</span> <span class="o">=</span> <span class="n">driver_util</span><span class="o">.</span><span class="n">parse_cotton_irreps</span><span class="p">(</span><span class="n">irrep</span><span class="p">,</span> <span class="n">molecule</span><span class="o">.</span><span class="n">schoenflies_symbol</span><span class="p">())</span>
        <span class="n">irrep</span> <span class="o">-=</span> <span class="mi">1</span>  <span class="c1"># A1 irrep is externally 1, internally 0</span>
    <span class="n">kwargs</span><span class="p">[</span><span class="s1">&#39;findif_irrep&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">irrep</span>

    <span class="c1">## Pre-planning interventions</span>

    <span class="c1"># * Trip on function or alias as name</span>
    <span class="n">lowername</span> <span class="o">=</span> <span class="n">driver_util</span><span class="o">.</span><span class="n">upgrade_interventions</span><span class="p">(</span><span class="n">name</span><span class="p">)</span>
    <span class="n">_filter_renamed_methods</span><span class="p">(</span><span class="s2">&quot;hessian&quot;</span><span class="p">,</span> <span class="n">lowername</span><span class="p">)</span>

    <span class="c1"># * Prevent methods that do not have associated derivatives</span>
    <span class="k">if</span> <span class="n">lowername</span> <span class="ow">in</span> <span class="n">energy_only_methods</span><span class="p">:</span>
        <span class="k">raise</span> <span class="n">ValidationError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;`hessian(&#39;</span><span class="si">{</span><span class="n">name</span><span class="si">}</span><span class="s2">&#39;)` does not have an associated Hessian.&quot;</span><span class="p">)</span>

    <span class="c1"># * Avert pydantic anger at incomplete modelchem spec</span>
    <span class="n">userbas</span> <span class="o">=</span> <span class="n">core</span><span class="o">.</span><span class="n">get_global_option</span><span class="p">(</span><span class="s1">&#39;BASIS&#39;</span><span class="p">)</span> <span class="ow">or</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;basis&#39;</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">lowername</span> <span class="ow">in</span> <span class="n">integrated_basis_methods</span> <span class="ow">and</span> <span class="n">userbas</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">kwargs</span><span class="p">[</span><span class="s1">&#39;basis&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;(auto)&#39;</span>

    <span class="c1"># Are we planning?</span>
    <span class="n">plan</span> <span class="o">=</span> <span class="n">task_planner</span><span class="o">.</span><span class="n">task_planner</span><span class="p">(</span><span class="s2">&quot;hessian&quot;</span><span class="p">,</span> <span class="n">lowername</span><span class="p">,</span> <span class="n">molecule</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;HESSIAN PLAN&#39;</span><span class="p">)</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="n">pp</span><span class="o">.</span><span class="n">pformat</span><span class="p">(</span><span class="n">plan</span><span class="o">.</span><span class="n">dict</span><span class="p">()))</span>

    <span class="k">if</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;return_plan&quot;</span><span class="p">,</span> <span class="kc">False</span><span class="p">):</span>
        <span class="c1"># Plan-only requested</span>
        <span class="k">return</span> <span class="n">plan</span>

    <span class="k">elif</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">plan</span><span class="p">,</span> <span class="n">AtomicComputer</span><span class="p">):</span>
        <span class="c1"># Advanced &quot;Computer&quot; active</span>
        <span class="n">plan</span><span class="o">.</span><span class="n">compute</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">plan</span><span class="o">.</span><span class="n">get_psi_results</span><span class="p">(</span><span class="n">return_wfn</span><span class="o">=</span><span class="n">return_wfn</span><span class="p">)</span>

    <span class="k">else</span><span class="p">:</span>
        <span class="c1"># We have unpacked to an AtomicInput</span>
        <span class="n">lowername</span> <span class="o">=</span> <span class="n">plan</span><span class="o">.</span><span class="n">method</span>
        <span class="n">basis</span> <span class="o">=</span> <span class="n">plan</span><span class="o">.</span><span class="n">basis</span>
        <span class="n">core</span><span class="o">.</span><span class="n">set_global_option</span><span class="p">(</span><span class="s2">&quot;BASIS&quot;</span><span class="p">,</span> <span class="n">basis</span><span class="p">)</span>

    <span class="c1">## Second half of this fn -- entry means program running exactly analytic 2nd derivative</span>

    <span class="n">_filter_renamed_methods</span><span class="p">(</span><span class="s2">&quot;frequency&quot;</span><span class="p">,</span> <span class="n">lowername</span><span class="p">)</span>
    <span class="n">core</span><span class="o">.</span><span class="n">clean_variables</span><span class="p">()</span>

    <span class="n">optstash</span> <span class="o">=</span> <span class="n">p4util</span><span class="o">.</span><span class="n">OptionsState</span><span class="p">(</span>
        <span class="p">[</span><span class="s1">&#39;FINDIF&#39;</span><span class="p">,</span> <span class="s1">&#39;HESSIAN_WRITE&#39;</span><span class="p">],</span>
        <span class="p">[</span><span class="s1">&#39;FINDIF&#39;</span><span class="p">,</span> <span class="s1">&#39;FD_PROJECT&#39;</span><span class="p">],</span>
    <span class="p">)</span>

    <span class="c1"># Set method-dependent scf convergence criteria (test on procedures[&#39;energy&#39;] since that&#39;s guaranteed)</span>
    <span class="n">optstash_conv</span> <span class="o">=</span> <span class="n">driver_util</span><span class="o">.</span><span class="n">negotiate_convergence_criterion</span><span class="p">((</span><span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">),</span> <span class="n">lowername</span><span class="p">,</span> <span class="n">return_optstash</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

    <span class="c1"># At stationary point?</span>
    <span class="k">if</span> <span class="s1">&#39;ref_gradient&#39;</span> <span class="ow">in</span> <span class="n">kwargs</span><span class="p">:</span>
        <span class="n">core</span><span class="o">.</span><span class="n">print_out</span><span class="p">(</span><span class="s2">&quot;&quot;&quot;hessian() using ref_gradient to assess stationary point.</span><span class="se">\n</span><span class="s2">&quot;&quot;&quot;</span><span class="p">)</span>
        <span class="n">G0</span> <span class="o">=</span> <span class="n">kwargs</span><span class="p">[</span><span class="s1">&#39;ref_gradient&#39;</span><span class="p">]</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">tmpkwargs</span> <span class="o">=</span> <span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="n">tmpkwargs</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s1">&#39;dertype&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
        <span class="n">G0</span> <span class="o">=</span> <span class="n">gradient</span><span class="p">(</span><span class="n">lowername</span><span class="p">,</span> <span class="n">molecule</span><span class="o">=</span><span class="n">molecule</span><span class="p">,</span> <span class="o">**</span><span class="n">tmpkwargs</span><span class="p">)</span>
    <span class="n">translations_projection_sound</span><span class="p">,</span> <span class="n">rotations_projection_sound</span> <span class="o">=</span> <span class="n">_energy_is_invariant</span><span class="p">(</span><span class="n">G0</span><span class="o">.</span><span class="n">rms</span><span class="p">())</span>
    <span class="n">core</span><span class="o">.</span><span class="n">print_out</span><span class="p">(</span>
        <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">  Based on options and gradient (rms=</span><span class="si">{:.2E}</span><span class="s1">), recommend </span><span class="si">{}</span><span class="s1">projecting translations and </span><span class="si">{}</span><span class="s1">projecting rotations.</span><span class="se">\n</span><span class="s1">&#39;</span>
        <span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">G0</span><span class="o">.</span><span class="n">rms</span><span class="p">(),</span> <span class="s1">&#39;&#39;</span> <span class="k">if</span> <span class="n">translations_projection_sound</span> <span class="k">else</span> <span class="s1">&#39;not &#39;</span><span class="p">,</span>
                <span class="s1">&#39;&#39;</span> <span class="k">if</span> <span class="n">rotations_projection_sound</span> <span class="k">else</span> <span class="s1">&#39;not &#39;</span><span class="p">))</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">core</span><span class="o">.</span><span class="n">has_option_changed</span><span class="p">(</span><span class="s1">&#39;FINDIF&#39;</span><span class="p">,</span> <span class="s1">&#39;FD_PROJECT&#39;</span><span class="p">):</span>
        <span class="n">core</span><span class="o">.</span><span class="n">set_local_option</span><span class="p">(</span><span class="s1">&#39;FINDIF&#39;</span><span class="p">,</span> <span class="s1">&#39;FD_PROJECT&#39;</span><span class="p">,</span> <span class="n">rotations_projection_sound</span><span class="p">)</span>

    <span class="c1"># We have the desired method. Do it.</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Compute hessian(): method=</span><span class="si">{</span><span class="n">lowername</span><span class="si">}</span><span class="s2">, basis=</span><span class="si">{</span><span class="n">core</span><span class="o">.</span><span class="n">get_global_option</span><span class="p">(</span><span class="s1">&#39;BASIS&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span><span class="si">}</span><span class="s2">, molecule=</span><span class="si">{</span><span class="n">molecule</span><span class="o">.</span><span class="n">name</span><span class="p">()</span><span class="si">}</span><span class="s2">, nre=</span><span class="si">{</span><span class="s1">&#39;w/EFP&#39;</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="nb">hasattr</span><span class="p">(</span><span class="n">molecule</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;EFP&#39;</span><span class="p">)</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="n">molecule</span><span class="o">.</span><span class="n">nuclear_repulsion_energy</span><span class="p">()</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;w/EFP&quot;</span> <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">molecule</span><span class="p">,</span> <span class="s2">&quot;EFP&quot;</span><span class="p">)</span> <span class="k">else</span> <span class="n">pp</span><span class="o">.</span><span class="n">pformat</span><span class="p">(</span><span class="n">molecule</span><span class="o">.</span><span class="n">to_dict</span><span class="p">()))</span>
    <span class="n">core</span><span class="o">.</span><span class="n">print_out</span><span class="p">(</span><span class="s2">&quot;&quot;&quot;hessian() will perform analytic frequency computation.</span><span class="se">\n</span><span class="s2">&quot;&quot;&quot;</span><span class="p">)</span>
    <span class="n">wfn</span> <span class="o">=</span> <span class="n">procedures</span><span class="p">[</span><span class="s1">&#39;hessian&#39;</span><span class="p">][</span><span class="n">lowername</span><span class="p">](</span><span class="n">lowername</span><span class="p">,</span> <span class="n">molecule</span><span class="o">=</span><span class="n">molecule</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Return hessian(): </span><span class="si">{</span><span class="n">wfn</span><span class="o">.</span><span class="n">energy</span><span class="p">()</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="n">nppp</span><span class="p">(</span><span class="n">wfn</span><span class="o">.</span><span class="n">hessian</span><span class="p">()</span><span class="o">.</span><span class="n">np</span><span class="p">))</span>

    <span class="n">wfn</span><span class="o">.</span><span class="n">set_gradient</span><span class="p">(</span><span class="n">G0</span><span class="p">)</span>
    <span class="n">basisstash</span><span class="o">.</span><span class="n">restore</span><span class="p">()</span>
    <span class="n">optstash</span><span class="o">.</span><span class="n">restore</span><span class="p">()</span>
    <span class="n">optstash_conv</span><span class="o">.</span><span class="n">restore</span><span class="p">()</span>

    <span class="c1">#if isinstance(lowername, str) and lowername in procedures[&#39;energy&#39;]:</span>
    <span class="c1">#    # this correctly filters out cbs fn and &quot;hf/cc-pvtz&quot;</span>
    <span class="c1">#    # it probably incorrectly filters out mp5, but reconsider in DDD</span>
    <span class="c1">#    core.set_variable(f&quot;CURRENT HESSIAN&quot;, H)</span>
    <span class="c1">#    core.set_variable(f&quot;{lowername.upper()} TOTAL HESSIAN&quot;, H)</span>
    <span class="c1">#    core.set_variable(f&quot;{lowername.upper()} TOTAL GRADIENT&quot;, G0)</span>
    <span class="c1">#    wfn.set_variable(f&quot;{lowername.upper()} TOTAL HESSIAN&quot;, H)</span>
    <span class="c1">#    wfn.set_variable(f&quot;{lowername.upper()} TOTAL GRADIENT&quot;, G0)</span>
    <span class="c1"># TODO: check that current energy&#39;s being set to the right figure when this code is actually used</span>
    <span class="n">core</span><span class="o">.</span><span class="n">set_variable</span><span class="p">(</span><span class="s1">&#39;CURRENT ENERGY&#39;</span><span class="p">,</span> <span class="n">wfn</span><span class="o">.</span><span class="n">energy</span><span class="p">())</span>
    <span class="n">core</span><span class="o">.</span><span class="n">set_variable</span><span class="p">(</span><span class="s2">&quot;CURRENT GRADIENT&quot;</span><span class="p">,</span> <span class="n">G0</span><span class="p">)</span>
    <span class="n">driver_findif</span><span class="o">.</span><span class="n">hessian_write</span><span class="p">(</span><span class="n">wfn</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">return_wfn</span><span class="p">:</span>
        <span class="k">return</span> <span class="p">(</span><span class="n">wfn</span><span class="o">.</span><span class="n">hessian</span><span class="p">(),</span> <span class="n">wfn</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">wfn</span><span class="o">.</span><span class="n">hessian</span><span class="p">()</span></div>


<div class="viewcode-block" id="frequency"><a class="viewcode-back" href="../../../freq.html#psi4.driver.frequency">[docs]</a><span class="k">def</span> <span class="nf">frequency</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
<span class="w">    </span><span class="sa">r</span><span class="sd">&quot;&quot;&quot;Function to compute harmonic vibrational frequencies.</span>

<span class="sd">    :aliases: frequencies(), freq()</span>

<span class="sd">    :returns: *float* |w--w| Total electronic energy in Hartrees.</span>

<span class="sd">    :returns: (*float*, :py:class:`~psi4.core.Wavefunction`) |w--w| energy and wavefunction when **return_wfn** specified.</span>

<span class="sd">    :type name: str</span>
<span class="sd">    :param name: ``&#39;scf&#39;`` || ``&#39;mp2&#39;`` || ``&#39;ci5&#39;`` || etc.</span>

<span class="sd">        First argument, usually unlabeled. Indicates the computational method</span>
<span class="sd">        to be applied to the system.</span>

<span class="sd">    :type molecule: :ref:`molecule &lt;op_py_molecule&gt;`</span>
<span class="sd">    :param molecule: ``h2o`` || etc.</span>

<span class="sd">        The target molecule, if not the last molecule defined.</span>

<span class="sd">    :type return_wfn: :ref:`boolean &lt;op_py_boolean&gt;`</span>
<span class="sd">    :param return_wfn: ``&#39;on&#39;`` || |dl| ``&#39;off&#39;`` |dr|</span>

<span class="sd">        Indicate to additionally return the :py:class:`~psi4.core.Wavefunction`</span>
<span class="sd">        calculation result as the second element (after *float* energy) of a tuple.</span>
<span class="sd">        Arrays of frequencies and the Hessian can be accessed through the wavefunction.</span>

<span class="sd">    :type func: :ref:`function &lt;op_py_function&gt;`</span>
<span class="sd">    :param func: |dl| ``gradient`` |dr| || ``energy`` || ``cbs``</span>

<span class="sd">        Indicates the type of calculation to be performed on the molecule.</span>
<span class="sd">        The default dertype accesses ``&#39;gradient&#39;`` or ``&#39;energy&#39;``, while</span>
<span class="sd">        ``&#39;cbs&#39;`` performs a multistage finite difference calculation.</span>
<span class="sd">        If a nested series of python functions is intended (see :ref:`sec:intercalls`),</span>
<span class="sd">        use keyword ``freq_func`` instead of ``func``.</span>

<span class="sd">    :type dertype: :ref:`dertype &lt;op_py_dertype&gt;`</span>
<span class="sd">    :param dertype: |dl| ``&#39;hessian&#39;`` |dr| || ``&#39;gradient&#39;`` || ``&#39;energy&#39;``</span>

<span class="sd">        Indicates whether analytic (if available- they&#39;re not), finite</span>
<span class="sd">        difference of gradients (if available) or finite difference of</span>
<span class="sd">        energies is to be performed.</span>

<span class="sd">    :type irrep: int or str</span>
<span class="sd">    :param irrep: |dl| ``-1`` |dr| || ``1`` || ``&#39;b2&#39;`` || ``&#39;App&#39;`` || etc.</span>

<span class="sd">        Indicates which symmetry block (:ref:`Cotton &lt;table:irrepOrdering&gt;` ordering) of vibrational</span>
<span class="sd">        frequencies to be computed. ``1``, ``&#39;1&#39;``, or ``&#39;a1&#39;`` represents</span>
<span class="sd">        :math:`a_1`, requesting only the totally symmetric modes.</span>
<span class="sd">        ``-1`` indicates a full frequency calculation.</span>

<span class="sd">    .. note:: Analytic hessians are only available for RHF and UHF. For all other methods, Frequencies will</span>
<span class="sd">        proceed through finite differences according to availability of gradients or energies.</span>

<span class="sd">    .. _`table:freq_gen`:</span>

<span class="sd">    +-------------------------+-----------------------------------------------------------------------------------------------------------------+</span>
<span class="sd">    | name                    | calls method                                                                                                    |</span>
<span class="sd">    +=========================+=================================================================================================================+</span>
<span class="sd">    | scf                     | Hartree--Fock (HF) or LSDA density functional theory (DFT) :ref:`[manual] &lt;sec:scf&gt;` :ref:`[details] &lt;dd_svwn&gt;` |</span>
<span class="sd">    +-------------------------+-----------------------------------------------------------------------------------------------------------------+</span>

<span class="sd">    :examples:</span>

<span class="sd">    &gt;&gt;&gt; # [1] Frequency calculation for all modes through highest available derivatives</span>
<span class="sd">    &gt;&gt;&gt; frequency(&#39;ccsd&#39;)</span>

<span class="sd">    &gt;&gt;&gt; # [2] Frequency calculation for b2 modes through finite difference of gradients</span>
<span class="sd">    &gt;&gt;&gt; #     printing lowest mode frequency to screen and Hessian to output</span>
<span class="sd">    &gt;&gt;&gt; E, wfn = frequencies(&#39;scf&#39;, dertype=1, irrep=4, return_wfn=True)</span>
<span class="sd">    &gt;&gt;&gt; print wfn.frequencies().get(0, 0)</span>
<span class="sd">    &gt;&gt;&gt; wfn.hessian().print_out()</span>

<span class="sd">    &gt;&gt;&gt; # [3] Frequency calculation at default conditions and Hessian reuse at STP</span>
<span class="sd">    &gt;&gt;&gt; E, wfn = freq(&#39;mp2&#39;, return_wfn=True)</span>
<span class="sd">    &gt;&gt;&gt; set t 273.15</span>
<span class="sd">    &gt;&gt;&gt; set p 100000</span>
<span class="sd">    &gt;&gt;&gt; thermo(wfn, wfn.frequencies())</span>

<span class="sd">    &gt;&gt;&gt; # [4] Opt+Freq, skipping the gradient recalc at the start of the Hessian</span>
<span class="sd">    &gt;&gt;&gt; e, wfn = optimize(&#39;hf&#39;, return_wfn=True)</span>
<span class="sd">    &gt;&gt;&gt; frequencies(&#39;hf&#39;, ref_gradient=wfn.gradient())</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">kwargs</span> <span class="o">=</span> <span class="n">p4util</span><span class="o">.</span><span class="n">kwargs_lower</span><span class="p">(</span><span class="n">kwargs</span><span class="p">)</span>

    <span class="n">return_wfn</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s1">&#39;return_wfn&#39;</span><span class="p">,</span> <span class="kc">False</span><span class="p">)</span>

    <span class="c1"># Make sure the molecule the user provided is the active one</span>
    <span class="n">molecule</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s1">&#39;molecule&#39;</span><span class="p">,</span> <span class="n">core</span><span class="o">.</span><span class="n">get_active_molecule</span><span class="p">())</span>
    <span class="n">molecule</span><span class="o">.</span><span class="n">update_geometry</span><span class="p">()</span>

    <span class="c1"># Compute the hessian</span>
    <span class="n">H</span><span class="p">,</span> <span class="n">wfn</span> <span class="o">=</span> <span class="n">hessian</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">return_wfn</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">molecule</span><span class="o">=</span><span class="n">molecule</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>

    <span class="c1"># Project final frequencies?</span>
    <span class="k">if</span> <span class="n">wfn</span><span class="o">.</span><span class="n">gradient</span><span class="p">():</span>  <span class="c1"># available for analytic and any findif including totally symmetric space</span>
        <span class="n">gradient_rms</span> <span class="o">=</span> <span class="n">wfn</span><span class="o">.</span><span class="n">gradient</span><span class="p">()</span><span class="o">.</span><span class="n">rms</span><span class="p">()</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">gradient_rms</span> <span class="o">=</span> <span class="mi">1</span>  <span class="c1"># choose to force non-projection of rotations</span>
    <span class="n">translations_projection_sound</span><span class="p">,</span> <span class="n">rotations_projection_sound</span> <span class="o">=</span> <span class="n">_energy_is_invariant</span><span class="p">(</span><span class="n">gradient_rms</span><span class="p">)</span>

    <span class="n">project_trans</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;project_trans&#39;</span><span class="p">,</span> <span class="n">translations_projection_sound</span><span class="p">)</span>
    <span class="n">project_rot</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;project_rot&#39;</span><span class="p">,</span> <span class="n">rotations_projection_sound</span><span class="p">)</span>

    <span class="n">irrep</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;irrep&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
    <span class="n">vibinfo</span> <span class="o">=</span> <span class="n">vibanal_wfn</span><span class="p">(</span><span class="n">wfn</span><span class="p">,</span> <span class="n">irrep</span><span class="o">=</span><span class="n">irrep</span><span class="p">,</span> <span class="n">project_trans</span><span class="o">=</span><span class="n">project_trans</span><span class="p">,</span> <span class="n">project_rot</span><span class="o">=</span><span class="n">project_rot</span><span class="p">)</span>
    <span class="n">wfn</span><span class="o">.</span><span class="n">frequency_analysis</span> <span class="o">=</span> <span class="n">vibinfo</span>

    <span class="k">for</span> <span class="n">postcallback</span> <span class="ow">in</span> <span class="n">hooks</span><span class="p">[</span><span class="s1">&#39;frequency&#39;</span><span class="p">][</span><span class="s1">&#39;post&#39;</span><span class="p">]:</span>
        <span class="n">postcallback</span><span class="p">(</span><span class="n">lowername</span><span class="p">,</span> <span class="n">wfn</span><span class="o">=</span><span class="n">wfn</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">return_wfn</span><span class="p">:</span>
        <span class="k">return</span> <span class="p">(</span><span class="n">core</span><span class="o">.</span><span class="n">variable</span><span class="p">(</span><span class="s1">&#39;CURRENT ENERGY&#39;</span><span class="p">),</span> <span class="n">wfn</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">core</span><span class="o">.</span><span class="n">variable</span><span class="p">(</span><span class="s1">&#39;CURRENT ENERGY&#39;</span><span class="p">)</span></div>


<div class="viewcode-block" id="vibanal_wfn"><a class="viewcode-back" href="../../../api/psi4.driver.vibanal_wfn.html#psi4.driver.vibanal_wfn">[docs]</a><span class="k">def</span> <span class="nf">vibanal_wfn</span><span class="p">(</span>
    <span class="n">wfn</span><span class="p">:</span> <span class="n">core</span><span class="o">.</span><span class="n">Wavefunction</span><span class="p">,</span>
    <span class="n">hess</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">irrep</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Union</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="nb">str</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">molecule</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="n">project_trans</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
    <span class="n">project_rot</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">]:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Function to perform analysis of a hessian or hessian block, specifically...</span>
<span class="sd">    calling for and printing vibrational and thermochemical analysis, setting thermochemical variables,</span>
<span class="sd">    and writing the vibrec and normal mode files.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    wfn</span>
<span class="sd">        The wavefunction which had its Hessian computed.</span>
<span class="sd">    hess</span>
<span class="sd">        Hessian to analyze, if not the hessian in wfn.</span>
<span class="sd">        (3*nat, 3*nat) non-mass-weighted Hessian in atomic units, [Eh/a0/a0].</span>
<span class="sd">    irrep</span>
<span class="sd">        The irrep for which frequencies are calculated. Thermochemical analysis</span>
<span class="sd">        is skipped if this is specified (non-None),</span>
<span class="sd">        as only one symmetry block of the hessian has been computed.</span>
<span class="sd">    molecule : :py:class:`~psi4.core.Molecule` or qcdb.Molecule, optional</span>
<span class="sd">        The molecule to pull information from, if not the molecule in wfn. Must at least have similar</span>
<span class="sd">        geometry to the molecule in wfn.</span>
<span class="sd">    project_trans</span>
<span class="sd">        Should translations be projected in the harmonic analysis?</span>
<span class="sd">    project_rot</span>
<span class="sd">        Should rotations be projected in the harmonic analysis?</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    vibinfo : ~typing.Dict[str, ~numpy.ndarray]</span>
<span class="sd">        A dictionary of vibrational information. See :py:func:`~psi4.driver.qcdb.vib.harmonic_analysis`</span>

<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">if</span> <span class="n">hess</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">nmwhess</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">wfn</span><span class="o">.</span><span class="n">hessian</span><span class="p">())</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">nmwhess</span> <span class="o">=</span> <span class="n">hess</span>

    <span class="n">dipder</span> <span class="o">=</span> <span class="n">wfn</span><span class="o">.</span><span class="n">variables</span><span class="p">()</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;CURRENT DIPOLE GRADIENT&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">dipder</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">dipder</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">dipder</span><span class="p">)</span><span class="o">.</span><span class="n">T</span>

    <span class="n">mol</span> <span class="o">=</span> <span class="n">wfn</span><span class="o">.</span><span class="n">molecule</span><span class="p">()</span>
    <span class="n">geom</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">mol</span><span class="o">.</span><span class="n">geometry</span><span class="p">())</span>
    <span class="n">symbols</span> <span class="o">=</span> <span class="p">[</span><span class="n">mol</span><span class="o">.</span><span class="n">symbol</span><span class="p">(</span><span class="n">at</span><span class="p">)</span> <span class="k">for</span> <span class="n">at</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">mol</span><span class="o">.</span><span class="n">natom</span><span class="p">())]</span>

    <span class="n">vibrec</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;molecule&#39;</span><span class="p">:</span> <span class="n">mol</span><span class="o">.</span><span class="n">to_dict</span><span class="p">(</span><span class="n">np_out</span><span class="o">=</span><span class="kc">False</span><span class="p">),</span> <span class="s1">&#39;hessian&#39;</span><span class="p">:</span> <span class="n">nmwhess</span><span class="o">.</span><span class="n">tolist</span><span class="p">()}</span>

    <span class="k">if</span> <span class="n">molecule</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">molecule</span><span class="o">.</span><span class="n">update_geometry</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">mol</span><span class="o">.</span><span class="n">natom</span><span class="p">()</span> <span class="o">!=</span> <span class="n">molecule</span><span class="o">.</span><span class="n">natom</span><span class="p">():</span>
            <span class="k">raise</span> <span class="n">ValidationError</span><span class="p">(</span><span class="s1">&#39;Impostor molecule trying to be analyzed! natom </span><span class="si">{}</span><span class="s1"> != </span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                <span class="n">mol</span><span class="o">.</span><span class="n">natom</span><span class="p">(),</span> <span class="n">molecule</span><span class="o">.</span><span class="n">natom</span><span class="p">()))</span>
        <span class="k">if</span> <span class="nb">abs</span><span class="p">(</span><span class="n">mol</span><span class="o">.</span><span class="n">nuclear_repulsion_energy</span><span class="p">()</span> <span class="o">-</span> <span class="n">molecule</span><span class="o">.</span><span class="n">nuclear_repulsion_energy</span><span class="p">())</span> <span class="o">&gt;</span> <span class="mf">1.e-6</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">ValidationError</span><span class="p">(</span><span class="s1">&#39;Impostor molecule trying to be analyzed! NRE </span><span class="si">{}</span><span class="s1"> != </span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                <span class="n">mol</span><span class="o">.</span><span class="n">nuclear_repulsion_energy</span><span class="p">(),</span> <span class="n">molecule</span><span class="o">.</span><span class="n">nuclear_repulsion_energy</span><span class="p">()))</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">np</span><span class="o">.</span><span class="n">allclose</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">mol</span><span class="o">.</span><span class="n">geometry</span><span class="p">()),</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">molecule</span><span class="o">.</span><span class="n">geometry</span><span class="p">()),</span> <span class="n">atol</span><span class="o">=</span><span class="mf">1.e-6</span><span class="p">):</span>
            <span class="n">core</span><span class="o">.</span><span class="n">print_out</span><span class="p">(</span>
                <span class="s1">&#39;Warning: geometry center/orientation mismatch. Normal modes may not be in expected coordinate system.&#39;</span>
            <span class="p">)</span>
        <span class="c1">#    raise ValidationError(&#39;Impostor molecule trying to be analyzed! geometry\n{}\n   !=\n{}&#39;.format(</span>
        <span class="c1">#        np.asarray(mol.geometry()), np.asarray(molecule.geometry())))</span>
        <span class="n">mol</span> <span class="o">=</span> <span class="n">molecule</span>

    <span class="n">m</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">([</span><span class="n">mol</span><span class="o">.</span><span class="n">mass</span><span class="p">(</span><span class="n">at</span><span class="p">)</span> <span class="k">for</span> <span class="n">at</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">mol</span><span class="o">.</span><span class="n">natom</span><span class="p">())])</span>
    <span class="n">irrep_labels</span> <span class="o">=</span> <span class="n">mol</span><span class="o">.</span><span class="n">irrep_labels</span><span class="p">()</span>

    <span class="n">vibinfo</span><span class="p">,</span> <span class="n">vibtext</span> <span class="o">=</span> <span class="n">qcdb</span><span class="o">.</span><span class="n">vib</span><span class="o">.</span><span class="n">harmonic_analysis</span><span class="p">(</span><span class="n">nmwhess</span><span class="p">,</span>
                                                  <span class="n">geom</span><span class="p">,</span>
                                                  <span class="n">m</span><span class="p">,</span>
                                                  <span class="n">wfn</span><span class="o">.</span><span class="n">basisset</span><span class="p">(),</span>
                                                  <span class="n">irrep_labels</span><span class="p">,</span>
                                                  <span class="n">dipder</span><span class="o">=</span><span class="n">dipder</span><span class="p">,</span>
                                                  <span class="n">project_trans</span><span class="o">=</span><span class="n">project_trans</span><span class="p">,</span>
                                                  <span class="n">project_rot</span><span class="o">=</span><span class="n">project_rot</span><span class="p">)</span>
    <span class="n">vibrec</span><span class="o">.</span><span class="n">update</span><span class="p">({</span><span class="n">k</span><span class="p">:</span> <span class="n">qca</span><span class="o">.</span><span class="n">json</span><span class="p">()</span> <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">qca</span> <span class="ow">in</span> <span class="n">vibinfo</span><span class="o">.</span><span class="n">items</span><span class="p">()})</span>

    <span class="n">core</span><span class="o">.</span><span class="n">print_out</span><span class="p">(</span><span class="n">vibtext</span><span class="p">)</span>
    <span class="n">core</span><span class="o">.</span><span class="n">print_out</span><span class="p">(</span><span class="n">qcdb</span><span class="o">.</span><span class="n">vib</span><span class="o">.</span><span class="n">print_vibs</span><span class="p">(</span><span class="n">vibinfo</span><span class="p">,</span> <span class="n">shortlong</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">normco</span><span class="o">=</span><span class="s1">&#39;x&#39;</span><span class="p">,</span> <span class="n">atom_lbl</span><span class="o">=</span><span class="n">symbols</span><span class="p">))</span>

    <span class="k">if</span> <span class="n">core</span><span class="o">.</span><span class="n">has_option_changed</span><span class="p">(</span><span class="s1">&#39;THERMO&#39;</span><span class="p">,</span> <span class="s1">&#39;ROTATIONAL_SYMMETRY_NUMBER&#39;</span><span class="p">):</span>
        <span class="n">rsn</span> <span class="o">=</span> <span class="n">core</span><span class="o">.</span><span class="n">get_option</span><span class="p">(</span><span class="s1">&#39;THERMO&#39;</span><span class="p">,</span> <span class="s1">&#39;ROTATIONAL_SYMMETRY_NUMBER&#39;</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">rsn</span> <span class="o">=</span> <span class="n">mol</span><span class="o">.</span><span class="n">rotational_symmetry_number</span><span class="p">()</span>

    <span class="k">if</span> <span class="n">irrep</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">therminfo</span><span class="p">,</span> <span class="n">thermtext</span> <span class="o">=</span> <span class="n">qcdb</span><span class="o">.</span><span class="n">vib</span><span class="o">.</span><span class="n">thermo</span><span class="p">(</span>
            <span class="n">vibinfo</span><span class="p">,</span>
            <span class="n">T</span><span class="o">=</span><span class="n">core</span><span class="o">.</span><span class="n">get_option</span><span class="p">(</span><span class="s2">&quot;THERMO&quot;</span><span class="p">,</span> <span class="s2">&quot;T&quot;</span><span class="p">),</span>  <span class="c1"># 298.15 [K]</span>
            <span class="n">P</span><span class="o">=</span><span class="n">core</span><span class="o">.</span><span class="n">get_option</span><span class="p">(</span><span class="s2">&quot;THERMO&quot;</span><span class="p">,</span> <span class="s2">&quot;P&quot;</span><span class="p">),</span>  <span class="c1"># 101325. [Pa]</span>
            <span class="n">multiplicity</span><span class="o">=</span><span class="n">mol</span><span class="o">.</span><span class="n">multiplicity</span><span class="p">(),</span>
            <span class="n">molecular_mass</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">m</span><span class="p">),</span>
            <span class="n">sigma</span><span class="o">=</span><span class="n">rsn</span><span class="p">,</span>
            <span class="n">rotor_type</span><span class="o">=</span><span class="n">mol</span><span class="o">.</span><span class="n">rotor_type</span><span class="p">(),</span>
            <span class="n">rot_const</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">mol</span><span class="o">.</span><span class="n">rotational_constants</span><span class="p">()),</span>
            <span class="n">E0</span><span class="o">=</span><span class="n">core</span><span class="o">.</span><span class="n">variable</span><span class="p">(</span><span class="s1">&#39;CURRENT ENERGY&#39;</span><span class="p">))</span>  <span class="c1"># someday, wfn.energy()</span>
        <span class="n">vibrec</span><span class="o">.</span><span class="n">update</span><span class="p">({</span><span class="n">k</span><span class="p">:</span> <span class="n">qca</span><span class="o">.</span><span class="n">json</span><span class="p">()</span> <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">qca</span> <span class="ow">in</span> <span class="n">therminfo</span><span class="o">.</span><span class="n">items</span><span class="p">()})</span>

        <span class="n">core</span><span class="o">.</span><span class="n">set_variable</span><span class="p">(</span><span class="s2">&quot;ZPVE&quot;</span><span class="p">,</span> <span class="n">therminfo</span><span class="p">[</span><span class="s1">&#39;ZPE_corr&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">data</span><span class="p">)</span>  <span class="c1"># P::e THERMO</span>
        <span class="n">core</span><span class="o">.</span><span class="n">set_variable</span><span class="p">(</span><span class="s2">&quot;THERMAL ENERGY CORRECTION&quot;</span><span class="p">,</span> <span class="n">therminfo</span><span class="p">[</span><span class="s1">&#39;E_corr&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">data</span><span class="p">)</span>  <span class="c1"># P::e THERMO</span>
        <span class="n">core</span><span class="o">.</span><span class="n">set_variable</span><span class="p">(</span><span class="s2">&quot;ENTHALPY CORRECTION&quot;</span><span class="p">,</span> <span class="n">therminfo</span><span class="p">[</span><span class="s1">&#39;H_corr&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">data</span><span class="p">)</span>  <span class="c1"># P::e THERMO</span>
        <span class="n">core</span><span class="o">.</span><span class="n">set_variable</span><span class="p">(</span><span class="s2">&quot;GIBBS FREE ENERGY CORRECTION&quot;</span><span class="p">,</span> <span class="n">therminfo</span><span class="p">[</span><span class="s1">&#39;G_corr&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">data</span><span class="p">)</span>  <span class="c1"># P::e THERMO</span>

        <span class="n">core</span><span class="o">.</span><span class="n">set_variable</span><span class="p">(</span><span class="s2">&quot;ZERO K ENTHALPY&quot;</span><span class="p">,</span> <span class="n">therminfo</span><span class="p">[</span><span class="s1">&#39;ZPE_tot&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">data</span><span class="p">)</span>  <span class="c1"># P::e THERMO</span>
        <span class="n">core</span><span class="o">.</span><span class="n">set_variable</span><span class="p">(</span><span class="s2">&quot;THERMAL ENERGY&quot;</span><span class="p">,</span> <span class="n">therminfo</span><span class="p">[</span><span class="s1">&#39;E_tot&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">data</span><span class="p">)</span>  <span class="c1"># P::e THERMO</span>
        <span class="n">core</span><span class="o">.</span><span class="n">set_variable</span><span class="p">(</span><span class="s2">&quot;ENTHALPY&quot;</span><span class="p">,</span> <span class="n">therminfo</span><span class="p">[</span><span class="s1">&#39;H_tot&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">data</span><span class="p">)</span>  <span class="c1"># P::e THERMO</span>
        <span class="n">core</span><span class="o">.</span><span class="n">set_variable</span><span class="p">(</span><span class="s2">&quot;GIBBS FREE ENERGY&quot;</span><span class="p">,</span> <span class="n">therminfo</span><span class="p">[</span><span class="s1">&#39;G_tot&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">data</span><span class="p">)</span>  <span class="c1"># P::e THERMO</span>

        <span class="n">core</span><span class="o">.</span><span class="n">print_out</span><span class="p">(</span><span class="n">thermtext</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">core</span><span class="o">.</span><span class="n">print_out</span><span class="p">(</span><span class="s1">&#39;  Thermochemical analysis skipped for partial frequency calculation.</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">core</span><span class="o">.</span><span class="n">get_option</span><span class="p">(</span><span class="s1">&#39;FINDIF&#39;</span><span class="p">,</span> <span class="s1">&#39;HESSIAN_WRITE&#39;</span><span class="p">):</span>
        <span class="n">filename</span> <span class="o">=</span> <span class="n">core</span><span class="o">.</span><span class="n">get_writer_file_prefix</span><span class="p">(</span><span class="n">mol</span><span class="o">.</span><span class="n">name</span><span class="p">())</span> <span class="o">+</span> <span class="s2">&quot;.vibrec&quot;</span>
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="s1">&#39;w&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">handle</span><span class="p">:</span>
            <span class="n">json</span><span class="o">.</span><span class="n">dump</span><span class="p">(</span><span class="n">vibrec</span><span class="p">,</span> <span class="n">handle</span><span class="p">,</span> <span class="n">sort_keys</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">indent</span><span class="o">=</span><span class="mi">4</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">core</span><span class="o">.</span><span class="n">get_option</span><span class="p">(</span><span class="s1">&#39;FINDIF&#39;</span><span class="p">,</span> <span class="s1">&#39;NORMAL_MODES_WRITE&#39;</span><span class="p">):</span>
        <span class="n">filename</span> <span class="o">=</span> <span class="n">core</span><span class="o">.</span><span class="n">get_writer_file_prefix</span><span class="p">(</span><span class="n">mol</span><span class="o">.</span><span class="n">name</span><span class="p">())</span> <span class="o">+</span> <span class="s2">&quot;.molden_normal_modes&quot;</span>
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="s1">&#39;w&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">handle</span><span class="p">:</span>
            <span class="n">handle</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">qcdb</span><span class="o">.</span><span class="n">vib</span><span class="o">.</span><span class="n">print_molden_vibs</span><span class="p">(</span><span class="n">vibinfo</span><span class="p">,</span> <span class="n">symbols</span><span class="p">,</span> <span class="n">geom</span><span class="p">,</span> <span class="n">standalone</span><span class="o">=</span><span class="kc">True</span><span class="p">))</span>

    <span class="k">return</span> <span class="n">vibinfo</span></div>


<div class="viewcode-block" id="gdma"><a class="viewcode-back" href="../../../gdma.html#psi4.driver.gdma">[docs]</a><span class="k">def</span> <span class="nf">gdma</span><span class="p">(</span><span class="n">wfn</span><span class="p">,</span> <span class="n">datafile</span><span class="o">=</span><span class="s2">&quot;&quot;</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Function to use wavefunction information in *wfn* and, if specified,</span>
<span class="sd">    additional commands in *filename* to run GDMA analysis with A. J. Stone&#39;s program.</span>

<span class="sd">    .. versionadded:: 0.6</span>

<span class="sd">    :returns: None</span>

<span class="sd">    :type wfn: :py:class:`~psi4.core.Wavefunction`</span>
<span class="sd">    :param wfn: set of molecule, basis, orbitals from which to generate DMA analysis</span>

<span class="sd">    :type datafile: str</span>
<span class="sd">    :param datafile: optional control file (see GDMA manual) to peform more complicated DMA</span>
<span class="sd">                     analyses.  If this option is used, the File keyword must be set to read</span>
<span class="sd">                     a filename.fchk, where filename is provided by :term:`WRITER_FILE_LABEL &lt;WRITER_FILE_LABEL (GLOBALS)&gt;` .</span>

<span class="sd">    :examples:</span>

<span class="sd">    &gt;&gt;&gt; # [1] DMA analysis from MP2 wavefunction.  N.B. gradient must be requested to generate MP2 density.</span>
<span class="sd">    &gt;&gt;&gt; grad, wfn = gradient(&#39;mp2&#39;, return_wfn=True)</span>
<span class="sd">    &gt;&gt;&gt; gdma(wfn)</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># Start by writing a G* checkpoint file, for the GDMA code to read in</span>
    <span class="n">fw</span> <span class="o">=</span> <span class="n">core</span><span class="o">.</span><span class="n">FCHKWriter</span><span class="p">(</span><span class="n">wfn</span><span class="p">)</span>
    <span class="n">molname</span> <span class="o">=</span> <span class="n">wfn</span><span class="o">.</span><span class="n">molecule</span><span class="p">()</span><span class="o">.</span><span class="n">name</span><span class="p">()</span>
    <span class="n">prefix</span> <span class="o">=</span> <span class="n">core</span><span class="o">.</span><span class="n">get_writer_file_prefix</span><span class="p">(</span><span class="n">molname</span><span class="p">)</span>
    <span class="n">fchkfile</span> <span class="o">=</span> <span class="n">prefix</span> <span class="o">+</span> <span class="s1">&#39;.fchk&#39;</span>
    <span class="n">fw</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">fchkfile</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">datafile</span><span class="p">:</span>
        <span class="n">commands</span> <span class="o">=</span> <span class="n">datafile</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">wfn</span><span class="o">.</span><span class="n">reference_wavefunction</span><span class="p">():</span>
            <span class="n">densname</span> <span class="o">=</span> <span class="s2">&quot;CC&quot;</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">densname</span> <span class="o">=</span> <span class="s2">&quot;SCF&quot;</span>
        <span class="n">commands</span> <span class="o">=</span> <span class="s1">&#39;psi4_dma_datafile.dma&#39;</span>
        <span class="n">radii</span> <span class="o">=</span> <span class="n">core</span><span class="o">.</span><span class="n">get_option</span><span class="p">(</span><span class="s1">&#39;GDMA&#39;</span><span class="p">,</span> <span class="s1">&#39;GDMA_RADIUS&#39;</span><span class="p">)</span>
        <span class="n">origin</span> <span class="o">=</span> <span class="n">core</span><span class="o">.</span><span class="n">get_option</span><span class="p">(</span><span class="s1">&#39;GDMA&#39;</span><span class="p">,</span> <span class="s1">&#39;GDMA_ORIGIN&#39;</span><span class="p">)</span>
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">commands</span><span class="p">,</span> <span class="s1">&#39;w&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
            <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;File </span><span class="si">%s</span><span class="s2"> Density </span><span class="si">%s</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">fchkfile</span><span class="p">,</span> <span class="n">densname</span><span class="p">))</span>
            <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;Angstrom</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">%s</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">core</span><span class="o">.</span><span class="n">get_option</span><span class="p">(</span><span class="s1">&#39;GDMA&#39;</span><span class="p">,</span> <span class="s1">&#39;GDMA_MULTIPOLE_UNITS&#39;</span><span class="p">))</span>
            <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;Multipoles</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">origin</span><span class="p">:</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;Origin </span><span class="si">%f</span><span class="s2"> </span><span class="si">%f</span><span class="s2"> </span><span class="si">%f</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="nb">float</span><span class="p">(</span><span class="n">origin</span><span class="p">[</span><span class="mi">0</span><span class="p">]),</span> <span class="nb">float</span><span class="p">(</span><span class="n">origin</span><span class="p">[</span><span class="mi">1</span><span class="p">]),</span> <span class="nb">float</span><span class="p">(</span><span class="n">origin</span><span class="p">[</span><span class="mi">2</span><span class="p">])))</span>
                <span class="k">except</span> <span class="ne">IndexError</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="n">ValidationError</span><span class="p">(</span><span class="s2">&quot;The GDMA origin array should contain three entries: x, y, and z.&quot;</span><span class="p">)</span>
            <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;Switch </span><span class="si">%f</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">core</span><span class="o">.</span><span class="n">get_option</span><span class="p">(</span><span class="s1">&#39;GDMA&#39;</span><span class="p">,</span> <span class="s1">&#39;GDMA_SWITCH&#39;</span><span class="p">))</span>
            <span class="k">if</span> <span class="n">radii</span><span class="p">:</span>
                <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;Radius </span><span class="si">%s</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="s2">&quot; &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="nb">str</span><span class="p">(</span><span class="n">r</span><span class="p">)</span> <span class="k">for</span> <span class="n">r</span> <span class="ow">in</span> <span class="n">radii</span><span class="p">]))</span>
            <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;Limit </span><span class="si">%d</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">core</span><span class="o">.</span><span class="n">get_option</span><span class="p">(</span><span class="s1">&#39;GDMA&#39;</span><span class="p">,</span> <span class="s1">&#39;GDMA_LIMIT&#39;</span><span class="p">))</span>
            <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;Start</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;Finish</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>

    <span class="c1"># from outside the Psi4 ecosystem</span>
    <span class="kn">from</span> <span class="nn">qcelemental.util</span> <span class="kn">import</span> <span class="n">which_import</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">which_import</span><span class="p">(</span><span class="s2">&quot;gdma&quot;</span><span class="p">,</span> <span class="n">return_bool</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
        <span class="k">raise</span> <span class="ne">ModuleNotFoundError</span><span class="p">(</span><span class="s1">&#39;Python module gdma not found. Solve by installing it: `conda install -c conda-forge gdma` or recompile with `-DENABLE_gdma`&#39;</span><span class="p">)</span>
    <span class="kn">import</span> <span class="nn">gdma</span>

    <span class="n">min_version</span> <span class="o">=</span> <span class="s2">&quot;2.3.3&quot;</span>
    <span class="kn">from</span> <span class="nn">pkg_resources</span> <span class="kn">import</span> <span class="n">parse_version</span>
    <span class="k">if</span> <span class="n">parse_version</span><span class="p">(</span><span class="n">gdma</span><span class="o">.</span><span class="n">__version__</span><span class="p">)</span> <span class="o">&lt;</span> <span class="n">parse_version</span><span class="p">(</span><span class="n">min_version</span><span class="p">):</span>
        <span class="k">raise</span> <span class="ne">ModuleNotFoundError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;GDMA version </span><span class="si">{</span><span class="n">min_version</span><span class="si">}</span><span class="s2"> is required at least. Version </span><span class="si">{</span><span class="n">gdma</span><span class="o">.</span><span class="n">__version__</span><span class="si">}</span><span class="s2"> was found.&quot;</span><span class="p">)</span>

    <span class="n">core</span><span class="o">.</span><span class="n">prepare_options_for_module</span><span class="p">(</span><span class="s2">&quot;GDMA&quot;</span><span class="p">)</span>

    <span class="n">gof</span> <span class="o">=</span> <span class="n">core</span><span class="o">.</span><span class="n">get_output_file</span><span class="p">()</span>
    <span class="n">gdma</span><span class="o">.</span><span class="n">run_gdma</span><span class="p">(</span><span class="n">gof</span><span class="p">,</span> <span class="n">commands</span><span class="p">)</span>
    <span class="n">core</span><span class="o">.</span><span class="n">set_output_file</span><span class="p">(</span><span class="n">gof</span><span class="p">,</span> <span class="kc">True</span><span class="p">)</span>
    <span class="n">core</span><span class="o">.</span><span class="n">reopen_outfile</span><span class="p">()</span>

    <span class="n">nsites</span> <span class="o">=</span> <span class="n">gdma</span><span class="o">.</span><span class="n">get_nsites</span><span class="p">()</span>
    <span class="n">maxorder</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">gdma</span><span class="o">.</span><span class="n">get_order</span><span class="p">(</span><span class="n">site</span><span class="p">)</span> <span class="k">for</span> <span class="n">site</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">nsites</span> <span class="o">+</span> <span class="mi">1</span><span class="p">))</span>

    <span class="n">nvals</span> <span class="o">=</span> <span class="p">(</span><span class="n">maxorder</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="n">maxorder</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>
    <span class="n">dmavals</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">nsites</span><span class="p">,</span> <span class="n">nvals</span><span class="p">))</span>
    <span class="k">for</span> <span class="n">site</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">nsites</span> <span class="o">+</span> <span class="mi">1</span><span class="p">):</span>
        <span class="n">site_order</span> <span class="o">=</span> <span class="n">gdma</span><span class="o">.</span><span class="n">get_order</span><span class="p">(</span><span class="n">site</span><span class="p">)</span>
        <span class="n">site_nvals</span> <span class="o">=</span> <span class="p">(</span><span class="n">site_order</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="n">site_order</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">n</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">site_nvals</span> <span class="o">+</span> <span class="mi">1</span><span class="p">):</span>
            <span class="n">dmavals</span><span class="p">[</span><span class="n">site</span> <span class="o">-</span> <span class="mi">1</span><span class="p">][</span><span class="n">n</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">gdma</span><span class="o">.</span><span class="n">get_dma_value</span><span class="p">(</span><span class="n">site</span><span class="p">,</span> <span class="n">n</span><span class="p">)</span>
    <span class="n">dmavals</span> <span class="o">=</span> <span class="n">core</span><span class="o">.</span><span class="n">Matrix</span><span class="o">.</span><span class="n">from_array</span><span class="p">(</span><span class="n">dmavals</span><span class="p">)</span>
    <span class="n">dmavals</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="s2">&quot;Spherical Harmonic DMA for each site&quot;</span>

    <span class="n">totvals</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="mi">1</span><span class="p">,</span> <span class="n">nvals</span><span class="p">))</span>
    <span class="k">for</span> <span class="n">n</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">nvals</span> <span class="o">+</span> <span class="mi">1</span><span class="p">):</span>
        <span class="n">totvals</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="n">n</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">gdma</span><span class="o">.</span><span class="n">get_tot_value</span><span class="p">(</span><span class="n">n</span><span class="p">)</span>
    <span class="n">totvals</span> <span class="o">=</span> <span class="n">core</span><span class="o">.</span><span class="n">Matrix</span><span class="o">.</span><span class="n">from_array</span><span class="p">(</span><span class="n">totvals</span><span class="p">)</span>
    <span class="n">totvals</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="s2">&quot;Total multipoles, translated to the origin&quot;</span>

    <span class="n">wfn</span><span class="o">.</span><span class="n">set_variable</span><span class="p">(</span><span class="s2">&quot;DMA DISTRIBUTED MULTIPOLES&quot;</span><span class="p">,</span> <span class="n">dmavals</span><span class="p">)</span>  <span class="c1"># P::e GDMA</span>
    <span class="n">wfn</span><span class="o">.</span><span class="n">set_variable</span><span class="p">(</span><span class="s2">&quot;DMA TOTAL MULTIPOLES&quot;</span><span class="p">,</span> <span class="n">totvals</span><span class="p">)</span>  <span class="c1"># P::e GDMA</span>
    <span class="n">core</span><span class="o">.</span><span class="n">set_variable</span><span class="p">(</span><span class="s2">&quot;DMA DISTRIBUTED MULTIPOLES&quot;</span><span class="p">,</span> <span class="n">dmavals</span><span class="p">)</span>  <span class="c1"># P::e GDMA</span>
    <span class="n">core</span><span class="o">.</span><span class="n">set_variable</span><span class="p">(</span><span class="s2">&quot;DMA TOTAL MULTIPOLES&quot;</span><span class="p">,</span> <span class="n">totvals</span><span class="p">)</span>  <span class="c1"># P::e GDMA</span>
    <span class="n">core</span><span class="o">.</span><span class="n">print_out</span><span class="p">(</span><span class="s2">&quot;&quot;&quot;</span>
<span class="s2">  DMA results are available in the Python driver through the commands:</span>
<span class="s2">  variable(&#39;DMA DISTRIBUTED MULTIPOLES&#39;)</span>
<span class="s2">  variable(&#39;DMA TOTAL MULTIPOLES&#39;)</span>

<span class="s2">&quot;&quot;&quot;</span><span class="p">)</span>

    <span class="n">os</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">fchkfile</span><span class="p">)</span>
    <span class="c1"># If we generated the DMA control file, we should clean up here</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">datafile</span><span class="p">:</span>
        <span class="n">os</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">commands</span><span class="p">)</span></div>


<div class="viewcode-block" id="fchk"><a class="viewcode-back" href="../../../fchk.html#psi4.driver.fchk">[docs]</a><span class="k">def</span> <span class="nf">fchk</span><span class="p">(</span><span class="n">wfn</span><span class="p">:</span> <span class="n">core</span><span class="o">.</span><span class="n">Wavefunction</span><span class="p">,</span> <span class="n">filename</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="o">*</span><span class="p">,</span> <span class="n">debug</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span> <span class="n">strict_label</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Function to write wavefunction information in *wfn* to *filename* in</span>
<span class="sd">    Gaussian FCHK format.</span>

<span class="sd">    .. versionadded:: 0.6</span>

<span class="sd">    :returns: None</span>

<span class="sd">    :param wfn: set of molecule, basis, orbitals from which to generate fchk file</span>

<span class="sd">    :param filename: destination file name for FCHK file</span>

<span class="sd">    :param debug: returns a dictionary to aid with debugging</span>

<span class="sd">    :param strict_label: If true set a density label compliant with what Gaussian would write. A warning will be printed if this is not possible.</span>
<span class="sd">                         Otherwise set the density label according to the method name.</span>

<span class="sd">    Notes</span>
<span class="sd">    -----</span>
<span class="sd">    * A description of the FCHK format is http://wild.life.nctu.edu.tw/~jsyu/compchem/g09/g09ur/f_formchk.htm</span>
<span class="sd">    * The allowed headers for methods are general and limited, i.e., &quot;Total SCF|MP2|CI|CC Density&quot;,</span>
<span class="sd">      PSI4 will try to find the right one for the current calculation. If `strict_label=False` the PSI4 method name will be used as label.</span>
<span class="sd">    * Not all theory modules in PSI4 are compatible with the FCHK writer.</span>
<span class="sd">      A warning will be printed if a theory module is not supported.</span>
<span class="sd">    * Caution! For orbital-optimized correlated methods (e.g. DCT, OMP2) the &#39;Orbital Energy&#39; field contains ambiguous data.</span>

<span class="sd">    :examples:</span>

<span class="sd">    &gt;&gt;&gt; # [1] FCHK file for DFT calculation</span>
<span class="sd">    &gt;&gt;&gt; E, wfn = energy(&#39;b3lyp&#39;, return_wfn=True)</span>
<span class="sd">    &gt;&gt;&gt; fchk(wfn, &#39;mycalc.fchk&#39;)</span>

<span class="sd">    &gt;&gt;&gt; # [2] FCHK file for correlated densities</span>
<span class="sd">    &gt;&gt;&gt; E, wfn = gradient(&#39;ccsd&#39;, return_wfn=True)</span>
<span class="sd">    &gt;&gt;&gt; fchk(wfn, &#39;mycalc.fchk&#39;)</span>

<span class="sd">    &gt;&gt;&gt; # [2] Write FCHK file with non-standard label.</span>
<span class="sd">    &gt;&gt;&gt; E, wfn = gradient(&#39;mp2.5&#39;, return_wfn=True)</span>
<span class="sd">    &gt;&gt;&gt; fchk(wfn, &#39;mycalc.fchk&#39;, strict_label=False)</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># * Known limitations and notes *</span>
    <span class="c1">#</span>
    <span class="c1"># OCC: (occ theory module only, not dfocc) is turned off as densities are not correctly set.</span>
    <span class="c1"># DFMP2: Contains natural orbitals in wfn.C() and wfn.epsilon() data. This is fixed to contain respective HF data.</span>

    <span class="n">allowed</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;DFMP2&#39;</span><span class="p">,</span> <span class="s1">&#39;SCF&#39;</span><span class="p">,</span> <span class="s1">&#39;CCENERGY&#39;</span><span class="p">,</span> <span class="s1">&#39;DCT&#39;</span><span class="p">,</span> <span class="s1">&#39;DFOCC&#39;</span><span class="p">]</span>
    <span class="n">module_</span> <span class="o">=</span> <span class="n">wfn</span><span class="o">.</span><span class="n">module</span><span class="p">()</span><span class="o">.</span><span class="n">upper</span><span class="p">()</span>
    <span class="k">if</span> <span class="n">module_</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">allowed</span><span class="p">:</span>
        <span class="n">core</span><span class="o">.</span><span class="n">print_out</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;FCHKWriter: Theory module </span><span class="si">{</span><span class="n">module_</span><span class="si">}</span><span class="s2"> is currently not supported by the FCHK writer.&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="kc">None</span>

    <span class="k">if</span> <span class="p">(</span><span class="n">wfn</span><span class="o">.</span><span class="n">basisset</span><span class="p">()</span><span class="o">.</span><span class="n">has_ECP</span><span class="p">()):</span>
        <span class="n">core</span><span class="o">.</span><span class="n">print_out</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;FCHKWriter: Limited ECP support! No ECP data will be written to the FCHK file.&quot;</span><span class="p">)</span>

    <span class="c1"># fix orbital coefficients and energies for DFMP2</span>
    <span class="k">if</span> <span class="n">module_</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;DFMP2&#39;</span><span class="p">]:</span>
        <span class="n">wfn_</span> <span class="o">=</span> <span class="n">core</span><span class="o">.</span><span class="n">Wavefunction</span><span class="o">.</span><span class="n">build</span><span class="p">(</span><span class="n">wfn</span><span class="o">.</span><span class="n">molecule</span><span class="p">(),</span> <span class="n">core</span><span class="o">.</span><span class="n">get_global_option</span><span class="p">(</span><span class="s1">&#39;BASIS&#39;</span><span class="p">))</span>
        <span class="n">wfn_</span><span class="o">.</span><span class="n">deep_copy</span><span class="p">(</span><span class="n">wfn</span><span class="p">)</span>
        <span class="n">refwfn</span> <span class="o">=</span> <span class="n">wfn</span><span class="o">.</span><span class="n">reference_wavefunction</span><span class="p">()</span>
        <span class="n">wfn_</span><span class="o">.</span><span class="n">set_reference_wavefunction</span><span class="p">(</span><span class="n">refwfn</span><span class="p">)</span>  <span class="c1"># refwfn not deep_copied</span>
        <span class="n">wfn_</span><span class="o">.</span><span class="n">Ca</span><span class="p">()</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="n">refwfn</span><span class="o">.</span><span class="n">Ca</span><span class="p">())</span>
        <span class="n">wfn_</span><span class="o">.</span><span class="n">Cb</span><span class="p">()</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="n">refwfn</span><span class="o">.</span><span class="n">Cb</span><span class="p">())</span>
        <span class="n">wfn_</span><span class="o">.</span><span class="n">epsilon_a</span><span class="p">()</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="n">refwfn</span><span class="o">.</span><span class="n">epsilon_a</span><span class="p">())</span>
        <span class="n">wfn_</span><span class="o">.</span><span class="n">epsilon_b</span><span class="p">()</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="n">refwfn</span><span class="o">.</span><span class="n">epsilon_b</span><span class="p">())</span>
        <span class="n">fw</span> <span class="o">=</span> <span class="n">core</span><span class="o">.</span><span class="n">FCHKWriter</span><span class="p">(</span><span class="n">wfn_</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">fw</span> <span class="o">=</span> <span class="n">core</span><span class="o">.</span><span class="n">FCHKWriter</span><span class="p">(</span><span class="n">wfn</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">module_</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;DCT&#39;</span><span class="p">,</span> <span class="s1">&#39;DFOCC&#39;</span><span class="p">]:</span>
        <span class="n">core</span><span class="o">.</span><span class="n">print_out</span><span class="p">(</span><span class="s2">&quot;&quot;&quot;FCHKWriter: Caution! For orbital-optimized correlated methods</span>
<span class="s2">            the &#39;Orbital Energy&#39; field contains ambiguous data. </span><span class="se">\n</span><span class="s2">&quot;&quot;&quot;</span><span class="p">)</span>

    <span class="c1"># At this point we don&#39;t know the method name, so we try to search for it.</span>
    <span class="c1"># idea: get the method from the variable matching closely the &#39;current energy&#39;</span>
    <span class="c1"># for varlist, wfn is long-term and to allow from-file wfns. core is b/c some modules not storing in wfn yet</span>
    <span class="n">varlist</span> <span class="o">=</span> <span class="p">{</span><span class="o">**</span><span class="n">wfn</span><span class="o">.</span><span class="n">scalar_variables</span><span class="p">(),</span> <span class="o">**</span><span class="n">core</span><span class="o">.</span><span class="n">scalar_variables</span><span class="p">()}</span>
    <span class="n">current</span> <span class="o">=</span> <span class="n">varlist</span><span class="p">[</span><span class="s1">&#39;CURRENT ENERGY&#39;</span><span class="p">]</span>

    <span class="c1"># delete problematic entries</span>
    <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;CURRENT ENERGY&#39;</span><span class="p">,</span> <span class="s1">&#39;CURRENT REFERENCE ENERGY&#39;</span><span class="p">]:</span>
        <span class="n">varlist</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>

    <span class="c1"># find closest matching energy</span>
    <span class="k">for</span> <span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="n">val</span><span class="p">)</span> <span class="ow">in</span> <span class="n">varlist</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">isclose</span><span class="p">(</span><span class="n">val</span><span class="p">,</span> <span class="n">current</span><span class="p">,</span> <span class="mf">1e-12</span><span class="p">)):</span>
            <span class="n">method</span> <span class="o">=</span> <span class="n">key</span><span class="o">.</span><span class="n">split</span><span class="p">()[</span><span class="mi">0</span><span class="p">]</span>
            <span class="k">break</span>

    <span class="c1"># The &#39;official&#39; list of labels for compatibility.</span>
    <span class="c1"># OMP2,MP2.5,OCCD, etc get reduced to MP2,CC.</span>
    <span class="n">allowed_labels</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s2">&quot;HF&quot;</span><span class="p">:</span> <span class="s2">&quot; SCF Density&quot;</span><span class="p">,</span>
        <span class="s2">&quot;SCF&quot;</span><span class="p">:</span> <span class="s2">&quot; SCF Density&quot;</span><span class="p">,</span>
        <span class="s2">&quot;DFT&quot;</span><span class="p">:</span> <span class="s2">&quot; SCF Density&quot;</span><span class="p">,</span>
        <span class="s2">&quot;MP2&quot;</span><span class="p">:</span> <span class="s2">&quot; MP2 Density&quot;</span><span class="p">,</span>
        <span class="s2">&quot;MP3&quot;</span><span class="p">:</span> <span class="s2">&quot; MP3 Density&quot;</span><span class="p">,</span>
        <span class="s2">&quot;MP4&quot;</span><span class="p">:</span> <span class="s2">&quot; MP4 Density&quot;</span><span class="p">,</span>
        <span class="s2">&quot;CI&quot;</span><span class="p">:</span> <span class="s2">&quot; CI Density&quot;</span><span class="p">,</span>
        <span class="s2">&quot;CC&quot;</span><span class="p">:</span> <span class="s2">&quot; CC Density&quot;</span><span class="p">,</span>
    <span class="p">}</span>
    <span class="c1"># assign label from method name</span>
    <span class="n">fchk_label</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot; </span><span class="si">{</span><span class="n">method</span><span class="si">}</span><span class="s2"> Density&quot;</span>
    <span class="k">if</span> <span class="n">strict_label</span><span class="p">:</span>
        <span class="n">in_list</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">allowed_labels</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">method</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">key</span> <span class="ow">is</span> <span class="ow">not</span> <span class="n">method</span><span class="p">:</span>
                    <span class="n">core</span><span class="o">.</span><span class="n">print_out</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;FCHKWriter: !WARNING! method &#39;</span><span class="si">{</span><span class="n">method</span><span class="si">}</span><span class="s2">&#39;&#39; renamed to label &#39;</span><span class="si">{</span><span class="n">key</span><span class="si">}</span><span class="s2">&#39;.</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
                <span class="n">fchk_label</span> <span class="o">=</span> <span class="n">allowed_labels</span><span class="p">[</span><span class="n">key</span><span class="p">]</span>
                <span class="n">in_list</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">in_list</span><span class="p">:</span>
            <span class="n">core</span><span class="o">.</span><span class="n">print_out</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;FCHKWriter: !WARNING! </span><span class="si">{</span><span class="n">method</span><span class="si">}</span><span class="s2"> is not recognized. Using non-standard label.</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="n">core</span><span class="o">.</span><span class="n">print_out</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;FCHKWriter: Writing </span><span class="si">{</span><span class="n">filename</span><span class="si">}</span><span class="s2"> with label &#39;</span><span class="si">{</span><span class="n">fchk_label</span><span class="si">}</span><span class="s2">&#39;.</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="n">fw</span><span class="o">.</span><span class="n">set_postscf_density_label</span><span class="p">(</span><span class="n">fchk_label</span><span class="p">)</span>

    <span class="n">fw</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">filename</span><span class="p">)</span>
    <span class="c1"># needed for the pytest. The SCF density below follows PSI4 ordering not FCHK ordering.</span>
    <span class="k">if</span> <span class="n">debug</span><span class="p">:</span>
        <span class="n">ret</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s2">&quot;filename&quot;</span><span class="p">:</span> <span class="n">filename</span><span class="p">,</span>
            <span class="s2">&quot;detected energy&quot;</span><span class="p">:</span> <span class="n">method</span><span class="p">,</span>
            <span class="s2">&quot;selected label&quot;</span><span class="p">:</span> <span class="n">fchk_label</span><span class="p">,</span>
            <span class="s2">&quot;Total SCF Density&quot;</span><span class="p">:</span> <span class="n">fw</span><span class="o">.</span><span class="n">SCF_Dtot</span><span class="p">()</span><span class="o">.</span><span class="n">np</span><span class="p">,</span>
        <span class="p">}</span>
        <span class="k">return</span> <span class="n">ret</span>
    <span class="k">return</span> <span class="kc">None</span></div>

<div class="viewcode-block" id="molden"><a class="viewcode-back" href="../../../molden.html#psi4.driver.molden">[docs]</a><span class="k">def</span> <span class="nf">molden</span><span class="p">(</span><span class="n">wfn</span><span class="p">,</span> <span class="n">filename</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">density_a</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">density_b</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">dovirtual</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Function to write wavefunction information in *wfn* to *filename* in</span>
<span class="sd">    molden format. Will write natural orbitals from *density* (MO basis) if supplied.</span>
<span class="sd">    Warning! Most post-SCF Wavefunctions do not build the density as this is often</span>
<span class="sd">    much more costly than the energy. In addition, the Wavefunction density attributes</span>
<span class="sd">    (Da and Db) return the SO density and must be transformed to the MO basis</span>
<span class="sd">    to use with this function.</span>

<span class="sd">    .. versionadded:: 0.5</span>
<span class="sd">       *wfn* parameter passed explicitly</span>

<span class="sd">    :returns: None</span>

<span class="sd">    :type wfn: :py:class:`~psi4.core.Wavefunction`</span>
<span class="sd">    :param wfn: set of molecule, basis, orbitals from which to generate cube files</span>

<span class="sd">    :type filename: str</span>
<span class="sd">    :param filename: destination file name for MOLDEN file (optional)</span>

<span class="sd">    :type density_a: :py:class:`~psi4.core.Matrix`</span>
<span class="sd">    :param density_a: density in the MO basis to build alpha NO&#39;s from (optional)</span>

<span class="sd">    :type density_b: :py:class:`~psi4.core.Matrix`</span>
<span class="sd">    :param density_b: density in the MO basis to build beta NO&#39;s from, assumes restricted if not supplied (optional)</span>

<span class="sd">    :type dovirtual: bool</span>
<span class="sd">    :param dovirtual: do write all the MOs to the MOLDEN file (true) or discard the unoccupied MOs, not valid for NO&#39;s (false) (optional)</span>

<span class="sd">    :examples:</span>

<span class="sd">    1. Molden file with the Kohn-Sham orbitals of a DFT calculation.</span>

<span class="sd">       &gt;&gt;&gt; E, wfn = energy(&#39;b3lyp&#39;, return_wfn=True)</span>
<span class="sd">       &gt;&gt;&gt; molden(wfn, &#39;mycalc.molden&#39;)</span>

<span class="sd">    2. Molden file for CI/MCSCF computation using NO roots.</span>
<span class="sd">       Any method returning a ``CIWavefunction`` object will work: ``detci``,</span>
<span class="sd">       ``fci``, ``casscf``, etc. The first two arguments of ``get_opdm`` can be</span>
<span class="sd">       set to ``n, n`` where n =&gt; 0 selects the root to write out, provided</span>
<span class="sd">       these roots were computed, see :term:`NUM_ROOTS &lt;NUM_ROOTS (DETCI)&gt;`. The</span>
<span class="sd">       third argument controls the spin (``&quot;A&quot;``, ``&quot;B&quot;`` or ``&quot;SUM&quot;``) and the final</span>
<span class="sd">       boolean option determines whether inactive orbitals are included.</span>

<span class="sd">       &gt;&gt;&gt; E, wfn = energy(&#39;detci&#39;, return_wfn=True)</span>
<span class="sd">       &gt;&gt;&gt; molden(wfn, &#39;no_root1.molden&#39;, density_a=wfn.get_opdm(0, 0, &quot;A&quot;, True))</span>

<span class="sd">    3. The following produces **an INCORRECT Molden file**, because the</span>
<span class="sd">       ``molden`` function needs orbitals in the MO basis (which are internally</span>
<span class="sd">       converted and written to the Molden file in the AO basis). The correct</span>
<span class="sd">       usage is given in the next point.</span>

<span class="sd">       &gt;&gt;&gt; E, wfn = energy(&#39;ccsd&#39;, return_wfn=True)</span>
<span class="sd">       &gt;&gt;&gt; molden(wfn, &#39;ccsd_no.molden&#39;, density_a=wfn.Da())</span>

<span class="sd">    4. Molden file with the natural orbitals of the ground-state 1RDM of a</span>
<span class="sd">       Post-HF calculation. Note the required transformation of Da (SO-&gt;MO).</span>

<span class="sd">       &gt;&gt;&gt; E, wfn = properties(&#39;ccsd&#39;, return_wfn=True)</span>
<span class="sd">       &gt;&gt;&gt; Da_so = wfn.Da()</span>
<span class="sd">       &gt;&gt;&gt; SCa = core.doublet(wfn.S(), wfn.Ca(), False, False)</span>
<span class="sd">       &gt;&gt;&gt; Da_mo = core.triplet(SCa, Da_so, SCa, True, False, False)</span>
<span class="sd">       &gt;&gt;&gt; molden(wfn, &#39;ccsd_no.molden&#39;, density_a=Da_mo)</span>

<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">if</span> <span class="n">filename</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">filename</span> <span class="o">=</span> <span class="n">core</span><span class="o">.</span><span class="n">get_writer_file_prefix</span><span class="p">(</span><span class="n">wfn</span><span class="o">.</span><span class="n">molecule</span><span class="p">()</span><span class="o">.</span><span class="n">name</span><span class="p">())</span> <span class="o">+</span> <span class="s2">&quot;.molden&quot;</span>

    <span class="k">if</span> <span class="n">dovirtual</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">dovirt</span> <span class="o">=</span> <span class="nb">bool</span><span class="p">(</span><span class="n">core</span><span class="o">.</span><span class="n">get_option</span><span class="p">(</span><span class="s2">&quot;SCF&quot;</span><span class="p">,</span> <span class="s2">&quot;MOLDEN_WITH_VIRTUAL&quot;</span><span class="p">))</span>

    <span class="k">else</span><span class="p">:</span>
        <span class="n">dovirt</span> <span class="o">=</span> <span class="n">dovirtual</span>

    <span class="k">if</span> <span class="n">density_a</span><span class="p">:</span>
        <span class="n">nmopi</span> <span class="o">=</span> <span class="n">wfn</span><span class="o">.</span><span class="n">nmopi</span><span class="p">()</span>
        <span class="n">nsopi</span> <span class="o">=</span> <span class="n">wfn</span><span class="o">.</span><span class="n">nsopi</span><span class="p">()</span>

        <span class="n">NO_Ra</span> <span class="o">=</span> <span class="n">core</span><span class="o">.</span><span class="n">Matrix</span><span class="p">(</span><span class="s2">&quot;NO Alpha Rotation Matrix&quot;</span><span class="p">,</span> <span class="n">nmopi</span><span class="p">,</span> <span class="n">nmopi</span><span class="p">)</span>
        <span class="n">NO_occa</span> <span class="o">=</span> <span class="n">core</span><span class="o">.</span><span class="n">Vector</span><span class="p">(</span><span class="n">nmopi</span><span class="p">)</span>
        <span class="n">density_a</span><span class="o">.</span><span class="n">diagonalize</span><span class="p">(</span><span class="n">NO_Ra</span><span class="p">,</span> <span class="n">NO_occa</span><span class="p">,</span> <span class="n">core</span><span class="o">.</span><span class="n">DiagonalizeOrder</span><span class="o">.</span><span class="n">Descending</span><span class="p">)</span>
        <span class="n">NO_Ca</span> <span class="o">=</span> <span class="n">core</span><span class="o">.</span><span class="n">Matrix</span><span class="p">(</span><span class="s2">&quot;Ca Natural Orbitals&quot;</span><span class="p">,</span> <span class="n">nsopi</span><span class="p">,</span> <span class="n">nmopi</span><span class="p">)</span>
        <span class="n">NO_Ca</span><span class="o">.</span><span class="n">gemm</span><span class="p">(</span><span class="kc">False</span><span class="p">,</span> <span class="kc">False</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">,</span> <span class="n">wfn</span><span class="o">.</span><span class="n">Ca</span><span class="p">(),</span> <span class="n">NO_Ra</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">density_b</span><span class="p">:</span>
            <span class="n">NO_Rb</span> <span class="o">=</span> <span class="n">core</span><span class="o">.</span><span class="n">Matrix</span><span class="p">(</span><span class="s2">&quot;NO Beta Rotation Matrix&quot;</span><span class="p">,</span> <span class="n">nmopi</span><span class="p">,</span> <span class="n">nmopi</span><span class="p">)</span>
            <span class="n">NO_occb</span> <span class="o">=</span> <span class="n">core</span><span class="o">.</span><span class="n">Vector</span><span class="p">(</span><span class="n">nmopi</span><span class="p">)</span>
            <span class="n">density_b</span><span class="o">.</span><span class="n">diagonalize</span><span class="p">(</span><span class="n">NO_Rb</span><span class="p">,</span> <span class="n">NO_occb</span><span class="p">,</span> <span class="n">core</span><span class="o">.</span><span class="n">DiagonalizeOrder</span><span class="o">.</span><span class="n">Descending</span><span class="p">)</span>
            <span class="n">NO_Cb</span> <span class="o">=</span> <span class="n">core</span><span class="o">.</span><span class="n">Matrix</span><span class="p">(</span><span class="s2">&quot;Cb Natural Orbitals&quot;</span><span class="p">,</span> <span class="n">nsopi</span><span class="p">,</span> <span class="n">nmopi</span><span class="p">)</span>
            <span class="n">NO_Cb</span><span class="o">.</span><span class="n">gemm</span><span class="p">(</span><span class="kc">False</span><span class="p">,</span> <span class="kc">False</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">,</span> <span class="n">wfn</span><span class="o">.</span><span class="n">Cb</span><span class="p">(),</span> <span class="n">NO_Rb</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>

        <span class="k">else</span><span class="p">:</span>
            <span class="n">NO_occb</span> <span class="o">=</span> <span class="n">NO_occa</span>
            <span class="n">NO_Cb</span> <span class="o">=</span> <span class="n">NO_Ca</span>

        <span class="n">mw</span> <span class="o">=</span> <span class="n">core</span><span class="o">.</span><span class="n">MoldenWriter</span><span class="p">(</span><span class="n">wfn</span><span class="p">)</span>
        <span class="n">mw</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="n">NO_Ca</span><span class="p">,</span> <span class="n">NO_Cb</span><span class="p">,</span> <span class="n">NO_occa</span><span class="p">,</span> <span class="n">NO_occb</span><span class="p">,</span> <span class="n">NO_occa</span><span class="p">,</span> <span class="n">NO_occb</span><span class="p">,</span> <span class="n">dovirt</span><span class="p">)</span>

    <span class="k">else</span><span class="p">:</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">occa</span> <span class="o">=</span> <span class="n">wfn</span><span class="o">.</span><span class="n">occupation_a</span><span class="p">()</span>
            <span class="n">occb</span> <span class="o">=</span> <span class="n">wfn</span><span class="o">.</span><span class="n">occupation_b</span><span class="p">()</span>
        <span class="k">except</span> <span class="ne">AttributeError</span><span class="p">:</span>
            <span class="n">core</span><span class="o">.</span><span class="n">print_out</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">!Molden warning: This wavefunction does not have occupation numbers.</span><span class="se">\n</span><span class="s2">&quot;</span>
                           <span class="s2">&quot;Writing zero&#39;s for occupation numbers</span><span class="se">\n\n</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="n">occa</span> <span class="o">=</span> <span class="n">core</span><span class="o">.</span><span class="n">Vector</span><span class="p">(</span><span class="n">wfn</span><span class="o">.</span><span class="n">nmopi</span><span class="p">())</span>
            <span class="n">occb</span> <span class="o">=</span> <span class="n">core</span><span class="o">.</span><span class="n">Vector</span><span class="p">(</span><span class="n">wfn</span><span class="o">.</span><span class="n">nmopi</span><span class="p">())</span>

        <span class="n">mw</span> <span class="o">=</span> <span class="n">core</span><span class="o">.</span><span class="n">MoldenWriter</span><span class="p">(</span><span class="n">wfn</span><span class="p">)</span>
        <span class="n">mw</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="n">wfn</span><span class="o">.</span><span class="n">Ca</span><span class="p">(),</span> <span class="n">wfn</span><span class="o">.</span><span class="n">Cb</span><span class="p">(),</span> <span class="n">wfn</span><span class="o">.</span><span class="n">epsilon_a</span><span class="p">(),</span> <span class="n">wfn</span><span class="o">.</span><span class="n">epsilon_b</span><span class="p">(),</span> <span class="n">occa</span><span class="p">,</span> <span class="n">occb</span><span class="p">,</span> <span class="n">dovirt</span><span class="p">)</span></div>

<div class="viewcode-block" id="tdscf"><a class="viewcode-back" href="../../../api/psi4.driver.tdscf.html#psi4.driver.tdscf">[docs]</a><span class="k">def</span> <span class="nf">tdscf</span><span class="p">(</span><span class="n">wfn</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">proc</span><span class="o">.</span><span class="n">run_tdscf_excitations</span><span class="p">(</span><span class="n">wfn</span><span class="p">,</span><span class="o">**</span><span class="n">kwargs</span><span class="p">)</span></div>


<span class="c1"># Aliases</span>
<span class="n">opt</span> <span class="o">=</span> <span class="n">optimize</span>
<span class="n">freq</span> <span class="o">=</span> <span class="n">frequency</span>
<span class="n">frequencies</span> <span class="o">=</span> <span class="n">frequency</span>
<span class="n">prop</span> <span class="o">=</span> <span class="n">properties</span>
</pre></div>

            <div class="clearer"></div>
          </div>
        </div>
      </div>
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper"><!-- 
#
# @BEGIN LICENSE
#
# Psi4: an open-source quantum chemistry software package
#
# Copyright (c) 2007-2017 The Psi4 Developers.
#
# The copyrights for code used from other parties are included in
# the corresponding files.
#
# This file is part of Psi4.
#
# Psi4 is free software; you can redistribute it and/or modify
# it under the terms of the GNU Lesser General Public License as published by
# the Free Software Foundation, version 3.
#
# Psi4 is distributed in the hope that it will be useful,
# but WITHOUT ANY WARRANTY; without even the implied warranty of
# MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
# GNU Lesser General Public License for more details.
#
# You should have received a copy of the GNU Lesser General Public License along
# with Psi4; if not, write to the Free Software Foundation, Inc.,
# 51 Franklin Street, Fifth Floor, Boston, MA 02110-1301 USA.
#
# @END LICENSE
# -->


<div id="searchbox" style="display: none" role="search">
  <!--<h3>Quick search</h3>-->
    <form class="search" action="../../../search.html" method="get">
      <!--<div><input type="text" name="q" placeholder="search docs" /></div>-->
      <div><input type="text" name="q" placeholder="&#xF002;" style="font-family:FontAwesome, Ariel" /></div>
      <!--<div><input type="submit" value="Go" /></div>-->
      <input type="hidden" name="check_keywords" value="yes" />
      <input type="hidden" name="area" value="default" />
    </form>
</div>
<script type="text/javascript">$('#searchbox').show(0);</script>
        </div>
      </div>
    
    
        <div class="sidebar-toggle-group no-js">
            
            <button class="sidebar-toggle" id="sidebar-hide" title="Hide the sidebar menu">
                 
                <span class="show-for-small">hide menu</span>
                
            </button>
            <button class="sidebar-toggle" id="sidebar-show" title="Show the sidebar menu">
                
                <span class="show-for-small">menu</span>
                <span class="hide-for-small">sidebar</span>
                 
            </button>
        </div>
    
      <div class="clearer"></div>
    </div>
    <div class="relbar-bottom">
        
    <div class="related" role="navigation" aria-label="related navigation">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../../../genindex.html" title="General Index"
             >Index</a></li>
        <li class="right" >
          <a href="../../../py-modindex.html" title="Python Module Index"
             >modules</a> &nbsp; &nbsp;</li>
        <li class="right" >
          <a href="../../../index.html" title="Table Of Contents"
             ><i class="fa fa-book fa-lg"></i></a> &nbsp; &nbsp;</li>
    <li><a href="http://psicode.org/"><i class="fa fa-home fa-lg"></i></a></li>
    <li><a href="http://github.com/psi4/psi4"><i class="fa fa-github fa-lg"></i></a></li>
    <li><a href="http://forum.psicode.org"><i class="fa fa-comments-o fa-lg"></i></a></li>
    <li><a href="http://github.com/psi4/psi4/edit/master/doc/sphinxman/source/_modules/psi4/driver/driver.rst"><i class="fa fa-pencil fa-lg"></i></a></li>
    <li style="color: #1a4162">&nbsp;&middot;&nbsp;</li>
    <li><a href="http://github.com/psi4/psi4/tree/b0e621f">1.9a1.dev35</a></li>
    <li style="color: #1a4162">&nbsp;&middot;&nbsp;</li>
    <li class="nav-item nav-item-0"><a href="../../../index.html">
        <span style="font-family: Optima, sans-serif;">P<span style="font-size: 82%;">SI</span>4</span>
        </a><i class="fa fa-angle-double-right" style="color: #a2a7b3; text-shadow: none;"></i></li>

          <li class="nav-item nav-item-1"><a href="../../index.html" >Module code</a><i class="fa fa-angle-double-right" style="color: #a2a7b3; text-shadow: none;"></i></li>
        <li class="nav-item nav-item-this"><a href="">psi4.driver.driver</a></li> 
      </ul>
    </div>
    </div>

    <div class="footer" role="contentinfo">
    &#169; Copyright 2007-2023, The Psi4 Project.
      Last updated on Friday, 11 August 2023 05:05AM.
      Created using <a href="https://www.sphinx-doc.org/">Sphinx</a> 7.1.2.
    </div>
    <!-- cloud_sptheme 1.4 -->
  </body>
</html>