<!-- 
#
# @BEGIN LICENSE
#
# Psi4: an open-source quantum chemistry software package
#
# Copyright (c) 2007-2017 The Psi4 Developers.
#
# The copyrights for code used from other parties are included in
# the corresponding files.
#
# This file is part of Psi4.
#
# Psi4 is free software; you can redistribute it and/or modify
# it under the terms of the GNU Lesser General Public License as published by
# the Free Software Foundation, version 3.
#
# Psi4 is distributed in the hope that it will be useful,
# but WITHOUT ANY WARRANTY; without even the implied warranty of
# MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
# GNU Lesser General Public License for more details.
#
# You should have received a copy of the GNU Lesser General Public License along
# with Psi4; if not, write to the Free Software Foundation, Inc.,
# 51 Franklin Street, Fifth Floor, Boston, MA 02110-1301 USA.
#
# @END LICENSE
# -->






<!DOCTYPE html>

<html>
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" /><meta name="generator" content="Docutils 0.17.1: http://docutils.sourceforge.net/" />

    <title>Adding PSIthon Test Cases</title>
    <link rel="stylesheet" type="text/css" href="_static/pygments.css" />
    <link rel="stylesheet" type="text/css" href="_static/psi4.css" />
    <link rel="stylesheet" type="text/css" href="_static/graphviz.css" />
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/font-awesome/4.4.0/css/font-awesome.min.css" type="text/css" />
    <link rel="stylesheet" href="//fonts.googleapis.com/css?family=Noticia+Text|Open+Sans|Droid+Sans+Mono" type="text/css" />
    
    <script data-url_root="./" id="documentation_options" src="_static/documentation_options.js"></script>
    <script src="_static/jquery.js"></script>
    <script src="_static/underscore.js"></script>
    <script src="_static/doctools.js"></script>
    <script crossorigin="anonymous" integrity="sha256-Ae2Vz/4ePdIu6ZyI/5ZGsYnb+m0JlOmKPjt6XZ9JJkA=" src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.4/require.min.js"></script>
    <script async="async" src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
    <script>window.MathJax = {"tex": {"inlineMath": [["$", "$"], ["\\(", "\\)"]], "processEscapes": true}, "options": {"ignoreHtmlClass": "tex2jax_ignore|mathjax_ignore|document", "processHtmlClass": "tex2jax_process|mathjax_process|math|output_area"}}</script>

    
    
     
        <script src="_static/jquery.cookie.js"></script>
    

    
     
        <script src="_static/cloud.base.js"></script>
    

    
     
        <script src="_static/cloud.js"></script>
    

    <link rel="shortcut icon" href="_static/favicon-psi4.ico"/>
    <link rel="index" title="Index" href="genindex.html" />
    <link rel="search" title="Search" href="search.html" />
    <link rel="next" title="Debugging and Profiling" href="prog_debug_profile.html" />
    <link rel="prev" title="Integrals in PSI4" href="prog_integrals.html" /> 
        <meta name="viewport" content="width=device-width, initial-scale=1">
  </head><body>
    <div class="relbar-top">
        
    <div class="related" role="navigation" aria-label="related navigation">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="genindex.html" title="General Index"
             accesskey="I">Index</a></li>
        <li class="right" >
          <a href="py-modindex.html" title="Python Module Index"
             >modules</a> &nbsp; &nbsp;</li>
        <li class="right" >
          <a href="prog_debug_profile.html" title="Debugging and Profiling"
             accesskey="N"><i class="fa fa-long-arrow-right fa-lg"></i></a> &nbsp; &nbsp;</li>
        <li class="right" >
          <a href="prog_integrals.html" title="Integrals in PSI4"
             accesskey="P"><i class="fa fa-long-arrow-left fa-lg"></i></a> &nbsp; &nbsp;</li>
        <li class="right" >
          <a href="index.html" title="Table Of Contents"
             accesskey="C"><i class="fa fa-book fa-lg"></i></a> &nbsp; &nbsp;</li>
    <li><a href="http://psicode.org/"><i class="fa fa-home fa-lg"></i></a></li>
    <li><a href="http://github.com/psi4/psi4"><i class="fa fa-github fa-lg"></i></a></li>
    <li><a href="http://forum.psicode.org"><i class="fa fa-comments-o fa-lg"></i></a></li>
    <li><a href="http://github.com/psi4/psi4/edit/master/doc/sphinxman/source/add_tests.rst"><i class="fa fa-pencil fa-lg"></i></a></li>
    <li style="color: #1a4162">&nbsp;&middot;&nbsp;</li>
    <li><a href="http://github.com/psi4/psi4/tree/3fd2414">1.5a1.dev41</a></li>
    <li style="color: #1a4162">&nbsp;&middot;&nbsp;</li>
    <li class="nav-item nav-item-0"><a href="index.html">
        <span style="font-family: Optima, sans-serif;">P<span style="font-size: 82%;">SI</span>4</span>
        </a><i class="fa fa-angle-double-right" style="color: #a2a7b3; text-shadow: none;"></i></li>

        <li class="nav-item nav-item-this"><a href="">Adding PSIthon Test Cases</a></li> 
      </ul>
    </div>
    </div>
  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body" role="main">
            
  <section id="adding-psithon-test-cases">
<span id="faq-add-tests"></span><h1>Adding PSIthon Test Cases<a class="headerlink" href="#adding-psithon-test-cases" title="Permalink to this headline">¶</a></h1>
<p>To create a new test case, first make a folder in <a class="reference external" href="https://github.com/psi4/psi4/blob/master/tests">psi4/tests</a>. Use hyphens, not spaces or underscores, in the directory name. This directory will need two files. The first is <code class="docutils literal notranslate"><span class="pre">CMakeLists.txt</span></code>, which is necessary to add the test case to the suite. This file should have the following lines:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">include</span><span class="p">(</span><span class="n">TestingMacros</span><span class="p">)</span>

<span class="n">add_regression_test</span><span class="p">(</span><span class="n">directory_name</span> <span class="s2">&quot;psi;semicolon_separated-list-of-applicable-test-labels&quot;</span><span class="p">)</span>
</pre></div>
</div>
<p>The labels specify which groups of tests include the test case. The <code class="docutils literal notranslate"><span class="pre">psi</span></code> label should always be added, but the other labels are test-specific. The method tested should always be included, and this is often sufficient. If adding a test for an already existing module, the labels for other tests of the module will suggest other labels to add.</p>
<p>A test requiring over 15 minutes should be labeled <code class="docutils literal notranslate"><span class="pre">longtests</span></code>. A short test under 30 seconds used for general bug checking should be labeled <code class="docutils literal notranslate"><span class="pre">quicktests</span></code>. A test that confirms <span style="font-family: Optima, sans-serif; text-transform: none;">P<span style="font-size: 82%;">SI</span>4</span> is operational should be labeled <code class="docutils literal notranslate"><span class="pre">smoketests</span></code>.</p>
<p>The other necessary file is the input file itself, <code class="docutils literal notranslate"><span class="pre">input.dat</span></code>. The input file should be just a simple input file to run the test, with small additions.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="ch">#! RI-SCF cc-pVTZ energy of water, with Z-matrix input and cc-pVTZ-RI auxiliary basis.</span>
<span class="c1">#! Also a bit more to force a second line.</span>

<span class="n">nucenergy</span> <span class="o">=</span> <span class="mf">8.801466202085710</span>  <span class="c1">#TEST</span>
<span class="n">refenergy</span> <span class="o">=</span> <span class="o">-</span><span class="mf">76.05098402733282</span>  <span class="c1">#TEST</span>

<span class="n">molecule</span> <span class="n">h2o</span> <span class="p">{</span>
   <span class="n">symmetry</span> <span class="n">c1</span>
   <span class="n">O</span>
   <span class="n">H</span> <span class="mi">1</span> <span class="mf">1.0</span>
   <span class="n">H</span> <span class="mi">1</span> <span class="mf">1.0</span> <span class="mi">2</span> <span class="mf">104.5</span>
<span class="p">}</span>

<span class="nb">set</span> <span class="p">{</span>
   <span class="n">basis</span> <span class="n">cc</span><span class="o">-</span><span class="n">pVTZ</span>
   <span class="n">scf_type</span> <span class="n">df</span>
   <span class="n">df_basis_scf</span> <span class="n">cc</span><span class="o">-</span><span class="n">pVTZ</span><span class="o">-</span><span class="n">RI</span>
   <span class="n">e_convergence</span> <span class="mi">10</span>
<span class="p">}</span>

<span class="n">thisenergy</span> <span class="o">=</span> <span class="n">energy</span><span class="p">(</span><span class="s2">&quot;hf&quot;</span><span class="p">)</span>

<span class="n">compare_values</span><span class="p">(</span><span class="n">nucenergy</span><span class="p">,</span> <span class="n">h2o</span><span class="o">.</span><span class="n">nuclear_repulsion_energy</span><span class="p">(),</span> <span class="mi">9</span><span class="p">,</span> <span class="s2">&quot;Nuclear repulsion energy&quot;</span><span class="p">)</span>  <span class="c1">#TEST</span>
<span class="n">compare_values</span><span class="p">(</span><span class="n">refenergy</span><span class="p">,</span> <span class="n">thisenergy</span><span class="p">,</span> <span class="mi">9</span><span class="p">,</span> <span class="s2">&quot;Reference energy&quot;</span><span class="p">)</span>  <span class="c1">#TEST</span>
<span class="n">compare_values</span><span class="p">(</span><span class="n">refenergy</span><span class="p">,</span> <span class="n">get_variable</span><span class="p">(</span><span class="s1">&#39;scf total energy&#39;</span><span class="p">),</span> <span class="mi">9</span><span class="p">,</span> <span class="s2">&quot;Reference energy&quot;</span><span class="p">)</span>  <span class="c1">#TEST</span>
</pre></div>
</div>
<p>Of those small modifications, first, note the special comment at the top (starting with the <code class="docutils literal notranslate"><span class="pre">#!</span></code> comment marker). This should be descriptive since it is inlined into the manual (unless <code class="docutils literal notranslate"><span class="pre">!nosample</span></code> in the comment) as a sample input.</p>
<p>The reference values are assigned to variables for later use. The compare_values function (along with several relatives in <a class="reference external" href="https://github.com/psi4/psi4/blob/master/psi4/driver/p4util/testing.py">psi4/psi4/driver/p4util/testing.py</a> for comparing strings, matrices, etc.) checks that the computed values match these reference values to suitable precision. This function prints an error message and signals that the test failed to the make system, if the values don’t match. Any lines of the input associated with the validation process should be flagged with <code class="docutils literal notranslate"><span class="pre">#TEST</span></code> at the end of each line, so that they can be removed when copying from the tests to the samples directory.</p>
<p>Finally, add the directory name to the list of tests in <a class="reference external" href="https://github.com/psi4/psi4/blob/master/tests/CMakeLists.txt">psi4/tests/CMakeLists.txt</a>.</p>
<p>In preparing the test case, turn energy, density, amplitude, and
geometry convergence criteria to very tight levels, and use these
results for reference energies, reference geometries, reference cube
files, <em>etc.</em>. Then, either remove or relax the convergence settings,
if these are not a vital part of the test. In choosing the number of
digits for <code class="xref py py-func docutils literal notranslate"><span class="pre">compare_values()</span></code> and other compare_* functions,
select a number looser than the convergence set in the test or the
default convergence for the calculation type (energy, gradient, <em>etc.</em>).</p>
</section>
<section id="adding-psiapi-test-cases">
<span id="faq-add-psiapi-tests"></span><h1>Adding PsiAPI Test Cases<a class="headerlink" href="#adding-psiapi-test-cases" title="Permalink to this headline">¶</a></h1>
<p>Sometimes you want to add tests that check several variations of a
template job or that test error handling or that are PsiAPI rather than
PSIthon focused. In these cases, you’ll want to add to the second test
suite that lives at <a class="reference external" href="https://github.com/psi4/psi4/blob/master/tests/pytests">psi4/tests/pytests</a>. Presently, the “normal”
(everything in the <code class="docutils literal notranslate"><span class="pre">tests/</span></code> directory that isn’t in <code class="docutils literal notranslate"><span class="pre">tests/pytests/</span></code>)
are run through <strong class="program">ctest</strong>, while the pytests are run through <strong class="program">pytest</strong>. In
future, all will be run through Pytest, but the former will still be
run as PSIthon (<code class="docutils literal notranslate"><span class="pre">psi4</span> <span class="pre">input.dat</span></code>) while the latter will still be
run as PsiAPI (<code class="docutils literal notranslate"><span class="pre">import</span> <span class="pre">psi4</span></code>). In other words, in designing a test,
choose its mode based on whether PSIthon or PsiAPI suits it better and
whether it’s a simple model for users (probably PSIthon) or for expert
users (probably PsiAPI). Both will continue to work in future.</p>
<p>In developing a Pytest test, you probably want to edit it in place,
rather than running <strong class="program">make</strong> after each change. Easiest is from
&lt;objdir&gt;, run <code class="docutils literal notranslate"><span class="pre">pytest</span> <span class="pre">../tests/pytests</span></code>. Add any filters (<code class="docutils literal notranslate"><span class="pre">-k</span>
<span class="pre">test_name_fragment</span></code>) or parallelism (<code class="docutils literal notranslate"><span class="pre">-n</span> <span class="pre">&lt;N&gt;</span></code> if <code class="docutils literal notranslate"><span class="pre">pytest-xdist</span></code>
installed) or print test names (<code class="docutils literal notranslate"><span class="pre">-v</span></code>) or print warnings (<code class="docutils literal notranslate"><span class="pre">-rws</span></code>). To
see stdout output from an otherwise passing test, easiest to add <code class="docutils literal notranslate"><span class="pre">assert</span>
<span class="pre">0</span></code> at its end to trigger failure. An important point is that because
they’re PsiAPI, <code class="docutils literal notranslate"><span class="pre">import</span> <span class="pre">psi4</span></code> is happening, so the &lt;objdir&gt; <span style="font-family: Optima, sans-serif; text-transform: none;">P<span style="font-size: 82%;">SI</span>4</span>
module must be in <span class="target" id="index-0"></span><a class="reference internal" href="external.html#envvar-PYTHONPATH"><code class="xref std std-envvar docutils literal notranslate"><span class="pre">PYTHONPATH</span></code></a>. Also, any call to QCEngine is
using <code class="docutils literal notranslate"><span class="pre">which</span> <span class="pre">psi4</span></code>, so the &lt;objdir&gt; <span style="font-family: Optima, sans-serif; text-transform: none;">P<span style="font-size: 82%;">SI</span>4</span> executable must be in
<span class="target" id="index-1"></span><a class="reference internal" href="external.html#envvar-PATH"><code class="xref std std-envvar docutils literal notranslate"><span class="pre">PATH</span></code></a>. The easiest way to prepare your local environment is to
execute the printout of <code class="docutils literal notranslate"><span class="pre">&lt;objdir&gt;/stage/bin/psi4</span> <span class="pre">--psiapi</span></code>.</p>
<ul class="simple">
<li><p>Test must be in the <a class="reference external" href="https://github.com/psi4/psi4/blob/master/tests/pytests/">psi4/tests/pytests/</a> directory.</p></li>
<li><p>Test file name must start with <code class="docutils literal notranslate"><span class="pre">test_</span></code>. This is how pytest knows to collect it.</p></li>
<li><p>Test file may contain many tests. To be recognized as a test, the Python function must start with <code class="docutils literal notranslate"><span class="pre">test_</span></code>.</p></li>
<li><p>No registration required to bring a test to pytest’s attention.</p></li>
</ul>
<p>There are individual “marks” that can be added to whole tests or parts
of parameterized tests so that they can be run by category (<code class="docutils literal notranslate"><span class="pre">pytest</span> <span class="pre">-m</span>
<span class="pre">&lt;mark&gt;</span></code> vs. <code class="docutils literal notranslate"><span class="pre">ctest</span> <span class="pre">-L</span> <span class="pre">&lt;mark&gt;</span></code>) rather than just by name (<code class="docutils literal notranslate"><span class="pre">pytest</span> <span class="pre">-k</span>
<span class="pre">&lt;name_fragment&gt;</span></code> vs. <code class="docutils literal notranslate"><span class="pre">ctest</span> <span class="pre">-R</span> <span class="pre">&lt;name_fragment&gt;</span></code>). Most important are
“quick” and “long” that opt tests into the quick CI suite or out of
the normal full suite. Mark with a decorator for the full test or the
marks argument in a parameterized test. Search “mark” in the test suite
for examples. Use “quick” freely for tests that cover functionality and
are under 15s. Use “long” sparingly to winnow out the longest examples,
particularly those over a minute.</p>
</section>


            <div class="clearer"></div>
          </div>
        </div>
      </div>
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper">
        <p class="logo"><a href="index.html" title="index">
          <img class="logo" src="_static/psi4square.png" alt="Logo"/>
        </a></p><!-- 
#
# @BEGIN LICENSE
#
# Psi4: an open-source quantum chemistry software package
#
# Copyright (c) 2007-2017 The Psi4 Developers.
#
# The copyrights for code used from other parties are included in
# the corresponding files.
#
# This file is part of Psi4.
#
# Psi4 is free software; you can redistribute it and/or modify
# it under the terms of the GNU Lesser General Public License as published by
# the Free Software Foundation, version 3.
#
# Psi4 is distributed in the hope that it will be useful,
# but WITHOUT ANY WARRANTY; without even the implied warranty of
# MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
# GNU Lesser General Public License for more details.
#
# You should have received a copy of the GNU Lesser General Public License along
# with Psi4; if not, write to the Free Software Foundation, Inc.,
# 51 Franklin Street, Fifth Floor, Boston, MA 02110-1301 USA.
#
# @END LICENSE
# -->


<div id="searchbox" style="display: none" role="search">
  <!--<h3>Quick search</h3>-->
    <form class="search" action="search.html" method="get">
      <!--<div><input type="text" name="q" placeholder="search docs" /></div>-->
      <div><input type="text" name="q" placeholder="&#xF002;" style="font-family:FontAwesome, Ariel" /></div>
      <!--<div><input type="submit" value="Go" /></div>-->
      <input type="hidden" name="check_keywords" value="yes" />
      <input type="hidden" name="area" value="default" />
    </form>
</div>
<script type="text/javascript">$('#searchbox').show(0);</script><div class="sphinx-toc sphinxlocaltoc">
    <h3><a href="index.html">table of contents</a></h3>
    <ul>
<li><a class="reference internal" href="#">Adding PSIthon Test Cases</a></li>
<li><a class="reference internal" href="#adding-psiapi-test-cases">Adding PsiAPI Test Cases</a></li>
</ul>

  </div>
        </div>
      </div>
    
    
        <div class="sidebar-toggle-group no-js">
            
            <button class="sidebar-toggle" id="sidebar-hide" title="Hide the sidebar menu">
                 «
                <span class="show-for-small">hide menu</span>
                
            </button>
            <button class="sidebar-toggle" id="sidebar-show" title="Show the sidebar menu">
                
                <span class="show-for-small">menu</span>
                <span class="hide-for-small">sidebar</span>
                 »
            </button>
        </div>
    
      <div class="clearer"></div>
    </div>
    <div class="relbar-bottom">
        
    <div class="related" role="navigation" aria-label="related navigation">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="genindex.html" title="General Index"
             >Index</a></li>
        <li class="right" >
          <a href="py-modindex.html" title="Python Module Index"
             >modules</a> &nbsp; &nbsp;</li>
        <li class="right" >
          <a href="prog_debug_profile.html" title="Debugging and Profiling"
             ><i class="fa fa-long-arrow-right fa-lg"></i></a> &nbsp; &nbsp;</li>
        <li class="right" >
          <a href="prog_integrals.html" title="Integrals in PSI4"
             ><i class="fa fa-long-arrow-left fa-lg"></i></a> &nbsp; &nbsp;</li>
        <li class="right" >
          <a href="index.html" title="Table Of Contents"
             ><i class="fa fa-book fa-lg"></i></a> &nbsp; &nbsp;</li>
    <li><a href="http://psicode.org/"><i class="fa fa-home fa-lg"></i></a></li>
    <li><a href="http://github.com/psi4/psi4"><i class="fa fa-github fa-lg"></i></a></li>
    <li><a href="http://forum.psicode.org"><i class="fa fa-comments-o fa-lg"></i></a></li>
    <li><a href="http://github.com/psi4/psi4/edit/master/doc/sphinxman/source/add_tests.rst"><i class="fa fa-pencil fa-lg"></i></a></li>
    <li style="color: #1a4162">&nbsp;&middot;&nbsp;</li>
    <li><a href="http://github.com/psi4/psi4/tree/3fd2414">1.5a1.dev41</a></li>
    <li style="color: #1a4162">&nbsp;&middot;&nbsp;</li>
    <li class="nav-item nav-item-0"><a href="index.html">
        <span style="font-family: Optima, sans-serif;">P<span style="font-size: 82%;">SI</span>4</span>
        </a><i class="fa fa-angle-double-right" style="color: #a2a7b3; text-shadow: none;"></i></li>

        <li class="nav-item nav-item-this"><a href="">Adding PSIthon Test Cases</a></li> 
      </ul>
    </div>
    </div>

    <div class="footer" role="contentinfo">
        &#169; Copyright 2021, The Psi4 Project.
      Last updated on Monday, 30 August 2021 07:23PM.
      Created using <a href="https://www.sphinx-doc.org/">Sphinx</a> 4.1.2.
    </div>
    <!-- cloud_sptheme 1.4 -->
  </body>
</html>